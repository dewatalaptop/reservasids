<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Dolan Sawah - Layar Mudah</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    :root {
      /* Warna Tetap Sama (Tema Brand) tapi lebih kontras */
      --primary: #2a9d8f;       
      --primary-dark: #1d7c70;  
      --secondary: #e9c46a;     
      --danger: #d94524; /* Merah lebih gelap agar terbaca */       
      --dark: #111827;   /* Hampir hitam */
      --gray: #f3f4f6;
      --border: #d1d5db;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif; /* Font paling standar & jelas */
      background-color: #f9fafb;
      color: var(--dark);
      padding-bottom: 100px;
      font-size: 16px; /* Base font lebih besar */
    }

    /* HEADER BESAR & JELAS */
    .header-bar {
      background: var(--primary-dark);
      color: white;
      padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 1000;
    }
    .header-bar h1 { font-size: 1.2rem; font-weight: 700; margin: 0; }
    #clock { font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px;}

    /* KONTROL TANGGAL (TOMBOL FISIK BESAR) */
    .date-controls {
      background: white; padding: 15px; 
      border-bottom: 2px solid #e5e7eb;
      display: flex; gap: 10px; align-items: center;
    }
    
    .btn-date {
      flex: 1; /* Memenuhi layar */
      position: relative;
      background: white;
      border: 2px solid var(--primary);
      color: var(--primary-dark);
      padding: 12px;
      border-radius: 12px;
      font-size: 1rem; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05); /* Efek tombol timbul */
    }
    .btn-date input {
      position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
    }

    .btn-today {
      background: var(--secondary); border: 2px solid #d4a017;
      color: #5c4103; font-weight: 800;
      padding: 12px 20px; border-radius: 12px;
      cursor: pointer;
    }

    /* NAVIGASI TOMBOL KOTAK (GRID) - BUKAN SCROLL */
    .nav-grid {
      display: grid; 
      grid-template-columns: 1fr 1fr; /* 2 Kolom */
      gap: 10px;
      padding: 15px;
      background: white;
      border-bottom: 1px solid #eee;
    }

    .btn-big-nav {
      padding: 15px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      border-radius: 12px;
      font-size: 1rem; font-weight: 700; color: #6b7280;
      text-align: center;
      cursor: pointer;
      transition: all 0.1s;
    }
    .btn-big-nav.active {
      background: var(--primary);
      border-color: var(--primary-dark);
      color: white;
      box-shadow: 0 4px 6px rgba(42, 157, 143, 0.3);
      transform: translateY(-2px);
    }
    
    /* FILTER SHIFT (BARIS BAWAH) */
    .filter-bar {
      padding: 0 15px 15px 15px; background: white;
      display: flex; gap: 10px;
    }
    .btn-shift {
      flex: 1; padding: 10px;
      background: #fff; border: 2px solid #ddd; border-radius: 8px;
      font-weight: 600; color: #555; cursor: pointer;
    }
    .btn-shift.active {
      background: var(--dark); color: white; border-color: var(--dark);
    }

    /* CARD DESIGN YANG TEGAS */
    .content-area { padding: 15px; display: none; }
    .content-area.active { display: block; }

    /* Info Status Besar */
    .status-summary {
        background: #e0f2fe; border: 2px solid #bae6fd;
        padding: 15px; border-radius: 12px; margin-bottom: 20px;
        text-align: center; font-size: 1.1rem; color: #0369a1; font-weight: 700;
    }

    .card-list { display: grid; gap: 15px; }
    
    .big-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 0 rgba(0,0,0,0.05); /* Shadow kasar agar terlihat 'pop' */
    }

    /* Header Kartu: Jam Besar */
    .bc-header {
      padding: 15px;
      background: #f3f4f6;
      border-bottom: 2px solid #e5e7eb;
      display: flex; justify-content: space-between; align-items: center;
    }
    .bc-time { font-size: 1.8rem; font-weight: 800; color: var(--dark); }
    .bc-pax { font-size: 1.2rem; font-weight: 700; background: white; padding: 5px 12px; border-radius: 8px; border: 1px solid #ccc; }

    /* Timer Bar */
    .timer-bar {
      padding: 8px; text-align: center; font-weight: 700; font-size: 0.9rem; color: white;
    }
    .bg-green { background: #10b981; }
    .bg-yellow { background: #f59e0b; color: black; }
    .bg-red { background: #ef4444; }

    /* Isi Kartu */
    .bc-body { padding: 15px; }
    .bc-name { font-size: 1.4rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 5px; }
    .bc-loc { font-size: 1.1rem; color: #555; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 15px;}
    
    .bc-menu-box {
        background: #fffbeb; border: 2px solid #fde68a;
        padding: 12px; border-radius: 10px;
    }
    .bc-menu-item {
        display: flex; justify-content: space-between; align-items: flex-start;
        margin-bottom: 8px; border-bottom: 1px dashed #d1d5db; padding-bottom: 8px;
    }
    .bc-qty {
        background: black; color: white; font-size: 1rem; font-weight: 700;
        width: 30px; height: 30px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; margin-right: 10px;
    }
    .bc-menu-name { font-size: 1.1rem; font-weight: 600; flex: 1; }
    .bc-menu-detail { display: block; font-size: 0.9rem; color: #666; margin-top: 4px; font-weight: 400; font-style: italic;}

    /* DAPUR - LIST BESAR */
    .kitchen-item {
        background: white; border: 2px solid #e5e7eb;
        padding: 15px; margin-bottom: 10px; border-radius: 12px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .k-name { font-size: 1.1rem; font-weight: 700; }
    .k-count { 
        font-size: 1.5rem; font-weight: 800; color: var(--primary);
        background: #e0f2fe; padding: 5px 15px; border-radius: 8px;
    }

    /* MODAL POPUP */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 2000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
        background: white; width: 90%; max-width: 500px;
        padding: 25px; border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .btn-close {
        width: 100%; padding: 15px; background: var(--danger); color: white;
        border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; margin-top: 20px;
    }

    /* Loader */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:3000; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .spinner { width: 50px; height: 50px; border: 6px solid #f3f3f3; border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;}
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div><h3 style="color:#555;">Memuat Data...</h3></div>

  <header class="header-bar">
    <h1><i class="fas fa-leaf"></i> Dolan Sawah</h1>
    <div id="clock">12:00</div>
  </header>

  <div class="date-controls">
    <button class="btn-date">
      <i class="fas fa-calendar-alt fa-lg"></i> 
      <span id="dateDisplay">Pilih Tanggal</span>
      <input type="date" id="dateInput" onchange="handleDateSelect(this.value)">
    </button>
    <button class="btn-today" onclick="goToToday()">HARI INI</button>
  </div>

  <div class="nav-grid">
    <button class="btn-big-nav active" onclick="switchTab('floor')">
        <i class="fas fa-users fa-lg" style="display:block; margin-bottom:5px;"></i>
        LAYAR TAMU
    </button>
    <button class="btn-big-nav" onclick="switchTab('kitchen')">
        <i class="fas fa-utensils fa-lg" style="display:block; margin-bottom:5px;"></i>
        LAYAR DAPUR
    </button>
  </div>
  
  <div class="filter-bar">
    <button class="btn-shift active" id="btnAll" onclick="toggleFilter('all')">Semua Jam</button>
    <button class="btn-shift" id="btnPagi" onclick="toggleFilter('pagi')">Pagi</button>
    <button class="btn-shift" id="btnSiang" onclick="toggleFilter('siang')">Siang/Sore</button>
  </div>

  <div id="view-floor" class="content-area active">
    <div class="status-summary">
        Total: <span id="totalRes">0</span> Reservasi (<span id="totalPax">0</span> Orang)
    </div>
    <div class="card-list" id="floorContainer"></div>
  </div>

  <div id="view-kitchen" class="content-area">
    <h3 style="margin-bottom:15px; border-bottom:2px solid #ddd; padding-bottom:10px;">Menu Utama (Plating)</h3>
    <div id="kitchenMenuContainer"></div>
    
    <h3 style="margin-top:30px; margin-bottom:15px; border-bottom:2px solid #ddd; padding-bottom:10px;">
        Komponen Bahan <br><small style="font-weight:400; font-size:0.9rem; color:#666;">(Klik untuk lihat detail)</small>
    </h3>
    <div id="kitchenCompContainer"></div>
  </div>

  <div class="modal-overlay" id="detailModal">
      <div class="modal-box">
          <h2 id="modalTitle" style="margin-bottom:15px; color:var(--primary);">Detail</h2>
          <ul id="detailList" style="list-style:none; max-height:300px; overflow-y:auto;"></ul>
          <button class="btn-close" onclick="closeModal()">TUTUP</button>
      </div>
  </div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- VARIABLES ---
    let allReservations = [];
    let menuDetailsCache = {};
    let selectedDate = new Date();
    let currentFilter = 'all'; 
    let unsubscribe = null;
    let globalCompDetails = {};

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        }, 1000);
        // Timer Loop
        setInterval(updateUI, 60000); 

        await loadMenuDetails();
        updateDateDisplay();
        loadData(selectedDate);
    });

    async function loadMenuDetails() {
        try {
            const snap = await db.collection('menus').get();
            snap.forEach(doc => { menuDetailsCache[doc.id] = doc.data().details || []; });
        } catch(e) {}
    }

    function updateDateDisplay() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('dateDisplay').innerText = selectedDate.toLocaleDateString('id-ID', options);
        // Update input value agar sync
        const y = selectedDate.getFullYear();
        const m = String(selectedDate.getMonth()+1).padStart(2,'0');
        const d = String(selectedDate.getDate()).padStart(2,'0');
        document.getElementById('dateInput').value = `${y}-${m}-${d}`;
    }

    function loadData(dateObj) {
        document.getElementById('loader').style.display = 'flex';
        if (unsubscribe) unsubscribe();

        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth()+1).padStart(2,'0');
        const d = String(dateObj.getDate()).padStart(2,'0');
        const dateStr = `${y}-${m}-${d}`;

        unsubscribe = db.collection('reservations')
            .where('date', '==', dateStr)
            .onSnapshot(snap => {
                let temp = [];
                snap.forEach(doc => temp.push({id: doc.id, ...doc.data()}));
                allReservations = temp.sort((a,b) => a.jam.localeCompare(b.jam));
                renderUI();
                document.getElementById('loader').style.display = 'none';
            });
    }

    function renderUI() {
        // Filter Shift
        let filtered = allReservations;
        if (currentFilter === 'pagi') filtered = allReservations.filter(r => parseInt(r.jam) < 15);
        if (currentFilter === 'siang') filtered = allReservations.filter(r => parseInt(r.jam) >= 15);

        document.getElementById('totalRes').innerText = filtered.length;
        document.getElementById('totalPax').innerText = filtered.reduce((a,b) => a + parseInt(b.jumlah||0), 0);
        
        renderFloor(filtered);
        renderKitchen(filtered);
    }

    // --- TIMER LOGIC (SIMPLE & CLEAR) ---
    function getTimerInfo(jamReservasi) {
        const now = new Date();
        const isToday = selectedDate.toDateString() === now.toDateString();
        
        if (!isToday) return { text: "Bukan Hari Ini", colorClass: "bg-green" };

        const [h, m] = jamReservasi.split(':').map(Number);
        const resTime = new Date(); resTime.setHours(h, m, 0);
        const diffMins = Math.floor((resTime - now) / 60000);

        if (diffMins < 0) return { text: "TAMU SUDAH HADIR / TERLAMBAT", colorClass: "bg-red" };
        if (diffMins <= 30) return { text: `SEGERA! ${diffMins} MENIT LAGI`, colorClass: "bg-red" };
        if (diffMins <= 60) return { text: `PERSIAPAN (${diffMins} Menit)`, colorClass: "bg-yellow" };
        
        const jam = Math.floor(diffMins/60);
        const sisaMenit = diffMins%60;
        return { text: `Masih Lama (${jam} jam ${sisaMenit} mnt)`, colorClass: "bg-green" };
    }

    function renderFloor(data) {
        const container = document.getElementById('floorContainer');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#888;"><h3>Tidak ada data</h3></div>`;
            return;
        }

        data.forEach(r => {
            const timer = getTimerInfo(r.jam);

            let menuHtml = '';
            if (r.menus && r.menus.length) {
                menuHtml = r.menus.map(item => {
                    const details = menuDetailsCache[item.name] || [];
                    const detailString = details.length > 0 ? `<span class="bc-menu-detail">• ${details.join(', ')}</span>` : '';
                    return `<div class="bc-menu-item">
                        <div style="display:flex; align-items:flex-start; flex:1;">
                            <span class="bc-qty">${item.quantity}</span>
                            <div>
                                <span class="bc-menu-name">${item.name}</span>
                                ${detailString}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else if (r.menu) {
                const details = menuDetailsCache[r.menu] || [];
                const detailString = details.length > 0 ? `<span class="bc-menu-detail">• ${details.join(', ')}</span>` : '';
                menuHtml = `<div class="bc-menu-item"><div style="display:flex; flex:1;"><span class="bc-qty">1</span><div><span class="bc-menu-name">${r.menu}</span>${detailString}</div></div></div>`;
            }

            container.innerHTML += `
                <div class="big-card">
                    <div class="timer-bar ${timer.colorClass}">${timer.text}</div>
                    <div class="bc-header">
                        <span class="bc-time">${r.jam}</span>
                        <span class="bc-pax">${r.jumlah} Orang</span>
                    </div>
                    <div class="bc-body">
                        <div class="bc-name">${r.nama}</div>
                        <div class="bc-loc"><i class="fas fa-map-marker-alt"></i> ${r.tempat || '?'}</div>
                        <div class="bc-menu-box">${menuHtml || 'Belum ada menu'}</div>
                        ${r.tambahan ? `<div style="margin-top:15px; background:#ffe4e6; color:#9f1239; padding:10px; border-radius:8px; font-weight:bold;">⚠️ NOTE: ${r.tambahan}</div>` : ''}
                    </div>
                </div>`;
        });
    }

    function renderKitchen(data) {
        const menuAgg = {}; globalCompDetails = {}; 
        data.forEach(r => {
            const process = (name, qty) => {
                menuAgg[name] = (menuAgg[name] || 0) + qty;
                const details = menuDetailsCache[name];
                if (details) details.forEach(c => {
                    const clean = c.trim();
                    if(!globalCompDetails[clean]) globalCompDetails[clean] = {total:0, items:[]};
                    globalCompDetails[clean].total += qty;
                    globalCompDetails[clean].items.push({nama:r.nama, jam:r.jam, qty:qty});
                });
            };
            if(r.menus) r.menus.forEach(i => process(i.name, parseInt(i.quantity)));
            else if(r.menu) process(r.menu, 1);
        });

        // Render Menu
        const mCont = document.getElementById('kitchenMenuContainer'); mCont.innerHTML = '';
        Object.entries(menuAgg).sort((a,b)=>b[1]-a[1]).forEach(([n,c]) => {
            mCont.innerHTML += `<div class="kitchen-item"><span class="k-name">${n}</span><span class="k-count">${c}</span></div>`;
        });

        // Render Comp
        const cCont = document.getElementById('kitchenCompContainer'); cCont.innerHTML = '';
        Object.entries(globalCompDetails).sort((a,b)=>b[1].total-a[1].total).forEach(([n,d]) => {
            cCont.innerHTML += `
                <div class="kitchen-item" onclick="openDetail('${n}')" style="cursor:pointer; border-left:5px solid var(--secondary);">
                    <span class="k-name"><i class="fas fa-search-plus" style="color:var(--primary); margin-right:5px;"></i> ${n}</span>
                    <span class="k-count" style="background:var(--accent); color:white;">${d.total}</span>
                </div>`;
        });
    }

    function openDetail(name) {
        const data = globalCompDetails[name];
        document.getElementById('modalTitle').innerText = name;
        const list = document.getElementById('detailList'); list.innerHTML = '';
        data.items.sort((a,b)=>a.jam.localeCompare(b.jam)).forEach(i => {
            list.innerHTML += `<li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div><strong style="font-size:1.1rem;">${i.nama}</strong><br><span style="color:#666;">Jam: ${i.jam}</span></div>
                <div style="font-size:1.2rem; font-weight:800; color:var(--primary);">${i.qty}</div>
            </li>`;
        });
        document.getElementById('detailModal').classList.add('active');
    }
    function closeModal() { document.getElementById('detailModal').classList.remove('active'); }

    // Helpers
    function goToToday() { handleDateSelect(new Date().toISOString().split('T')[0]); }
    function handleDateSelect(val) { selectedDate = new Date(val); updateDateDisplay(); loadData(selectedDate); }
    function switchTab(tab) {
        document.querySelectorAll('.btn-big-nav').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
        if(tab==='floor') document.querySelectorAll('.btn-big-nav')[0].classList.add('active');
        if(tab==='kitchen') document.querySelectorAll('.btn-big-nav')[1].classList.add('active');
        document.getElementById('view-'+tab).classList.add('active');
    }
    function toggleFilter(type) {
        currentFilter = type;
        document.querySelectorAll('.btn-shift').forEach(b => b.classList.remove('active'));
        if(type==='all') document.getElementById('btnAll').classList.add('active');
        if(type==='pagi') document.getElementById('btnPagi').classList.add('active');
        if(type==='siang') document.getElementById('btnSiang').classList.add('active');
        renderUI();
    }
</script>
</body>
</html>
