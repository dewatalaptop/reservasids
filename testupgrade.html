<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Sistem Komando Dolan Sawah (Final Integrated)</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; --primary-dark: #264653; --secondary: #e9c46a; 
      --accent: #f4a261; --danger: #e76f51; --light: #f8f9fa; --dark: #343a40; 
      --success: #28a745; --whatsapp: #25D366; --info: #0077b6; --warning: #f1c40f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Poppins', sans-serif; background-color: #f5f5f5; color: var(--dark);
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover; background-attachment: fixed; min-height: 100vh;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.92); z-index: -1;
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; 
      padding: 15px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
      display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000;
    }
    .brand h2 { font-size: 1.4rem; margin: 0; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .brand small { display: block; font-size: 0.7rem; opacity: 0.9; font-weight: 400; }
    
    /* Notification */
    #notification-bell-container { position: relative; cursor: pointer; margin-right: 15px; }
    .notification-badge {
      position: absolute; top: -5px; right: -5px; background: var(--danger);
      color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem;
      display: flex; justify-content: center; align-items: center; border: 2px solid white;
    }
    .notification-list-dropdown {
      display: none; position: absolute; top: 40px; right: 0; width: 300px;
      background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000; max-height: 400px; overflow-y: auto;
    }
    .notification-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; }

    /* CONTAINER */
    .container { max-width: 1200px; margin: 20px auto; padding: 15px; background: rgba(255,255,255,0.95); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }

    /* BUTTONS */
    .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-family: inherit; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .btn-primary { background: var(--primary); }
    .btn-secondary { background: #6c757d; }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #333; }
    .btn-success { background: var(--success); }
    .btn-whatsapp { background: var(--whatsapp); }
    .btn-info { background: var(--info); }
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

    /* CALENDAR */
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .cal-day-header { text-align: center; font-weight: 700; color: #777; margin-bottom: 5px; font-size: 0.9rem; }
    .cal-day { 
      min-height: 90px; background: white; border-radius: 8px; padding: 5px; 
      position: relative; cursor: pointer; border: 2px solid transparent; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .cal-day:hover { transform: translateY(-3px); border-color: var(--primary); }
    .cal-day.today { background: #fffaf0; border-color: var(--secondary); }
    .cal-day.selected { background: var(--primary) !important; color: white; border-color: var(--primary-dark) !important; }
    .cal-day.selected .day-num { color: white; }
    .cal-day.selected .res-count { background: rgba(255,255,255,0.2); color: white; }
    
    /* Indikator FULL */
    .cal-day.is-full { background: #ffebee !important; border-color: var(--danger) !important; }
    .cal-day.is-full::after { 
        content: 'FULL'; position: absolute; top: 50%; left: 50%; 
        transform: translate(-50%, -50%) rotate(-15deg); 
        color: rgba(231, 76, 60, 0.3); font-weight: 900; font-size: 1.2rem; pointer-events: none;
    }

    .day-num { font-weight: 700; font-size: 1rem; color: #555; align-self: flex-end; }
    .res-count { font-size: 0.75rem; background: rgba(42, 157, 143, 0.1); color: var(--primary-dark); padding: 2px 6px; border-radius: 4px; font-weight: 600; }

    /* ACTION BUTTONS GRID */
    .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; }
    .action-grid .btn { width: 100%; justify-content: center; padding: 12px; flex-direction: column; gap: 5px; text-align: center;}
    .action-grid .btn i { font-size: 1.2rem; }

    /* POPUPS */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; display: none; backdrop-filter: blur(4px); }
    .popup { 
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
        background: white; z-index: 1501; padding: 25px; border-radius: 12px; 
        display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: zoomIn 0.2s;
    }
    @keyframes zoomIn { from {opacity:0; transform:translate(-50%,-45%);} to {opacity:1; transform:translate(-50%,-50%);} }
    
    .popup h3 { margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; font-size: 1.2rem; }
    
    /* INPUTS */
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px; font-family: inherit; font-size: 0.95rem; }
    label { display: block; margin-top: 12px; font-weight: 500; color: #555; font-size: 0.9rem; }
    
    /* INBOX REQUEST CARD */
    .req-card { background: white; border-left: 5px solid var(--warning); padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .req-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .req-menu { background: #fffcf5; padding: 8px; border-radius: 6px; font-size: 0.85rem; border: 1px dashed #e0d0a0; margin: 8px 0; }
    .req-actions { display: flex; gap: 5px; margin-top: 10px; }
    .req-actions button { flex: 1; justify-content: center; }

    /* RESERVATION LIST CARD */
    .res-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .res-info { display: flex; justify-content: space-between; margin-bottom: 5px; }
    
    /* LOGIN */
    #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 3000; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    
    /* LOADER */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 4000; display: none; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* MENU ROW */
    .menu-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
    .menu-row select { flex: 2; }
    .menu-row input { flex: 1; }
    
    /* ANALYSIS & PRINT */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
    .mini-stat { background: #f9f9f9; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
    .mini-stat .val { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div></div>

  <div id="login-page">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-bottom:10px;"><i class="fas fa-leaf"></i> Admin</h2>
        <p style="color:#666; margin-bottom:20px;">Dolan Sawah Management</p>
        <input type="email" id="loginEmail" placeholder="Email Admin">
        <input type="password" id="loginPassword" placeholder="Password">
        <button class="btn btn-primary" onclick="handleLogin()" style="width:100%; margin-top:20px; justify-content:center;">Masuk Dashboard</button>
        <p id="loginError" style="color:red; display:none; margin-top:10px; font-size:0.9rem;"></p>
    </div>
  </div>

  <div id="main-ui" style="display:none;">
      
      <header>
        <div class="brand">
            <h2><i class="fas fa-leaf"></i> Dolan Sawah</h2>
            <small>Integrated System</small>
        </div>
        <div class="header-right">
            <div style="position:relative; margin-right:15px; cursor:pointer;" onclick="openInbox()">
                <i class="fas fa-inbox" style="font-size:1.4rem;"></i>
                <span id="header-inbox-badge" style="position:absolute; top:-5px; right:-5px; background:var(--warning); color:#333; font-size:0.7rem; padding:2px 5px; border-radius:50%; display:none;">0</span>
            </div>

            <div id="notification-bell-container" onclick="toggleNotif()">
                <i class="fas fa-bell" style="font-size:1.4rem;"></i>
                <span id="notif-badge" class="notification-badge" style="display:none;">0</span>
            </div>
            
            <div class="notification-list-dropdown" id="notif-dropdown">
                <div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold; background:#f9f9f9;">Pengingat</div>
                <div id="notif-list"></div>
            </div>
            
            <button class="btn btn-danger btn-sm" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </header>

      <div class="container">
        <div class="calendar-header">
            <h2 id="monthYear" style="margin:0; color:var(--primary-dark); font-size:1.2rem;">...</h2>
            <div>
                <button class="btn btn-secondary btn-sm" onclick="moveMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="btn btn-primary btn-sm" onclick="goToToday()">Hari Ini</button>
                <button class="btn btn-secondary btn-sm" onclick="moveMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="calendar-grid">
            <div class="cal-day-header">Min</div><div class="cal-day-header">Sen</div><div class="cal-day-header">Sel</div>
            <div class="cal-day-header">Rab</div><div class="cal-day-header">Kam</div><div class="cal-day-header">Jum</div><div class="cal-day-header">Sab</div>
        </div>
        <div id="calendar-days" class="calendar-grid"></div>

        <div class="action-grid">
            <button class="btn btn-warning" onclick="openInbox()" style="grid-column: span 2;">
                <i class="fas fa-inbox"></i> Permintaan Masuk 
                <span id="dashboard-inbox-badge" style="background:red; color:white; padding:2px 6px; border-radius:10px; font-size:0.8rem; display:none;">0</span>
            </button>
            
            <button class="btn btn-danger" onclick="openSetFull()"><i class="fas fa-ban"></i> Set Tanggal Penuh</button>
            
            <button class="btn btn-primary" onclick="openAddForm()"><i class="fas fa-plus-circle"></i> Input Manual</button>
            <button class="btn btn-secondary" onclick="openCustomer()"><i class="fas fa-address-book"></i> Customer</button>
            <button class="btn btn-secondary" onclick="openMenu()"><i class="fas fa-utensils"></i> Kelola Menu</button>
            <button class="btn btn-secondary" onclick="openLocation()"><i class="fas fa-map-marker-alt"></i> Kelola Tempat</button>
            <button class="btn btn-info" onclick="openAnalysis()"><i class="fas fa-chart-pie"></i> Analisis</button>
            <button class="btn btn-whatsapp" onclick="openBroadcast()"><i class="fab fa-whatsapp"></i> Broadcast</button>
            <button class="btn btn-success" onclick="openExport()"><i class="fas fa-file-export"></i> Export Data</button>
        </div>
      </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div id="popup-inbox" class="popup" style="max-width:800px;">
      <h3><i class="fas fa-inbox"></i> Permintaan Masuk <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-inbox')">X</button></h3>
      <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; margin-bottom:15px; font-size:0.9rem;">
          <i class="fas fa-info-circle"></i> Permintaan ini dari Web Mandiri. Cek ketersediaan sebelum Terima.
      </div>
      <div id="inbox-list">Memuat...</div>
  </div>

  <div id="popup-full" class="popup" style="max-width:400px;">
      <h3><i class="fas fa-ban"></i> Blokir Tanggal <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-full')">X</button></h3>
      <label>Pilih Tanggal</label>
      <input type="date" id="blockDate">
      <div style="margin-top:20px; display:flex; gap:10px;">
          <button class="btn btn-danger" onclick="setFullStatus(true)" style="flex:1;">Set PENUH</button>
          <button class="btn btn-success" onclick="setFullStatus(false)" style="flex:1;">Set BUKA</button>
      </div>
  </div>

  <div id="popup-form" class="popup">
      <h3 id="form-title">Input Reservasi <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-form')">X</button></h3>
      <form id="res-form">
          <input type="hidden" id="edit-id">
          <label>Nama Pemesan</label><input type="text" id="inp-nama" required>
          <label>WhatsApp</label><input type="tel" id="inp-hp">
          <div style="display:flex; gap:10px;">
              <div style="flex:1;"><label>Tanggal</label><input type="date" id="inp-date" required></div>
              <div style="flex:1;"><label>Jam</label><input type="time" id="inp-jam" required></div>
              <div style="flex:1;"><label>Jml</label><input type="number" id="inp-jml" required></div>
          </div>
          <label>Tempat</label><select id="inp-tempat" onchange="checkCap()"></select>
          <div id="cap-info" style="font-size:0.8rem; color:#0077b6; margin-top:2px;"></div>
          
          <label>Menu Pesanan</label>
          <div id="menu-rows" style="background:#f9f9f9; padding:10px; border-radius:5px;"></div>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addMenuRow()" style="margin-top:5px;">+ Tambah Menu</button>
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1;"><label>DP (Rp)</label><input type="number" id="inp-dp" value="0"></div>
              <div style="flex:1;"><label>Via</label><select id="inp-via"><option>Cash</option><option>Transfer BCA</option><option>Transfer Mandiri</option><option>QRIS</option></select></div>
          </div>
          <label>Catatan</label><textarea id="inp-note"></textarea>
          <div style="margin-top:20px;">
              <button type="button" class="btn btn-primary" style="width:100%;" onclick="saveReservation()">Simpan Data</button>
          </div>
      </form>
  </div>

  <div id="popup-detail" class="popup" style="width:100%; height:100%; max-width:none; max-height:none; top:0; left:0; transform:none; border-radius:0; background:#f4f6f8;">
      <div style="max-width:1000px; margin:0 auto; background:white; min-height:100vh; padding:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--primary); padding-bottom:15px; margin-bottom:20px;">
              <h2 id="detail-title" style="margin:0; color:var(--primary-dark);">Detail</h2>
              <div style="display:flex; gap:10px;">
                  <button class="btn btn-whatsapp btn-sm" onclick="shareDay()"><i class="fab fa-whatsapp"></i> Share</button>
                  <button class="btn btn-secondary btn-sm" onclick="printDay()"><i class="fas fa-print"></i> Print</button>
                  <button class="btn btn-danger btn-sm" onclick="closePopup('popup-detail')">Tutup</button>
              </div>
          </div>
          <input type="text" placeholder="Cari tamu..." id="search-detail" oninput="filterDetail(this.value)">
          <div id="detail-list" style="margin-top:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:15px;"></div>
      </div>
  </div>

  <div id="popup-export" class="popup">
      <h3>Export Data <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-export')">X</button></h3>
      <p>Salin kode ini untuk Website Viewer:</p>
      <textarea id="export-area" readonly style="height:150px; font-family:monospace;"></textarea>
      <button class="btn btn-primary" onclick="copyExport()">Salin Kode</button>
  </div>

  <div id="popup-menu" class="popup"><h3>Kelola Menu <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-menu')">X</button></h3><div id="list-menu" style="max-height:300px; overflow:auto;"></div><hr><input id="new-menu-name" placeholder="Nama Menu"><input id="new-menu-price" type="number" placeholder="Harga"><textarea id="new-menu-det" placeholder="Detail"></textarea><button class="btn btn-primary" onclick="addMenu()" style="margin-top:10px;">Tambah</button></div>
  <div id="popup-loc" class="popup"><h3>Kelola Tempat <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-loc')">X</button></h3><div id="list-loc" style="max-height:300px; overflow:auto;"></div><hr><input id="new-loc-name" placeholder="Nama Tempat"><input id="new-loc-cap" type="number" placeholder="Kapasitas"><button class="btn btn-primary" onclick="addLoc()" style="margin-top:10px;">Tambah</button></div>
  
  <div id="popup-broadcast" class="popup">
      <h3>Broadcast <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-broadcast')">X</button></h3>
      <textarea id="bc-msg" placeholder="Tulis template pesan..." rows="5"></textarea>
      <button class="btn btn-info" onclick="saveBcMsg()">Simpan Template</button>
      <hr>
      <input type="text" placeholder="Cari..." oninput="filterBc(this.value)">
      <div id="bc-list" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
  </div>

  <div id="popup-customer" class="popup" style="max-width:800px;">
      <h3>Data Customer <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-customer')">X</button></h3>
      <input type="text" placeholder="Cari nama/HP..." oninput="filterCust(this.value)">
      <div id="cust-list" style="margin-top:10px; max-height:400px; overflow-y:auto;"></div>
  </div>

  <div id="popup-analysis" class="popup" style="max-width:900px;">
      <h3>Analisis Bisnis <button class="btn btn-sm btn-secondary" onclick="closePopup('popup-analysis')">X</button></h3>
      <canvas id="chart-anl" style="height:300px; width:100%;"></canvas>
      <div id="stats-anl" class="stats-grid"></div>
  </div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. GLOBAL VARS ---
    const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"];
    let curMonth = new Date().getMonth();
    let curYear = new Date().getFullYear();
    
    // Cache
    let resCache = {}; // Main Reservasi
    let reqCache = []; // Inbox Requests
    let fullCache = {}; // Status Full
    let menuCache = {}; // Menu Details
    let priceCache = {}; // Menu Prices
    let locCache = {}; // Locations
    
    let selectedDate = '';
    let unsubRes = null, unsubReq = null, unsubFull = null;
    let bcCustomers = []; // Cache customer for broadcast

    // --- 3. AUTHENTICATION ---
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('login-page').style.display='none';
            document.getElementById('main-ui').style.display='block';
            initApp();
        } else {
            document.getElementById('login-page').style.display='flex';
            document.getElementById('main-ui').style.display='none';
        }
    });

    function handleLogin() {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPassword').value;
        if(!e || !p) return Swal.fire('Error','Email & Pass wajib diisi','error');
        
        document.getElementById('loader').style.display='flex';
        auth.signInWithEmailAndPassword(e,p).catch(er => {
            document.getElementById('loader').style.display='none';
            document.getElementById('loginError').innerText = er.message;
            document.getElementById('loginError').style.display='block';
        });
    }
    function handleLogout() { if(confirm('Yakin ingin logout?')) auth.signOut(); }

    // --- 4. INIT & LOAD DATA ---
    async function initApp() {
        document.getElementById('loader').style.display='flex';
        try {
            await Promise.all([loadMenu(), loadLoc()]);
            listenRes();
            listenReq();
            listenFull();
            setupNotif();
        } catch(e) { console.error(e); Swal.fire('Error Init', e.message, 'error'); }
        document.getElementById('loader').style.display='none';
    }

    async function loadMenu() {
        const s = await db.collection('menus').get();
        menuCache = {}; priceCache = {};
        s.forEach(d => {
            const data = d.data();
            menuCache[d.id] = data.details || [];
            priceCache[d.id] = data.price ? parseInt(data.price) : 0;
        });
    }
    async function loadLoc() {
        const s = await db.collection('locations').get();
        locCache = {};
        s.forEach(d => locCache[d.id] = d.data());
    }

    // --- 5. LISTENERS ---
    function listenRes() {
        if(unsubRes) unsubRes();
        // Listener per bulan untuk optimasi
        const start = `${curYear}-${String(curMonth+1).padStart(2,'0')}-01`;
        const end = `${curYear}-${String(curMonth+1).padStart(2,'0')}-31`;
        
        unsubRes = db.collection('reservations').where('date','>=',start).where('date','<=',end)
            .onSnapshot(s => {
                resCache = {};
                s.forEach(d => {
                    const r = {id:d.id, ...d.data()};
                    if(!resCache[r.date]) resCache[r.date] = [];
                    resCache[r.date].push(r);
                });
                renderCal();
                // Jika sedang buka detail, refresh
                if(selectedDate && document.getElementById('popup-detail').style.display==='block') openDetail(selectedDate);
                // Update broadcast list cache
                updateBcCache();
            });
    }

    function listenReq() {
        if(unsubReq) unsubReq();
        unsubReq = db.collection('reservation_requests').where('status','==','pending')
            .onSnapshot(s => {
                reqCache = s.docs.map(d => ({id:d.id, ...d.data()}));
                const c = reqCache.length;
                document.getElementById('dashboard-inbox-badge').innerText = c;
                document.getElementById('dashboard-inbox-badge').style.display = c>0?'inline-block':'none';
                document.getElementById('header-inbox-badge').innerText = c;
                document.getElementById('header-inbox-badge').style.display = c>0?'inline-block':'none';
                if(document.getElementById('popup-inbox').style.display==='block') renderInbox();
            });
    }

    function listenFull() {
        if(unsubFull) unsubFull();
        unsubFull = db.collection('date_status').onSnapshot(s => {
            fullCache = {};
            s.forEach(d => fullCache[d.data().date] = d.data().isFull);
            renderCal();
        });
    }

    // --- 6. CALENDAR UI ---
    function renderCal() {
        const el = document.getElementById('calendar-days');
        el.innerHTML = '';
        document.getElementById('monthYear').innerText = `${months[curMonth]} ${curYear}`;
        
        const fDay = new Date(curYear, curMonth, 1).getDay();
        const days = new Date(curYear, curMonth+1, 0).getDate();
        const today = new Date().toISOString().split('T')[0];
        
        for(let i=0; i<fDay; i++) el.innerHTML += `<div></div>`;
        
        for(let i=1; i<=days; i++) {
            const date = `${curYear}-${String(curMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const count = (resCache[date]||[]).length;
            const isFull = fullCache[date] === true;
            
            let cls = 'cal-day';
            if(date === today) cls += ' today';
            if(isFull) cls += ' is-full';
            
            let html = `<div class="day-num">${i}</div>`;
            if(isFull) { /* handled by css */ }
            else if(count>0) html += `<div class="res-count">${count} Res</div>`;
            
            const div = document.createElement('div');
            div.className = cls;
            div.innerHTML = html;
            div.onclick = () => openDetail(date);
            el.appendChild(div);
        }
    }
    
    function moveMonth(d) {
        curMonth += d;
        if(curMonth<0){curMonth=11; curYear--;}
        if(curMonth>11){curMonth=0; curYear++;}
        listenRes(); // Refresh listener range
    }
    function goToToday() {
        const n = new Date(); curMonth=n.getMonth(); curYear=n.getFullYear();
        listenRes();
    }

    // --- 7. INBOX LOGIC (INTEGRATED) ---
    function openInbox() { renderInbox(); openPopup('popup-inbox'); }
    function renderInbox() {
        const el = document.getElementById('inbox-list');
        if(reqCache.length===0) { el.innerHTML='<p style="text-align:center; padding:20px; color:#888;">Tidak ada permintaan.</p>'; return; }
        
        el.innerHTML = reqCache.map(r => `
            <div class="req-card">
                <div class="req-header">
                    <div><b>${r.nama}</b> <span style="font-size:0.8rem; color:#666;">(${r.via||'Web'})</span></div>
                    <div style="text-align:right; color:var(--primary);"><b>${r.date}</b><br>${r.jam}</div>
                </div>
                <div style="font-size:0.9rem; margin-bottom:5px;">
                    <i class="fas fa-users"></i> ${r.jumlah} pax | <i class="fas fa-map-marker-alt"></i> ${r.tempat} | ${r.nomorHp}
                </div>
                <div class="req-menu">
                    ${(r.menus||[]).map(m=>`<b>${m.quantity}x</b> ${m.name}`).join(', ') || '-'}
                </div>
                ${r.tambahan ? `<div style="font-size:0.8rem; color:orange;">Note: ${r.tambahan}</div>` : ''}
                <div class="req-actions">
                    <button class="btn btn-whatsapp btn-sm" onclick="chatReq('${r.id}')"><i class="fab fa-whatsapp"></i> Chat & Hitung</button>
                    <button class="btn btn-danger btn-sm" onclick="rejectReq('${r.id}')">Tolak</button>
                    <button class="btn btn-success btn-sm" onclick="approveReq('${r.id}')">Terima</button>
                </div>
            </div>
        `).join('');
    }
    
    function chatReq(id) {
        const r = reqCache.find(x=>x.id===id);
        let total=0, txt='';
        (r.menus||[]).forEach(m => {
            const p = priceCache[m.name] || 0;
            const sub = p*m.quantity;
            total+=sub;
            txt += `- ${m.name} (${m.quantity}x): ${p>0 ? formatRp(sub) : 'Rp ?'}\n`;
        });
        const dp = total*0.5;
        const msg = `Halo Kak *${r.nama}* ðŸ‘‹,\nTerima kasih reservasi di Dolan Sawah.\n\nDetail:\nðŸ—“ ${r.date} | â° ${r.jam}\nðŸ‘¥ ${r.jumlah} pax | ðŸ“ ${r.tempat}\n\n*Estimasi Pesanan:*\n${txt}\nSubtotal: Rp ${formatRp(total)}\n*DP (50%): Rp ${formatRp(dp)}*\n\nMohon konfirmasi transfer DP ya kak.`;
        window.open(`https://wa.me/${r.nomorHp.replace(/^0/,'62')}?text=${encodeURIComponent(msg)}`,'_blank');
    }
    
    async function approveReq(id) {
        const r = reqCache.find(x=>x.id===id);
        const {value:dp} = await Swal.fire({input:'number', title:'Input DP (Rp)', inputPlaceholder:'0'});
        if(dp !== undefined) {
            document.getElementById('loader').style.display='flex';
            try {
                await db.collection('reservations').add({
                    ...r, dp:parseInt(dp), status:'confirmed', 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), via:'Mandiri Approved'
                });
                await db.collection('reservation_requests').doc(id).delete();
                Swal.fire('Sukses','Masuk Kalender','success');
                if(reqCache.length<=1) closePopup('popup-inbox');
            } catch(e){Swal.fire('Err',e.message,'error');}
            document.getElementById('loader').style.display='none';
        }
    }
    
    async function rejectReq(id) {
        if(confirm('Hapus permanen permintaan ini?')) {
            await db.collection('reservation_requests').doc(id).delete();
        }
    }

    // --- 8. SET FULL ---
    function openSetFull() { 
        document.getElementById('blockDate').value = new Date().toISOString().split('T')[0];
        openPopup('popup-full'); 
    }
    async function setFullStatus(stat) {
        const d = document.getElementById('blockDate').value;
        if(!d) return;
        await db.collection('date_status').doc(d).set({date:d, isFull:stat}, {merge:true});
        closePopup('popup-full'); Swal.fire('Berhasil', `Status ${d}: ${stat?'PENUH':'BUKA'}`, 'success');
    }

    // --- 9. CRUD RESERVASI ---
    function openAddForm() {
        document.getElementById('res-form').reset();
        document.getElementById('edit-id').value='';
        document.getElementById('form-title').innerText = 'Input Reservasi';
        document.getElementById('menu-rows').innerHTML='';
        if(selectedDate) document.getElementById('inp-date').value = selectedDate;
        
        fillLoc(); addMenuRow(); 
        openPopup('popup-form');
    }
    
    function addMenuRow(name='', qty=1) {
        const d = document.createElement('div');
        d.className = 'menu-row';
        let ops = '<option value="">Pilih...</option>';
        Object.keys(menuCache).sort().forEach(k => {
            const p = priceCache[k] ? ` (${formatRp(priceCache[k])})` : '';
            ops += `<option value="${k}" ${k===name?'selected':''}>${k}${p}</option>`;
        });
        d.innerHTML = `<select class="menu-select">${ops}</select><input type="number" class="quantity-input" value="${qty}"><button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('menu-rows').appendChild(d);
    }
    
    function fillLoc() {
        const s = document.getElementById('inp-tempat');
        s.innerHTML = '<option value="">Pilih...</option>';
        Object.values(locCache).forEach(l => {
            s.innerHTML += `<option value="${l.name}">${l.name} (Kap: ${l.capacity})</option>`;
        });
    }
    function checkCap() {
        const t = document.getElementById('inp-tempat').value;
        const l = Object.values(locCache).find(x=>x.name===t);
        if(l) document.getElementById('cap-info').innerText = `Max: ${l.capacity}`;
    }
    
    async function saveReservation() {
        const id = document.getElementById('edit-id').value;
        const data = {
            nama: document.getElementById('inp-nama').value,
            nomorHp: document.getElementById('inp-hp').value,
            date: document.getElementById('inp-date').value,
            jam: document.getElementById('inp-jam').value,
            jumlah: parseInt(document.getElementById('inp-jml').value),
            tempat: document.getElementById('inp-tempat').value,
            dp: parseInt(document.getElementById('inp-dp').value) || 0,
            tipeDp: document.getElementById('inp-via').value,
            tambahan: document.getElementById('inp-note').value,
            menus: []
        };
        
        if(!data.nama || !data.date) return alert("Nama & Tanggal wajib");
        
        document.querySelectorAll('#menu-rows .menu-row').forEach(r => {
            const n = r.querySelector('select').value;
            const q = r.querySelector('input').value;
            if(n && q) data.menus.push({name:n, quantity:parseInt(q)});
        });
        
        document.getElementById('loader').style.display='flex';
        try {
            if(id) await db.collection('reservations').doc(id).update(data);
            else await db.collection('reservations').add({...data, createdAt: firebase.firestore.FieldValue.serverTimestamp(), via:'Admin'});
            closePopup('popup-form'); Swal.fire('Tersimpan');
        } catch(e) { Swal.fire('Err',e.message,'error'); }
        document.getElementById('loader').style.display='none';
    }

    // --- 10. DETAIL VIEW ---
    function openDetail(date) {
        selectedDate = date;
        const list = resCache[date] || [];
        document.getElementById('detail-title').innerText = `${date} (${list.length})`;
        const el = document.getElementById('detail-list');
        document.getElementById('search-detail').value=''; // Reset search
        
        if(list.length===0) { el.innerHTML='<p style="text-align:center; color:#999; grid-column:1/-1;">Kosong</p>'; } 
        else { renderDetailList(list); }
        
        openPopup('popup-detail');
    }
    
    function renderDetailList(list) {
        document.getElementById('detail-list').innerHTML = list.map(r => `
            <div class="res-card">
                <div class="res-info">
                    <div><b>${r.nama}</b><br><small>${r.nomorHp}</small></div>
                    <div style="text-align:right;"><span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem;">${r.jam}</span></div>
                </div>
                <div style="font-size:0.9rem; margin-bottom:5px;">
                    <i class="fas fa-users"></i> ${r.jumlah} | <i class="fas fa-map-marker-alt"></i> ${r.tempat}
                </div>
                <div style="background:#f9f9f9; padding:5px; font-size:0.85rem; border-radius:5px; margin-bottom:5px;">
                    ${(r.menus||[]).map(m=>`<div>${m.quantity}x ${m.name}</div>`).join('') || '-'}
                </div>
                <div style="font-size:0.85rem; display:flex; justify-content:space-between;">
                    <span style="color:green; font-weight:bold;">DP: ${formatRp(r.dp)}</span>
                    <small>${r.via||'Manual'}</small>
                </div>
                ${r.tambahan ? `<div style="font-size:0.8rem; color:orange;">${r.tambahan}</div>`:''}
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button class="btn btn-sm btn-whatsapp" style="flex:1;" onclick="waCust('${r.nomorHp}','${r.nama}')">Chat</button>
                    <button class="btn btn-sm btn-secondary" style="flex:1;" onclick="editRes('${r.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" style="flex:1;" onclick="delRes('${r.id}')">Hapus</button>
                </div>
            </div>
        `).join('');
    }
    
    function filterDetail(v) {
        if(!selectedDate) return;
        const q = v.toLowerCase();
        const filtered = (resCache[selectedDate]||[]).filter(r => r.nama.toLowerCase().includes(q) || r.tempat.toLowerCase().includes(q));
        renderDetailList(filtered);
    }
    
    function editRes(id) {
        const r = resCache[selectedDate].find(x=>x.id===id);
        document.getElementById('edit-id').value=r.id;
        document.getElementById('form-title').innerText='Edit Data';
        document.getElementById('inp-nama').value=r.nama;
        document.getElementById('inp-hp').value=r.nomorHp;
        document.getElementById('inp-date').value=r.date;
        document.getElementById('inp-jam').value=r.jam;
        document.getElementById('inp-jml').value=r.jumlah;
        fillLoc(); document.getElementById('inp-tempat').value=r.tempat;
        document.getElementById('inp-dp').value=r.dp;
        document.getElementById('inp-via').value=r.tipeDp;
        document.getElementById('inp-note').value=r.tambahan;
        document.getElementById('menu-rows').innerHTML='';
        (r.menus||[]).forEach(m => addMenuRow(m.name, m.quantity));
        openPopup('popup-form');
    }
    
    async function delRes(id) {
        if(confirm('Hapus?')) await db.collection('reservations').doc(id).delete();
    }

    // --- 11. UTILITAS (EXPORT, PRINT, BROADCAST, DLL) ---
    function openExport() {
        // Export simplified JSON for Viewer
        const data = { v:'6.0', data: resCache };
        document.getElementById('export-area').value = btoa(JSON.stringify(data));
        openPopup('popup-export');
    }
    function copyExport() {
        document.getElementById('export-area').select(); document.execCommand('copy');
        Swal.fire('Tersalin');
    }
    
    function openMenu() { renderMList(); openPopup('popup-menu'); }
    function renderMList() { document.getElementById('list-menu').innerHTML = Object.keys(menuCache).map(k=>`<div>${k} <button onclick="delMenu('${k}')">x</button></div>`).join(''); }
    async function addMenu() { 
        const n=document.getElementById('new-menu-name').value;
        const p=document.getElementById('new-menu-price').value;
        const d=document.getElementById('new-menu-det').value.split(',');
        await db.collection('menus').doc(n).set({price:p, details:d}); loadMenu(); renderMList();
    }
    async function delMenu(n) { if(confirm('Hapus?')) { await db.collection('menus').doc(n).delete(); loadMenu(); renderMList(); } }

    function openLocation() { renderLList(); openPopup('popup-loc'); }
    function renderLList() { document.getElementById('list-loc').innerHTML = Object.values(locCache).map(l=>`<div>${l.name} <button onclick="delLoc('${l.id}')">x</button></div>`).join(''); }
    async function addLoc() {
        const n=document.getElementById('new-loc-name').value; const c=document.getElementById('new-loc-cap').value;
        await db.collection('locations').add({name:n, capacity:c}); loadLoc(); renderLList();
    }
    async function delLoc(id) { if(confirm('Hapus?')) await db.collection('locations').doc(id).delete(); loadLoc(); renderLList(); }
    
    // Broadcast
    function updateBcCache() {
        bcCustomers = [];
        Object.values(resCache).flat().forEach(r => { 
            if(r.nomorHp) bcCustomers.push({n:r.nama, h:r.nomorHp}); 
        });
        // Unique
        bcCustomers = bcCustomers.filter((v,i,a)=>a.findIndex(t=>(t.h === v.h))===i);
    }
    function openBroadcast() { 
        document.getElementById('bc-msg').value = localStorage.getItem('bc_tmpl') || '';
        filterBc(''); openPopup('popup-broadcast'); 
    }
    function saveBcMsg() { localStorage.setItem('bc_tmpl', document.getElementById('bc-msg').value); Swal.fire('Saved'); }
    function filterBc(v) {
        const q = v.toLowerCase();
        const el = document.getElementById('bc-list');
        const list = bcCustomers.filter(c => c.n.toLowerCase().includes(q) || c.h.includes(q));
        el.innerHTML = list.map(c => `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><b>${c.n}</b> <button class="btn btn-sm btn-whatsapp" onclick="sendBc('${c.h}','${c.n}')">Kirim</button></div>`).join('');
    }
    function sendBc(h,n) {
        let msg = document.getElementById('bc-msg').value;
        msg = msg.replace('Kak', `Kak ${n}`);
        window.open(`https://wa.me/${h.replace(/^0/,'62')}?text=${encodeURIComponent(msg)}`,'_blank');
    }
    
    // Customer
    function openCustomer() { filterCust(''); openPopup('popup-customer'); }
    function filterCust(v) {
        const q = v.toLowerCase();
        const list = bcCustomers.filter(c => c.n.toLowerCase().includes(q) || c.h.includes(q)); // Reuse bc list
        document.getElementById('cust-list').innerHTML = list.map(c => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${c.n}</b> (${c.h}) <button class="btn btn-sm btn-whatsapp" onclick="waCust('${c.h}','${c.n}')">WA</button></div>`).join('');
    }
    
    // Analysis
    function openAnalysis() {
        openPopup('popup-analysis');
        const ctx = document.getElementById('chart-anl').getContext('2d');
        const counts = Array(12).fill(0);
        let totalPax = 0;
        // Scan data tahun ini (resCache hanya muat bulan ini, perlu load all? untuk simple kita pakai bulan ini saja dulu atau load extra)
        // Note: Untuk performa, idealnya load all data di background. Disini kita visualisasi bulan ini.
        Object.keys(resCache).forEach(d => {
            const dt = new Date(d);
            if(dt.getMonth() === curMonth) counts[dt.getMonth()] = (resCache[d]||[]).length;
            (resCache[d]||[]).forEach(r => totalPax += parseInt(r.jumlah)||0);
        });
        
        new Chart(ctx, { type:'bar', data:{labels:months, datasets:[{label:'Reservasi', data:counts, backgroundColor:'#2a9d8f'}]}});
        document.getElementById('stats-anl').innerHTML = `
            <div class="mini-stat"><div class="val">${totalPax}</div><small>Total Pax (Bulan Ini)</small></div>
        `;
    }
    
    // Print & Share
    function shareDay() {
        if(!selectedDate) return;
        const list = resCache[selectedDate] || [];
        let txt = `*Laporan ${selectedDate}*\n`;
        list.forEach((r,i) => txt += `${i+1}. ${r.nama} (${r.jam}) - ${r.jumlah} org\n`);
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    }
    function printDay() { window.print(); }

    // Utils
    function formatRp(n) { return (n||0).toLocaleString('id-ID'); }
    function openPopup(id) { document.getElementById(id).style.display='block'; document.getElementById('overlay').style.display='block'; }
    function closePopup(id) { document.getElementById(id).style.display='none'; document.getElementById('overlay').style.display='none'; }
    function waCust(h,n) { window.open(`https://wa.me/${h.replace(/^0/,'62')}?text=Halo Kak ${n}`,'_blank'); }
    function toggleNotif() {
        const d = document.getElementById('notif-dropdown');
        d.style.display = d.style.display==='block'?'none':'block';
    }
    
    function setupNotif() {
        // Simple interval for notification
        setInterval(()=>{
            const n = new Date();
            const today = n.toISOString().split('T')[0];
            const list = resCache[today]||[];
            let count=0, html='';
            list.forEach(r=>{
                if(!r.thankSent) {
                    const [h,m] = r.jam.split(':');
                    const t = new Date(); t.setHours(h,m,0);
                    if(n > new Date(t.getTime()+2*3600000)) {
                        count++;
                        html+=`<div class="notification-item">${r.nama} <button class="btn btn-sm btn-success" onclick="markSent('${r.id}')">Kirim</button></div>`;
                    }
                }
            });
            const badge = document.getElementById('notif-badge');
            badge.innerText = count;
            badge.style.display = count>0?'flex':'none';
            document.getElementById('notif-list').innerHTML = html || '<div style="padding:10px; color:#999;">Kosong</div>';
        }, 60000);
    }
    async function markSent(id) { await db.collection('reservations').doc(id).update({thankSent:true}); }

</script>
</body>
</html>
