<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Sistem Manajemen Dolan Sawah - Unified V6.0</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    /* =========================================
       1. VARIABEL GLOBAL & RESET
       ========================================= */
    :root {
      /* Palette Dolan Sawah Unified */
      --primary: #2a9d8f;       /* Emerald Green */
      --primary-dark: #21867a;  /* Darker Emerald */
      --secondary: #264653;     /* Dark Slate */
      --accent: #e9c46a;        /* Sandy Gold */
      --danger: #e76f51;        /* Terracotta Red */
      --success: #10b981;       /* Bright Green */
      --warning: #f59e0b;       /* Amber */
      --info: #0077b6;          /* Ocean Blue */
      --whatsapp: #25D366;      /* WA Brand Color */
      
      /* Layout Colors */
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      
      /* Dimensions */
      --sidebar-width: 270px;
      --header-height: 60px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: 'Inter', 'Poppins', sans-serif; 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      margin: 0; padding: 0; 
      display: flex; height: 100vh; overflow: hidden; 
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* =========================================
       2. LOGIN SCREEN (Full Overlay)
       ========================================= */
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover; background-blend-mode: multiply;
      z-index: 9999; display: flex; justify-content: center; align-items: center;
    }
    .login-box {
      background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 16px; width: 90%; max-width: 420px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; backdrop-filter: blur(5px);
      border-top: 5px solid var(--accent);
    }
    .login-box h2 { color: var(--secondary); margin-bottom: 5px; font-weight: 700; }
    .login-box input { 
        width: 100%; padding: 14px; margin: 10px 0; border: 1px solid var(--border); 
        border-radius: 8px; font-size: 1rem; transition: 0.3s;
    }
    .login-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2); }
    .login-box button { 
        width: 100%; padding: 14px; background: var(--primary); color: white; border: none; 
        border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 15px; font-size: 1rem; 
        transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px;
    }
    .login-box button:hover { background: var(--primary-dark); transform: translateY(-2px); }

    /* =========================================
       3. SIDEBAR NAVIGATION
       ========================================= */
    .sidebar {
      width: var(--sidebar-width); background: white; border-right: 1px solid var(--border);
      display: flex; flex-direction: column; height: 100vh; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: fixed; left: 0; top: 0; z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.02);
    }
    .brand { 
        padding: 25px; font-size: 1.35rem; font-weight: 800; color: var(--primary-dark); 
        display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); 
        background: linear-gradient(to right, rgba(42, 157, 143, 0.05), transparent);
    }
    .nav-menu { flex: 1; padding: 20px; overflow-y: auto; }
    .nav-label { 
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); 
        margin: 20px 0 10px 10px; font-weight: 600; 
    }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 15px;
      color: var(--text-muted); text-decoration: none; border-radius: 10px;
      margin-bottom: 5px; transition: all 0.2s; cursor: pointer; font-weight: 500;
      position: relative;
    }
    .nav-item:hover { background-color: #f0fdf4; color: var(--primary); padding-left: 18px; }
    .nav-item.active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(42, 157, 143, 0.3); }
    .nav-item .badge { 
        margin-left: auto; background: var(--danger); color: white; padding: 2px 8px; 
        border-radius: 12px; font-size: 0.75rem; font-weight: 700;
    }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); background-color: #f9fafb; }
    .btn-logout { 
        width: 100%; padding: 12px; background: #fee2e2; color: #ef4444; border: 1px solid #fecaca;
        border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; 
        align-items: center; justify-content: center; gap: 8px; transition: 0.2s; 
    }
    .btn-logout:hover { background: #ef4444; color: white; border-color: #ef4444; }

    /* =========================================
       4. MAIN CONTENT AREA
       ========================================= */
    .main-content {
      flex: 1; margin-left: var(--sidebar-width); padding: 30px; overflow-y: auto; height: 100vh;
      background-color: var(--bg-body); position: relative;
    }
    
    /* Section Animation */
    .section { display: none; animation: fadeIn 0.4s ease; max-width: 1400px; margin: 0 auto; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .section-header { 
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; 
        flex-wrap: wrap; gap: 15px; background: white; padding: 20px; border-radius: 12px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid var(--border);
    }
    .section-title { font-size: 1.6rem; font-weight: 700; color: var(--secondary); margin: 0; display: flex; align-items: center; gap: 10px; }
    .section-subtitle { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; font-weight: 400; }

    /* Mobile Toggle */
    #mobile-toggle { 
        display: none; position: fixed; top: 15px; left: 15px; z-index: 2001;
        background: var(--primary); color: white; border: none; width: 45px; height: 45px; 
        border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        cursor: pointer; font-size: 1.2rem; align-items: center; justify-content: center;
        transition: 0.3s;
    }

    /* =========================================
       5. COMPONENTS: CARDS & STATS
       ========================================= */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { 
        background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
        border: 1px solid var(--border); display: flex; align-items: center; gap: 20px; 
        transition: transform 0.2s; cursor: default;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
    .stat-icon { 
        width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; 
        justify-content: center; font-size: 1.8rem; flex-shrink: 0;
    }
    .stat-info h4 { margin: 0; font-size: 0.9rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-info .value { font-size: 1.8rem; font-weight: 800; color: var(--secondary); display: block; margin-top: 5px; line-height: 1.1; }

    .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid var(--border); }
    .card h3 { margin-top: 0; margin-bottom: 20px; color: var(--secondary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; display: inline-block; }

    /* =========================================
       6. COMPONENTS: BUTTONS & FORMS
       ========================================= */
    .btn { 
        padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; 
        display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-family: 'Inter', sans-serif;
        font-size: 0.9rem; text-decoration: none;
    }
    .btn:hover { filter: brightness(110%); }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }

    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-info { background: var(--info); color: white; }
    .btn-whatsapp { background: var(--whatsapp); color: white; }
    .btn-accent { background: var(--accent); color: white; }

    input, select, textarea { 
        width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); 
        margin-top: 6px; margin-bottom: 15px; font-family: 'Inter', sans-serif; 
        background-color: #f9fafb; font-size: 0.95rem;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); background-color: white; }
    label { font-weight: 600; color: var(--secondary); font-size: 0.9rem; }

    /* =========================================
       7. COMPONENTS: INBOX / REQUEST CARDS
       ========================================= */
    .request-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
    .request-card { 
        background: white; border-radius: 12px; padding: 20px; border-left: 6px solid var(--warning); 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; transition: all 0.3s;
    }
    .request-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .request-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
    .req-name { font-weight: 700; font-size: 1.15rem; color: var(--secondary); }
    .req-via { font-size: 0.75rem; background: #eee; padding: 4px 10px; border-radius: 20px; color: #666; font-weight: 600; text-transform: uppercase; }
    .req-details { font-size: 0.95rem; color: #555; line-height: 1.8; margin-bottom: 15px; }
    .req-details i { color: var(--primary); width: 25px; text-align: center; margin-right: 5px; }
    .req-menu-box { 
        background: #f8fafc; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 0.9rem; 
        border: 1px dashed #cbd5e1; 
    }
    .req-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
    .req-actions button { width: 100%; justify-content: center; font-size: 0.85rem; padding: 10px 5px; }

    /* =========================================
       8. COMPONENTS: CALENDAR & LISTS
       ========================================= */
    .calendar-wrapper { background: white; border-radius: 12px; overflow: hidden; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
    .cal-header-day { text-align: center; font-weight: 700; color: var(--primary-dark); font-size: 0.9rem; padding-bottom: 10px; }
    .cal-day { 
        min-height: 100px; border: 1px solid var(--border); border-radius: 8px; padding: 8px; 
        cursor: pointer; transition: 0.2s; position: relative; background: white;
        display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-end;
    }
    .cal-day:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); z-index: 2; }
    .cal-day.today { background: #fffbeb; border-color: var(--warning); }
    .cal-day.selected { border: 2px solid var(--primary); background-color: #f0fdf4; }
    
    .day-number { font-weight: 700; font-size: 0.9rem; margin-bottom: 5px; color: var(--text-muted); }
    .today .day-number { background: var(--warning); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
    
    .cal-event-dot { 
        width: 100%; background-color: rgba(42, 157, 143, 0.15); color: var(--primary-dark);
        border-radius: 4px; padding: 2px 4px; font-size: 0.7rem; margin-top: 2px;
        text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: 600;
    }

    .reservation-list-item { 
        background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; 
        border-left: 5px solid var(--primary); display: flex; flex-wrap: wrap;
        justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        transition: 0.2s;
    }
    .reservation-list-item:hover { box-shadow: 0 5px 12px rgba(0,0,0,0.08); }

    /* =========================================
       9. MODALS & POPUPS (Unified)
       ========================================= */
    .overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: rgba(0, 0, 0, 0.6); z-index: 2100; display: none; backdrop-filter: blur(2px);
    }
    .popup-form { 
        display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        z-index: 2200; width: 95%; max-width: 650px; max-height: 90vh; overflow-y: auto;
        background-color: white; padding: 30px; border-radius: 16px; 
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); border-top: 6px solid var(--primary);
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
    
    .popup-form h3 { margin-top: 0; color: var(--secondary); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.2rem; color: #aaa; cursor: pointer; transition: 0.2s; }
    .close-btn:hover { color: var(--danger); }

    /* =========================================
       10. UTILITIES
       ========================================= */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); z-index: 9999; 
      display: flex; justify-content: center; align-items: center; display: none; flex-direction: column; gap: 15px;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { 
        left: -280px; width: 280px; transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.3); }
      .main-content { margin-left: 0; padding: 70px 15px 20px 15px; width: 100%; }
      #mobile-toggle { display: flex; }
      .req-actions { grid-template-columns: 1fr; }
      .stat-card { padding: 15px; }
      .stat-icon { width: 50px; height: 50px; font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div id="login-overlay">
    <div class="login-box">
      <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;">
        <i class="fas fa-seedling"></i>
      </div>
      <h2>Admin Dolan Sawah</h2>
      <p style="color:#666; margin-bottom: 25px;">Sistem Manajemen Terintegrasi (V6.0)</p>
      
      <form onsubmit="event.preventDefault(); handleLogin();">
        <input type="email" id="email" placeholder="Email Admin" required autocomplete="email">
        <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
        <button type="submit"><i class="fas fa-sign-in-alt"></i> Masuk Dashboard</button>
      </form>
      <p id="login-error" style="color:var(--danger); display:none; margin-top:10px; font-size:0.9rem;">
        Email atau password salah.
      </p>
    </div>
  </div>

  <button id="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  <div class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fas fa-leaf" style="color:var(--primary);"></i> Dolan Sawah
    </div>
    
    <div class="nav-menu">
      <div class="nav-label">Utama</div>
      <div class="nav-item active" onclick="switchTab('dashboard')" id="nav-dashboard">
        <i class="fas fa-th-large"></i> Dashboard
      </div>
      <div class="nav-item" onclick="switchTab('inbox')" id="nav-inbox">
        <i class="fas fa-inbox"></i> Permintaan
        <span class="badge" id="sidebar-badge">0</span>
      </div>
      <div class="nav-item" onclick="switchTab('calendar')" id="nav-calendar">
        <i class="far fa-calendar-alt"></i> Kalender Reservasi
      </div>

      <div class="nav-label">Manajemen</div>
      <div class="nav-item" onclick="switchTab('data')" id="nav-data">
        <i class="fas fa-database"></i> Data Master
      </div>
      <div class="nav-item" onclick="switchTab('broadcast')" id="nav-broadcast">
        <i class="fas fa-bullhorn"></i> Broadcast Promo
      </div>
      
      <div class="nav-label">Wawasan</div>
      <div class="nav-item" onclick="switchTab('analysis')" id="nav-analysis">
        <i class="fas fa-chart-pie"></i> Analisis Data
      </div>
    </div>
    
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Keluar Sistem</button>
    </div>
  </div>

  <div class="main-content" id="main-content">
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="font-weight: 500; color: var(--secondary);">Memproses Data...</p>
    </div>

    <div id="tab-dashboard" class="section active">
      <div class="section-header">
        <div>
            <h2 class="section-title">Overview Hari Ini</h2>
            <div class="section-subtitle" id="date-display">Memuat tanggal...</div>
        </div>
        <div>
            <button class="btn btn-primary" onclick="initApp()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background:#e0f2fe; color:#0284c7;"><i class="fas fa-user-friends"></i></div>
          <div class="stat-info"><h4>Tamu Hari Ini</h4><span class="value" id="stat-today-pax">0</span></div>
        </div>
        <div class="stat-card" onclick="switchTab('inbox')" style="cursor:pointer;">
          <div class="stat-icon" style="background:#ffedd5; color:#c2410c;"><i class="fas fa-envelope-open-text"></i></div>
          <div class="stat-info"><h4>Pending Request</h4><span class="value" id="stat-pending">0</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#dcfce7; color:#15803d;"><i class="fas fa-check-circle"></i></div>
          <div class="stat-info"><h4>Reservasi Bulan Ini</h4><span class="value" id="stat-month-total">0</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#f3e8ff; color:#7e22ce;"><i class="fas fa-money-bill-wave"></i></div>
          <div class="stat-info"><h4>Est. DP Masuk</h4><span class="value" id="stat-month-dp" style="font-size:1.3rem;">Rp 0</span></div>
        </div>
      </div>

      <div class="card">
         <h3><i class="fas fa-history"></i> Reservasi Terbaru Masuk</h3>
         <div id="recent-reservations-list">
             <p style="color:#999; text-align:center; padding: 20px;">Sedang memuat data...</p>
         </div>
         <div style="text-align: center; margin-top: 15px;">
            <button class="btn btn-secondary" onclick="switchTab('calendar')">Lihat Semua di Kalender</button>
         </div>
      </div>
    </div>

    <div id="tab-inbox" class="section">
      <div class="section-header">
        <div>
            <h2 class="section-title"><i class="fas fa-inbox"></i> Inbox Permintaan</h2>
            <div class="section-subtitle">Daftar reservasi mandiri yang menunggu persetujuan</div>
        </div>
        <button class="btn btn-primary" onclick="initApp()"><i class="fas fa-sync"></i> Cek Data Baru</button>
      </div>
      
      <div id="inbox-container" class="request-grid">
          </div>
    </div>
    <div id="tab-calendar" class="section">
      
      <div id="calendar-main-view">
          <div class="section-header">
            <div>
                <h2 class="section-title"><i class="far fa-calendar-alt"></i> Kalender Reservasi</h2>
                <div class="section-subtitle">Pilih tanggal untuk melihat detail atau tambah reservasi</div>
            </div>
            
            <div style="display: flex; gap:10px; align-items:center; background: #fff; padding: 5px; border-radius: 8px; border: 1px solid var(--border);">
               <button class="btn btn-primary" onclick="navigateMonth(-1)"><i class="fas fa-chevron-left"></i></button>
               <span id="monthYear" style="font-weight:700; font-size:1.1rem; min-width:160px; text-align:center; color: var(--secondary);">...</span>
               <button class="btn btn-primary" onclick="navigateMonth(1)"><i class="fas fa-chevron-right"></i></button>
               <button class="btn btn-secondary" onclick="goToToday()" title="Hari Ini"><i class="fas fa-calendar-day"></i></button>
            </div>
          </div>
          
          <div class="calendar-wrapper">
            <div class="calendar-grid">
                <div class="cal-header-day" style="color:#ef4444">Minggu</div>
                <div class="cal-header-day">Senin</div>
                <div class="cal-header-day">Selasa</div>
                <div class="cal-header-day">Rabu</div>
                <div class="cal-header-day">Kamis</div>
                <div class="cal-header-day" style="color:#10b981">Jumat</div>
                <div class="cal-header-day">Sabtu</div>
            </div>
            <div id="calendar" class="calendar-grid" style="margin-top: 5px;"></div>
          </div>
      </div>

      <div id="reservation-view-container" style="display: none;">
        <div class="section-header" style="background: #e0f2fe; border-color: #bae6fd;">
            <div>
                <h2 class="section-title" id="reservation-view-title" style="color:#0369a1">Detail Tanggal</h2>
                <div class="section-subtitle" style="color:#0c4a6e">Kelola reservasi untuk tanggal ini</div>
            </div>
            <button class="btn btn-danger" onclick="kembaliKeKalender()"><i class="fas fa-arrow-left"></i> Kembali ke Kalender</button>
        </div>

        <div class="card" style="padding: 15px; background: white; border-top: 4px solid var(--primary);">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showAddForm()"><i class="fas fa-plus-circle"></i> Tambah Reservasi</button>
                <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                
                <button class="btn btn-whatsapp" onclick="shareViaWhatsApp('day')"><i class="fab fa-whatsapp"></i> Share Laporan Harian</button>
                <button class="btn btn-secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Email</button>
                <button class="btn btn-info" onclick="printData()"><i class="fas fa-print"></i> Print Data</button>
                
                <div style="flex-grow: 1;"></div> <div style="position: relative; min-width: 250px;">
                    <input type="text" id="detailSearchInput" oninput="filterReservations(this.value)" placeholder="Cari nama, menu, atau tempat..." style="margin:0; padding-right: 30px;">
                    <i class="fas fa-search" style="position: absolute; right: 10px; top: 12px; color: #999;"></i>
                </div>
            </div>
        </div>

        <div id="reservation-detail-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            </div>
      </div>
    </div>

    <div id="tab-data" class="section">
       <div class="section-header">
         <h2 class="section-title"><i class="fas fa-database"></i> Data Master</h2>
         <div class="section-subtitle">Kelola menu makanan, daftar tempat duduk, dan data pelanggan</div>
       </div>
       
       <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:25px;">
         
         <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                <h3 style="margin:0; border:none;">üç¥ Daftar Menu</h3>
                <button class="btn btn-primary" onclick="showMenuManagement()" style="padding: 6px 12px; font-size:0.85rem;"><i class="fas fa-edit"></i> Kelola Penuh</button>
            </div>
            <div id="master-menu-preview" style="min-height: 100px;">
                <p style="color:#888; font-size:0.9rem;">Klik 'Kelola Penuh' untuk menambah atau mengedit harga & detail menu.</p>
            </div>
         </div>
         
         <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                <h3 style="margin:0; border:none;">üìç Daftar Tempat</h3>
                <button class="btn btn-primary" onclick="showLocationManagement()" style="padding: 6px 12px; font-size:0.85rem;"><i class="fas fa-edit"></i> Kelola Penuh</button>
            </div>
            <div id="master-location-preview" style="min-height: 100px;">
                <p style="color:#888; font-size:0.9rem;">Klik 'Kelola Penuh' untuk mengatur kapasitas tempat duduk.</p>
            </div>
         </div>

         <div class="card" style="grid-column: 1 / -1;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                <h3 style="margin:0; border:none;"><i class="fas fa-address-book"></i> Database Pelanggan</h3>
                <button class="btn btn-success" onclick="showCustomerMenu()"><i class="fas fa-search"></i> Lihat Semua Pelanggan</button>
            </div>
            <p style="color:#666;">Data pelanggan diambil otomatis dari riwayat reservasi yang masuk. Gunakan menu ini untuk mencari kontak atau mengirim pesan WhatsApp langsung.</p>
         </div>

       </div>
    </div>

    <div id="tab-analysis" class="section">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-chart-line"></i> Analisis Bisnis</h2>
        <button class="btn btn-primary" onclick="showAnalysis()"><i class="fas fa-filter"></i> Filter Lanjutan</button>
      </div>
      <div class="card" style="height: 450px;">
          <canvas id="mainChartCanvas"></canvas>
      </div>
      <div id="analysis-insights-container" style="margin-top: 20px;">
          </div>
    </div>

    <div id="tab-broadcast" class="section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-bullhorn"></i> Broadcast Promo</h2>
            <div class="section-subtitle">Kirim pesan massal ke pelanggan via WhatsApp</div>
        </div>
        
        <div class="card" style="text-align: center; padding: 40px;">
            <i class="fab fa-whatsapp" style="font-size: 4rem; color: var(--whatsapp); margin-bottom: 20px;"></i>
            <h3>Kirim Promo & Pengumuman</h3>
            <p style="max-width: 600px; margin: 0 auto 20px auto; color: #666;">
                Fitur ini memungkinkan Anda mengirim pesan ke pelanggan yang tersimpan di database. 
                Sangat efektif untuk meningkatkan penjualan di hari sepi atau mengumumkan menu baru.
            </p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-info" onclick="showBroadcastSettings()"><i class="fas fa-cog"></i> Atur Pesan</button>
                <button class="btn btn-whatsapp" onclick="showBroadcastList()"><i class="fas fa-paper-plane"></i> Mulai Broadcast</button>
            </div>
        </div>
    </div>
    <div id="addFormPopup" class="popup-form">
      <span class="close-btn" onclick="closePopup('addFormPopup')"><i class="fas fa-times"></i></span>
      <h3><i class="fas fa-calendar-plus" style="color:var(--primary);"></i> Input Reservasi Baru</h3>
      
      <form id="reservation-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Nama Pemesan</label>
                <input type="text" id="nama" placeholder="Nama Pelanggan" required />
                <span class="error-message" id="nama-error" style="color:var(--danger); font-size:0.8rem;"></span>
            </div>
            <div>
                <label>Nomor WhatsApp</label>
                <input type="tel" id="nomorHp" placeholder="08..." />
                <span class="error-message" id="nomorHp-error" style="color:var(--danger); font-size:0.8rem;"></span>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Jam Kedatangan</label>
                <input type="time" id="jam" required />
                <span class="error-message" id="jam-error" style="color:var(--danger); font-size:0.8rem;"></span>
            </div>
            <div>
                <label>Jumlah Orang</label>
                <input type="number" id="jumlah" min="1" placeholder="Contoh: 4" required />
                <span class="error-message" id="jumlah-error" style="color:var(--danger); font-size:0.8rem;"></span>
            </div>
        </div>

        <div>
            <label>Pilih Tempat / Meja</label>
            <select id="tempat" required onchange="updateCapacityInfo('reservation-form')">
                <option value="">-- Memuat Tempat --</option>
            </select>
            <small id="capacity-info" style="color:var(--info); font-weight:600;"></small>
            <span class="error-message" id="tempat-error" style="color:var(--danger); font-size:0.8rem;"></span>
        </div>

        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin: 15px 0;">
            <label style="color:var(--primary-dark);">Paket Menu Makanan <span class="error-message" id="menus-error" style="color:var(--danger);"></span></label>
            <div id="selected-menus-container" style="margin-bottom: 10px;"></div>
            <button type="button" class="btn btn-secondary" id="add-menu-btn" onclick="addMenuSelectionRow('reservation-form')" style="width:100%; justify-content:center; font-size:0.85rem;">
                <i class="fas fa-plus"></i> Tambah Item Menu
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Nominal DP (Rp)</label>
                <input type="number" id="dp" value="0" min="0" />
            </div>
            <div>
                <label>Metode Pembayaran DP</label>
                <select id="tipeDp">
                  <option value="">- Tanpa DP -</option>
                  <option>Cash</option><option>QRIS</option>
                  <option>Transfer BCA</option><option>Transfer Mandiri</option><option>Transfer BRI</option>
                </select>
            </div>
        </div>

        <label>Catatan Tambahan / Request</label>
        <textarea id="tambahan" placeholder="Contoh: Kursi bayi, jangan pedas, dll." style="height: 60px;"></textarea>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-primary" onclick="simpanReservasi()" style="flex:1;"><i class="fas fa-save"></i> Simpan Data</button>
            <button type="button" class="btn btn-danger" onclick="closePopup('addFormPopup')">Batal</button>
        </div>
      </form>
    </div>

    <div id="editFormPopup" class="popup-form"></div>

    <div id="menuManagementPopup" class="popup-form" style="max-width: 800px;">
        </div>

    <div id="locationManagementPopup" class="popup-form">
        </div>

    <div id="customerListPopup" class="popup-form" style="max-width: 500px; height: 80vh;">
        </div>

    <div id="printOptionsPopup" class="popup-form" style="max-width: 400px;">
        <span class="close-btn" onclick="closePopup('printOptionsPopup')"><i class="fas fa-times"></i></span>
        <h3><i class="fas fa-print"></i> Opsi Cetak</h3>
        <p>Pilih detail yang ingin ditampilkan pada laporan:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
            <label style="background:#f3f4f6; padding:10px; border-radius:6px; display:flex; align-items:center; gap:8px; font-weight:400;">
                <input type="checkbox" id="print-detail-menu" checked style="width:auto; margin:0;"> Detail Menu
            </label>
            <label style="background:#f3f4f6; padding:10px; border-radius:6px; display:flex; align-items:center; gap:8px; font-weight:400;">
                <input type="checkbox" id="print-kontak" checked style="width:auto; margin:0;"> No. HP
            </label>
            <label style="background:#f3f4f6; padding:10px; border-radius:6px; display:flex; align-items:center; gap:8px; font-weight:400;">
                <input type="checkbox" id="print-dp" checked style="width:auto; margin:0;"> Info DP
            </label>
            <label style="background:#f3f4f6; padding:10px; border-radius:6px; display:flex; align-items:center; gap:8px; font-weight:400;">
                <input type="checkbox" id="print-tambahan" checked style="width:auto; margin:0;"> Notes
            </label>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn btn-primary" onclick="executePrint()" style="flex:1;"><i class="fas fa-check"></i> Cetak Sekarang</button>
        </div>
    </div>

    <div id="analysisPopup" class="popup-form">
        </div>

    <div id="exportDataPopup" class="popup-form">
        <span class="close-btn" onclick="closePopup('exportDataPopup')"><i class="fas fa-times"></i></span>
        <h3><i class="fas fa-file-export"></i> Export Data Viewer</h3>
        <p style="font-size:0.9rem; color:#666;">Salin kode di bawah ini untuk digunakan di aplikasi Viewer tim dapur/bar.</p>
        <textarea id="export-data-output" readonly style="height: 150px; font-family: monospace; font-size: 0.8rem; background-color: #f1f5f9; border:1px solid #ccc; width:100%;"></textarea>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="copyExportCode()" style="flex:1"><i class="fas fa-copy"></i> Salin Kode</button>
        </div>
    </div>

    <div id="broadcastMainPopup" class="popup-form" style="max-width: 400px; text-align: center;">
         <span class="close-btn" onclick="closePopup('broadcastMainPopup')"><i class="fas fa-times"></i></span>
         <h3><i class="fas fa-bullhorn"></i> Broadcast Promo</h3>
         <p>Pilih tindakan:</p>
         <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button class="btn btn-info" onclick="showBroadcastSettings()"><i class="fas fa-cog"></i> Atur Pesan Broadcast</button>
            <button class="btn btn-whatsapp" onclick="showBroadcastList()"><i class="fas fa-paper-plane"></i> Pilih Penerima & Kirim</button>
         </div>
    </div>

    <div id="broadcastSettingsPopup" class="popup-form">
        <span class="close-btn" onclick="closePopup('broadcastSettingsPopup')"><i class="fas fa-times"></i></span>
        <h3><i class="fas fa-cog"></i> Atur Pesan Promo</h3>
        <p style="font-size:0.9rem;">Gunakan format WA (*tebal*, _miring_). Kata "Kak" akan ditambahkan otomatis dengan Nama.</p>
        <textarea id="broadcastMessage" placeholder="Contoh: Ada menu baru lho di Dolan Sawah! Diskon 10% khusus minggu ini..." style="height: 150px;"></textarea>
        <div style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="saveBroadcastMessage()" style="width:100%"><i class="fas fa-save"></i> Simpan Pesan</button>
        </div>
    </div>

    <div id="broadcastListPopup" class="popup-form" style="max-width: 600px; height: 80vh;">
        <span class="close-btn" onclick="closePopup('broadcastListPopup')"><i class="fas fa-times"></i></span>
        <h3><i class="fas fa-users"></i> Daftar Target Broadcast</h3>
        <input type="text" id="broadcastCustomerSearch" oninput="filterBroadcastCustomers(this.value)" placeholder="Cari nama pelanggan..." style="margin-bottom: 10px;">
        <div id="broadcast-customer-list" style="overflow-y: auto; height: 60%; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
            </div>
    </div>

  </div> <div class="overlay" id="overlay" onclick="closePopupAll()"></div>
<script>
    // =========================================
    // 1. KONFIGURASI FIREBASE & INISIALISASI
    // =========================================
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };
    
    // Mencegah inisialisasi ganda
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // =========================================
    // 2. VARIABEL GLOBAL (STATE MANAGEMENT)
    // =========================================
    // -- Waktu & Kalender --
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null; // Format YYYY-MM-DD
    
    // -- Cache Data (Untuk Performa Cepat) --
    let reservationsData = {};  // Object: { "MM-DD": [Array Reservasi] } -> Dioptimalkan untuk kalender
    let requestsCache = [];     // Array: Menyimpan data Inbox
    let allReservationsRaw = []; // Array: Untuk keperluan analisis berat
    
    // -- Data Master (Merged Website 1 & 2) --
    let detailMenu = {};        // Map: Nama Menu -> Array Detail
    let menuPrices = {};        // Map: Nama Menu -> Harga (Number)
    let locationsData = {};     // Map: ID Lokasi -> Object {name, capacity}
    
    // -- System Logic --
    let unsubscribeReservations = null;
    let unsubscribeRequests = null;
    let notificationInterval = null;
    
    // =========================================
    // 3. UTILITIES & HELPER FUNCTIONS
    // =========================================
    function showLoader() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loadingOverlay').style.display = 'none'; }
    
    // Format Rupiah
    function formatMoney(amount) { 
        return (amount || 0).toLocaleString('id-ID'); 
    }
    
    // Bersihkan Nomor HP (08xx -> 628xx)
    function cleanPhoneNumber(phone) {
        if(!phone) return "";
        let p = phone.replace(/[^0-9]/g, '');
        if (p.startsWith('0')) p = '62' + p.slice(1);
        return p;
    }

    // Tampilkan Toast / Alert (Menggunakan SweetAlert2 agar modern)
    function showToast(title, icon = 'success') {
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        Toast.fire({ icon: icon, title: title });
    }

    // Tutup Popup
    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
        checkOverlay();
    }
    
    function closePopupAll() {
        document.querySelectorAll('.popup-form').forEach(el => el.style.display = 'none');
        document.getElementById('overlay').style.display = 'none';
        
        // Reset Sidebar Mobile jika terbuka
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('mobile-toggle').innerHTML = '<i class="fas fa-bars"></i>';
    }

    function checkOverlay() {
        // Cek apakah masih ada popup yang terbuka
        const anyOpen = Array.from(document.querySelectorAll('.popup-form')).some(el => el.style.display === 'block');
        if(!anyOpen) document.getElementById('overlay').style.display = 'none';
    }

    // =========================================
    // 4. OTENTIKASI ADMIN
    // =========================================
    auth.onAuthStateChanged(user => {
        if (user) {
            // User Login Sukses
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            initApp(); // Mulai Aplikasi
        } else {
            // User Logout / Belum Login
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            // Stop listeners untuk hemat data
            if(unsubscribeReservations) unsubscribeReservations();
            if(unsubscribeRequests) unsubscribeRequests();
        }
    });

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');
        
        // Animasi tombol loading (opsional)
        const btn = document.querySelector('.login-box button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Masuk...';
        btn.disabled = true;

        try {
            await auth.signInWithEmailAndPassword(email, password);
            // Sukses -> ditangani onAuthStateChanged
        } catch (error) {
            errorEl.style.display = 'block';
            errorEl.textContent = "Gagal Masuk: " + error.message;
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function handleLogout() {
        Swal.fire({
            title: 'Keluar Sistem?',
            text: "Anda harus login kembali untuk mengakses data.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e76f51',
            confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
            if (result.isConfirmed) {
                auth.signOut();
            }
        });
    }

    // =========================================
    // 5. INISIALISASI DATA UTAMA (MASTER DATA)
    // =========================================
    async function initApp() {
        showLoader();
        try {
            // Update Tanggal di Header Dashboard
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', dateOptions);
            document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // 1. Load Data Master (Parallel)
            await Promise.all([
                loadMasterMenus(),
                loadMasterLocations()
            ]);

            // 2. Pasang Listeners Realtime
            listenToInbox();       // Data Permintaan (Website 2)
            listenToReservations(); // Data Utama (Website 1)
            
            // 3. Setup Notifikasi Background
            setupNotificationChecker();

        } catch (e) {
            console.error("Init Error:", e);
            showToast("Gagal memuat data awal", "error");
        } finally {
            hideLoader();
        }
    }

    // --- LOAD MENU (MERGED LOGIC) ---
    // Menggabungkan struktur 'price' (Web 2) dan 'details' (Web 1)
    async function loadMasterMenus() {
        return db.collection('menus').get().then(snapshot => {
            detailMenu = {};
            menuPrices = {};
            
            snapshot.forEach(doc => {
                const data = doc.data();
                // Simpan Detail
                detailMenu[doc.id] = data.details || [];
                // Simpan Harga (Default 0 jika null)
                menuPrices[doc.id] = parseInt(data.price) || 0;
            });
            updateMenuPreview(); // Update tampilan di Tab Data
            console.log("Menu Loaded:", Object.keys(detailMenu).length);
        });
    }

    // --- LOAD LOKASI ---
    async function loadMasterLocations() {
        return db.collection('locations').get().then(snapshot => {
            locationsData = {};
            snapshot.forEach(doc => {
                locationsData[doc.id] = {
                    id: doc.id,
                    name: doc.data().name,
                    capacity: parseInt(doc.data().capacity) || 0
                };
            });
            updateLocationPreview(); // Update tampilan di Tab Data
            console.log("Locations Loaded:", Object.keys(locationsData).length);
        });
    }
    
    // --- UI UPDATERS UNTUK TAB DATA MASTER ---
    function updateMenuPreview() {
        const container = document.getElementById('master-menu-preview');
        const keys = Object.keys(detailMenu).sort().slice(0, 5); // Ambil 5 teratas
        
        if(keys.length === 0) {
            container.innerHTML = '<p class="text-muted">Belum ada data menu.</p>';
            return;
        }

        let html = '<ul style="padding-left: 20px; color: #555; margin-top:0;">';
        keys.forEach(k => {
            html += `<li><b>${k}</b> - Rp ${formatMoney(menuPrices[k])}</li>`;
        });
        html += '</ul>';
        if(Object.keys(detailMenu).length > 5) {
            html += `<small style="display:block; margin-top:5px; color:var(--primary);">+ ${Object.keys(detailMenu).length - 5} menu lainnya...</small>`;
        }
        container.innerHTML = html;
    }

    function updateLocationPreview() {
        const container = document.getElementById('master-location-preview');
        const locs = Object.values(locationsData).sort((a,b) => a.name.localeCompare(b.name)).slice(0, 5);
        
        if(locs.length === 0) {
            container.innerHTML = '<p class="text-muted">Belum ada data lokasi.</p>';
            return;
        }

        let html = '<ul style="padding-left: 20px; color: #555; margin-top:0;">';
        locs.forEach(l => {
            html += `<li><b>${l.name}</b> (Kap: ${l.capacity})</li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
    }

    // --- TAB NAVIGATION SYSTEM ---
    window.switchTab = function(tabId) {
        // Hide semua section
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        // Show target
        document.getElementById('tab-' + tabId).classList.add('active');
        
        // Update Sidebar Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navItem = document.getElementById('nav-' + tabId);
        if(navItem) navItem.classList.add('active');
        
        // Close sidebar di mobile
        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('mobile-toggle').innerHTML = '<i class="fas fa-bars"></i>';
        }

        // Trigger render khusus jika tab tertentu dibuka
        if (tabId === 'calendar' && !selectedDate) {
            renderCalendar(); // Render ulang grid kalender
        }
        if (tabId === 'analysis') {
            // Render chart jika belum ada
            renderAnalysisChart();
        }
    };

    window.toggleSidebar = function() {
        const sb = document.getElementById('sidebar');
        sb.classList.toggle('open');
        const icon = sb.classList.contains('open') ? 'times' : 'bars';
        document.getElementById('mobile-toggle').innerHTML = `<i class="fas fa-${icon}"></i>`;
    };

</script>
    // =========================================
    // 6. LOGIKA KALENDER & DATA RESERVASI
    // =========================================

    // --- LISTENER REALTIME (Data Utama) ---
    function listenToReservations() {
        // Bersihkan listener lama jika ada (untuk mencegah memory leak saat ganti bulan)
        if (unsubscribeReservations) unsubscribeReservations();

        // Tentukan Range Tanggal (Load bulan ini agar ringan)
        // Kita load H-7 dari awal bulan s/d H+7 akhir bulan untuk cover transisi
        const startOfView = new Date(currentYear, currentMonth, 1);
        const endOfView = new Date(currentYear, currentMonth + 1, 0);
        
        // Convert ke String YYYY-MM-DD
        const startStr = new Date(startOfView.getFullYear(), startOfView.getMonth(), 1).toISOString().split('T')[0];
        const endStr = new Date(endOfView.getFullYear(), endOfView.getMonth() + 1, 7).toISOString().split('T')[0]; // Buffer extra days

        console.log(`Memuat reservasi: ${startStr} s/d ${endStr}`);
        showLoader();

        unsubscribeReservations = db.collection('reservations')
            .where('date', '>=', startStr)
            .where('date', '<=', endStr)
            .onSnapshot(snapshot => {
                reservationsData = {}; // Reset Cache Bulan Ini
                let totalPaxMonth = 0;
                let totalDpMonth = 0;
                let recentList = [];

                snapshot.forEach(doc => {
                    const r = { id: doc.id, ...doc.data() };
                    
                    // Grouping by Date
                    if (!reservationsData[r.date]) reservationsData[r.date] = [];
                    reservationsData[r.date].push(r);
                    
                    // Statistik
                    totalPaxMonth += parseInt(r.jumlah) || 0;
                    totalDpMonth += parseInt(r.dp) || 0;
                    recentList.push(r);
                });

                // Update UI
                renderCalendar();
                updateDashboardStats(snapshot.size, totalPaxMonth, totalDpMonth, recentList);
                
                // Jika sedang membuka tanggal tertentu, refresh view detailnya
                if (selectedDate && document.getElementById('reservation-view-container').style.display === 'block') {
                    renderDailyView(selectedDate);
                }
                
                hideLoader();
            }, error => {
                console.error("Error Reservasi:", error);
                showToast("Gagal memuat data reservasi", "error");
                hideLoader();
            });
    }

    // --- UPDATE STATISTIK DASHBOARD ---
    function updateDashboardStats(count, pax, dp, allList) {
        // Hitung Tamu Hari Ini
        const todayStr = new Date().toISOString().split('T')[0];
        const todayRes = reservationsData[todayStr] || [];
        const todayPax = todayRes.reduce((sum, r) => sum + (parseInt(r.jumlah)||0), 0);

        // Render ke DOM
        document.getElementById('stat-today-pax').textContent = todayPax;
        document.getElementById('stat-month-total').textContent = count;
        document.getElementById('stat-month-dp').textContent = `Rp ${formatMoney(dp)}`;

        // List Reservasi Terbaru (Sort by CreatedAt Desc)
        const recent = allList.sort((a,b) => {
            const timeA = a.createdAt ? a.createdAt.seconds : 0;
            const timeB = b.createdAt ? b.createdAt.seconds : 0;
            return timeB - timeA;
        }).slice(0, 5);

        const listContainer = document.getElementById('recent-reservations-list');
        if (recent.length === 0) {
            listContainer.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">Belum ada reservasi bulan ini.</p>';
        } else {
            listContainer.innerHTML = recent.map(r => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--secondary);">${r.nama}</div>
                        <div style="font-size: 0.8rem; color: #666;">
                            <i class="far fa-calendar"></i> ${r.date} &bull; <i class="far fa-clock"></i> ${r.jam}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge" style="background:var(--primary); color:white; padding:3px 8px; border-radius:10px; font-size:0.75rem;">${r.jumlah} Org</span>
                    </div>
                </div>
            `).join('');
        }
    }

    // --- RENDER GRID KALENDER ---
    function renderCalendar() {
        const grid = document.getElementById('calendar');
        grid.innerHTML = '';
        
        // Header Bulan
        document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const todayStr = new Date().toISOString().split('T')[0];

        // Filler Hari Kosong
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div style="background:transparent;"></div>`;
        }

        // Render Tanggal
        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const list = reservationsData[dateStr] || [];
            const count = list.length;
            const isToday = dateStr === todayStr ? 'today' : '';
            const isSelected = dateStr === selectedDate ? 'selected' : '';

            // Cuplikan Nama (Max 2) untuk ditampilkan di kotak tanggal
            let previewHtml = '';
            list.slice(0, 2).forEach(r => {
                previewHtml += `<div class="cal-event-dot">${r.jam} ${r.nama.split(' ')[0]}</div>`;
            });
            if(count > 2) previewHtml += `<div style="font-size:0.7rem; color:#666; margin-top:2px;">+${count-2} lainnya</div>`;

            const div = document.createElement('div');
            div.className = `cal-day ${isToday} ${isSelected}`;
            div.onclick = () => selectDate(dateStr);
            div.innerHTML = `
                <div class="day-number">${i}</div>
                <div style="width:100%; flex:1;">${previewHtml}</div>
                ${count > 0 ? `<div style="font-weight:700; font-size:0.8rem; color:var(--primary); align-self:flex-end;">${count} Res</div>` : ''}
            `;
            grid.appendChild(div);
        }
    }

    // --- NAVIGASI KALENDER ---
    function navigateMonth(step) {
        currentMonth += step;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        selectedDate = null; // Reset seleksi saat ganti bulan
        
        // Kembali ke tampilan grid utama
        document.getElementById('calendar-main-view').style.display = 'block';
        document.getElementById('reservation-view-container').style.display = 'none';
        
        listenToReservations(); // Load data bulan baru
    }

    function goToToday() {
        currentMonth = new Date().getMonth();
        currentYear = new Date().getFullYear();
        navigateMonth(0);
        showToast("Kembali ke bulan ini");
    }

    // --- VIEW DETAIL HARIAN (RESERVATION VIEW) ---
    function selectDate(dateStr) {
        selectedDate = dateStr;
        renderCalendar(); // Refresh highlight
        
        // Switch View
        document.getElementById('calendar-main-view').style.display = 'none';
        const viewContainer = document.getElementById('reservation-view-container');
        viewContainer.style.display = 'block';
        
        // Set Header Title
        const dateObj = new Date(dateStr);
        const niceDate = dateObj.toLocaleDateString('id-ID', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'});
        document.getElementById('reservation-view-title').innerHTML = `<i class="fas fa-calendar-check"></i> ${niceDate}`;
        
        // Reset Search
        document.getElementById('detailSearchInput').value = '';
        
        // Render List
        renderDailyView(dateStr);
        
        // Scroll ke atas
        document.querySelector('.main-content').scrollTop = 0;
    }

    function kembaliKeKalender() {
        document.getElementById('reservation-view-container').style.display = 'none';
        document.getElementById('calendar-main-view').style.display = 'block';
        selectedDate = null;
        renderCalendar(); // Hapus highlight
    }

    function renderDailyView(dateStr) {
        const container = document.getElementById('reservation-detail-list');
        const list = reservationsData[dateStr] || [];
        
        if (list.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                    <i class="far fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>Belum ada reservasi pada tanggal ini.</p>
                    <button class="btn btn-primary" onclick="showAddForm()"><i class="fas fa-plus"></i> Tambah Sekarang</button>
                </div>`;
            return;
        }

        // Sort berdasarkan Jam
        list.sort((a, b) => a.jam.localeCompare(b.jam));

        container.innerHTML = list.map(r => {
            // Logika Menu (Support Legacy & New Array Format)
            let menuHtml = '';
            let subTotal = 0;
            
            if (Array.isArray(r.menus) && r.menus.length > 0) {
                // Format Baru (Array)
                menuHtml = '<ul style="margin:5px 0; padding-left:20px; color:#555; font-size:0.9rem;">';
                r.menus.forEach(m => {
                    const detail = detailMenu[m.name] || [];
                    const detailStr = detail.length ? `<br><small style="color:#888;">&bull; ${detail.join(', ')}</small>` : '';
                    
                    // Hitung estimasi harga (jika ada di data master)
                    const price = menuPrices[m.name] || 0;
                    subTotal += price * m.quantity;
                    
                    menuHtml += `<li><b>${m.quantity}x ${m.name}</b> ${detailStr}</li>`;
                });
                menuHtml += '</ul>';
            } else if (r.menu) {
                // Format Lama (String)
                const detail = detailMenu[r.menu] || [];
                const detailStr = detail.map(d => `&bull; ${d}`).join('<br>');
                menuHtml = `<div style="font-weight:600; color:#333;">${r.menu}</div><div style="font-size:0.85rem; color:#666; margin-left:10px;">${detailStr}</div>`;
            } else {
                menuHtml = '<span style="color:#999; font-style:italic;">- Tidak ada menu -</span>';
            }

            // Estimasi Tagihan (Jika data harga tersedia)
            let priceInfo = '';
            if (subTotal > 0) {
                priceInfo = `<div style="margin-top:5px; font-weight:600; color:var(--primary);">Est. Total: Rp ${formatMoney(subTotal)}</div>`;
            }

            // Info Lainnya
            const dpInfo = r.dp > 0 ? `<span class="badge" style="background:#dcfce7; color:#166534; padding:3px 8px; border-radius:4px; font-size:0.8rem;"><i class="fas fa-money-bill"></i> DP: Rp ${formatMoney(r.dp)} (${r.tipeDp})</span>` : '';
            const noteInfo = r.tambahan ? `<div style="background:#fffbeb; padding:8px; border-radius:6px; margin-top:8px; font-size:0.85rem; border:1px dashed #fcd34d;"><i class="fas fa-sticky-note" style="color:#d97706;"></i> <b>Note:</b> ${r.tambahan}</div>` : '';

            // Tombol "Terima Kasih" Logic
            let btnThanks = '';
            if (r.nomorHp) {
                if (r.thankYouSent) {
                    btnThanks = `<button class="btn" style="background:#f3f4f6; color:#10b981; padding:6px 12px; font-size:0.8rem;" disabled><i class="fas fa-check-double"></i> Thanks Terkirim</button>`;
                } else {
                    btnThanks = `<button class="btn btn-accent" onclick="sendThankYouMessage('${r.id}', '${r.nama}', '${r.nomorHp}')" style="padding:6px 12px; font-size:0.8rem;"><i class="fas fa-heart"></i> Kirim Thanks</button>`;
                }
            }

            return `
            <div class="reservation-list-item" style="display:block; position:relative;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div>
                        <div style="font-size:1.1rem; font-weight:700; color:var(--secondary);">${r.nama}</div>
                        <div style="color:var(--text-muted); font-size:0.9rem;">
                            <i class="fas fa-phone" style="width:20px;"></i> ${r.nomorHp || '-'}
                        </div>
                    </div>
                    <div style="text-align:right;">
                         <div style="font-size:1.2rem; font-weight:800; color:var(--primary);">${r.jam}</div>
                         <span class="badge" style="background:var(--secondary); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem;">${r.tempat}</span>
                         <div style="font-size:0.85rem; margin-top:2px;">${r.jumlah} Orang</div>
                    </div>
                </div>
                
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                
                <div style="margin-bottom:10px;">
                    <div style="font-size:0.85rem; font-weight:600; color:#888; text-transform:uppercase;">Pesanan Menu</div>
                    ${menuHtml}
                    ${priceInfo}
                </div>

                <div style="margin-bottom:15px;">
                    ${dpInfo}
                    ${noteInfo}
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    ${r.nomorHp ? `<button class="btn btn-whatsapp" onclick="contactViaWhatsApp('${r.id}')" style="padding:6px 12px; font-size:0.8rem;"><i class="fab fa-whatsapp"></i> Chat</button>` : ''}
                    ${btnThanks}
                    <div style="flex-grow:1;"></div>
                    <button class="btn btn-primary" onclick="editReservasi('${r.id}')" style="padding:6px 12px; font-size:0.8rem;"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn btn-danger" onclick="hapusReservasi('${r.id}')" style="padding:6px 12px; font-size:0.8rem;"><i class="fas fa-trash"></i> Hapus</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- FITUR PENCARIAN & SORTING ---
    function filterReservations(query) {
        if (!selectedDate) return;
        const q = query.toLowerCase();
        const list = reservationsData[selectedDate] || [];
        
        // Filter logic yang kuat (mencari sampai ke dalam nama menu)
        const filtered = list.filter(r => 
            (r.nama && r.nama.toLowerCase().includes(q)) || 
            (r.tempat && r.tempat.toLowerCase().includes(q)) ||
            (r.menu && r.menu.toLowerCase().includes(q)) ||
            (Array.isArray(r.menus) && r.menus.some(m => m.name.toLowerCase().includes(q)))
        );
        
        // Render manual hasil filter (bypass cache render)
        // Kita simpan hasil filter sementara di properti DOM agar tidak merusak cache data asli
        const container = document.getElementById('reservation-detail-list');
        
        // Hack: Menggunakan fungsi renderDailyView tapi memanipulasi data sementara
        // Cara lebih bersih: Render manual HTMLnya
        if (filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Tidak ditemukan hasil pencarian.</p>';
        } else {
            // Reuse logic render item, tapi karena fungsi renderDailyView bergantung pada reservationsData,
            // kita buat object dummy sementara.
            const tempDate = 'temp-search';
            reservationsData[tempDate] = filtered;
            renderDailyView(tempDate);
            delete reservationsData[tempDate];
        }
    }

    // =========================================
    // 7. CRUD FUNCTIONS (TAMBAH, EDIT, HAPUS)
    // =========================================

    // --- ADD RESERVATION ---
    function showAddForm() {
        const form = document.getElementById('reservation-form');
        form.reset();
        
        // Set Default: Tanggal terpilih (jika ada) atau Hari ini
        // Note: Form popup kita tidak ada input tanggal, karena tanggal ikut Calendar View.
        // Tapi kita bisa tambahkan hidden input atau asumsikan `selectedDate`.
        
        if (!selectedDate) {
            showToast("Pilih tanggal di kalender dulu!", "warning");
            return;
        }

        // Reset Menu Rows
        document.getElementById('selected-menus-container').innerHTML = '';
        addMenuSelectionRow('reservation-form');
        
        // Populate Dropdown Tempat
        populateLocationDropdown(document.querySelector('#reservation-form #tempat'));
        
        document.getElementById('addFormPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    async function simpanReservasi() {
        // Validasi Form
        const formData = validateReservationForm('reservation-form');
        if (!formData) return;

        // Tambahkan Tanggal dari View Kalender
        formData.date = selectedDate;
        formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        formData.thankYouSent = false;

        showLoader();
        try {
            await db.collection('reservations').add(formData);
            showToast("Reservasi Berhasil Disimpan!");
            closePopup('addFormPopup');
        } catch (e) {
            console.error(e);
            showToast("Gagal menyimpan: " + e.message, "error");
        } finally {
            hideLoader();
        }
    }

    // --- DELETE RESERVATION ---
    async function hapusReservasi(id) {
        Swal.fire({
            title: 'Hapus Reservasi?',
            text: "Data tidak bisa dikembalikan!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Hapus!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                showLoader();
                try {
                    await db.collection('reservations').doc(id).delete();
                    showToast("Data dihapus.", "success");
                } catch (e) {
                    showToast("Gagal menghapus.", "error");
                } finally {
                    hideLoader();
                }
            }
        });
    }

    // --- FORM VALIDATION HELPER ---
    function validateReservationForm(formId) {
        const form = document.getElementById(formId);
        const name = form.querySelector('#nama').value.trim();
        const hp = form.querySelector('#nomorHp').value;
        const jam = form.querySelector('#jam').value;
        const jumlah = parseInt(form.querySelector('#jumlah').value);
        const tempat = form.querySelector('#tempat').value;
        const dp = parseInt(form.querySelector('#dp').value) || 0;
        const tipeDp = form.querySelector('#tipeDp').value;
        const tambahan = form.querySelector('#tambahan').value;

        // Reset Errors
        form.querySelectorAll('.error-message').forEach(e => e.textContent = '');

        let isValid = true;
        if (!name) { document.querySelector(`#${formId} #nama-error`).textContent = 'Wajib diisi'; isValid = false; }
        if (!jam) { document.querySelector(`#${formId} #jam-error`).textContent = 'Wajib diisi'; isValid = false; }
        if (isNaN(jumlah) || jumlah < 1) { document.querySelector(`#${formId} #jumlah-error`).textContent = 'Min 1 org'; isValid = false; }
        if (!tempat) { document.querySelector(`#${formId} #tempat-error`).textContent = 'Pilih tempat'; isValid = false; }

        // Validasi Kapasitas
        if (tempat && locationsData) {
            // Cari object lokasi berdasarkan nama (agak tricky karena key kita ID, value di select nama)
            // Jadi kita cari match by Name
            const locKey = Object.keys(locationsData).find(k => locationsData[k].name === tempat);
            if (locKey) {
                const cap = locationsData[locKey].capacity;
                if (jumlah > cap) {
                     document.querySelector(`#${formId} #jumlah-error`).textContent = `Maks ${cap} org untuk ${tempat}`;
                     isValid = false;
                }
            }
        }

        // Get Menus
        const menus = [];
        const menuRows = form.querySelectorAll('.menu-selection-row');
        const selectedNames = new Set();
        
        if (menuRows.length === 0) {
             document.querySelector(`#${formId} #menus-error`).textContent = '(Min 1 menu)';
             isValid = false;
        }

        menuRows.forEach(row => {
            const mName = row.querySelector('select').value;
            const mQty = parseInt(row.querySelector('input').value);
            if (mName && mQty > 0) {
                if(selectedNames.has(mName)) {
                     document.querySelector(`#${formId} #menus-error`).textContent = '(Menu duplikat)';
                     isValid = false;
                }
                selectedNames.add(mName);
                menus.push({ name: mName, quantity: mQty });
            } else {
                 // Jika row kosong tidak valid
                 document.querySelector(`#${formId} #menus-error`).textContent = '(Lengkapi menu)';
                 isValid = false;
            }
        });

        if (!isValid) return null;

        return {
            nama: name,
            nomorHp: cleanPhoneNumber(hp),
            jam: jam,
            jumlah: jumlah,
            tempat: tempat,
            dp: dp,
            tipeDp: tipeDp,
            tambahan: tambahan,
            menus: menus
        };
    }
    // =========================================
    // 8. LOGIKA INBOX & PERMINTAAN (WEBSITE 2)
    // =========================================

    function listenToInbox() {
        // Bersihkan listener lama
        if (unsubscribeRequests) unsubscribeRequests();

        unsubscribeRequests = db.collection('reservation_requests')
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                requestsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateInboxUI();
            }, error => {
                console.error("Error Inbox:", error);
            });
    }

    function updateInboxUI() {
        const count = requestsCache.length;
        const container = document.getElementById('inbox-container');
        const badge = document.getElementById('sidebar-badge');
        const statPending = document.getElementById('stat-pending');

        // Update Badges
        if (badge) {
            badge.style.display = count > 0 ? 'inline-block' : 'none';
            badge.textContent = count;
        }
        if (statPending) statPending.textContent = count;

        // Render UI
        if (count === 0) {
            container.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#999;">
                    <i class="fas fa-inbox fa-3x" style="opacity:0.3; margin-bottom:15px;"></i>
                    <p>Tidak ada permintaan baru saat ini.</p>
                </div>`;
            return;
        }

        container.innerHTML = requestsCache.map(r => {
            // Format Menu
            let menuHtml = '<span style="color:#999; font-style:italic;">Tidak ada menu</span>';
            if (r.menus && r.menus.length > 0) {
                menuHtml = r.menus.map(m => `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:2px 0;">
                        <span><b>${m.quantity}x</b> ${m.name}</span>
                    </div>`).join('');
            }

            return `
            <div class="request-card">
                <div class="request-header">
                    <span class="req-name">${r.nama}</span>
                    <span class="req-via">${r.via || 'Web'}</span>
                </div>
                
                <div class="req-details">
                    <div style="display:flex; gap:15px; margin-bottom:5px;">
                        <span><i class="fas fa-calendar-alt"></i> ${r.date}</span>
                        <span><i class="fas fa-clock"></i> ${r.jam}</span>
                    </div>
                    <div style="display:flex; gap:15px;">
                        <span><i class="fas fa-users"></i> ${r.jumlah} Org</span>
                        <span><i class="fas fa-map-marker-alt"></i> ${r.tempat}</span>
                    </div>
                </div>

                <div class="req-menu-box">
                    ${menuHtml}
                </div>
                
                ${r.tambahan ? `<div style="font-size:0.85rem; color:#d97706; background:#fffbeb; padding:8px; border-radius:4px; margin-bottom:10px;"><i class="fas fa-sticky-note"></i> <b>Note:</b> ${r.tambahan}</div>` : ''}
                
                <div class="req-actions">
                    <button class="btn btn-whatsapp" onclick="prepareConfirmationChat('${r.id}')"><i class="fab fa-whatsapp"></i> Chat Konfirmasi</button>
                    <button class="btn btn-danger" onclick="rejectRequest('${r.id}')"><i class="fas fa-times"></i> Tolak</button>
                    <button class="btn btn-success" onclick="approveRequest('${r.id}')"><i class="fas fa-check"></i> Terima</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- INTEGRASI WHATSAPP SMART (KALKULASI HARGA) ---
    function prepareConfirmationChat(id) {
        const r = requestsCache.find(item => item.id === id);
        if (!r) return;

        // 1. Kalkulasi Biaya (Menggunakan data harga dari Menu Master)
        let totalFood = 0;
        let orderSummary = "";

        if (r.menus && r.menus.length > 0) {
            r.menus.forEach(m => {
                // Ambil harga dari cache global (Data Master)
                const unitPrice = menuPrices[m.name] || 0;
                const sub = unitPrice * m.quantity;
                totalFood += sub;
                
                // Format text untuk WA
                orderSummary += `- ${m.name} (${m.quantity}x)`;
                if (unitPrice > 0) orderSummary += ` : Rp ${formatMoney(sub)}`;
                orderSummary += `\n`;
            });
        }

        let ppn = totalFood * 0.1; // PPN 10%
        let grandTotal = totalFood + ppn;
        let dp = grandTotal * 0.5; // DP 50%

        // 2. Format Pesan WhatsApp (Sesuai Website 2)
        let msg = `Halo Kak *${r.nama}* üëã,\n` +
            `Terima kasih telah melakukan reservasi di *Dolan Sawah*.\n\n` +
            `Berikut detail pesanan Anda:\n` +
            `üóì Tanggal: ${r.date}\n` +
            `‚è∞ Jam: ${r.jam}\n` +
            `üë• Jumlah: ${r.jumlah} Orang\n` +
            `üìç Tempat: ${r.tempat}\n\n`;

        if (orderSummary) {
            msg += `*Rincian Pesanan:*\n${orderSummary}` +
            `----------------------------------\n` +
            `Subtotal: Rp ${formatMoney(totalFood)}\n` +
            `PPN (10%): Rp ${formatMoney(ppn)}\n` +
            `*Total Tagihan: Rp ${formatMoney(grandTotal)}*\n\n`;
        }

        msg += `----------------------------------\n` +
            `Untuk konfirmasi, mohon melakukan pembayaran *DP (50%)* sebesar:\n` +
            `üëâ *Rp ${formatMoney(dp)}*\n\n` +
            `Silakan transfer ke salah satu rekening berikut:\n\n` +
            `*Rekening Dolan Sawah*\n\n` +
            `‚úÖ *BCA: 0132021439*\n` +
            `‚úÖ *Mandiri: 1360034582244*\n` +
            `‚úÖ *BRI: 008101001911567*\n` +
            `A/n Oktavianus Dwi Wahyu Widyanarka\n\n` +
            `Mohon kirimkan bukti transfer ini untuk kami proses approve ‚úÖ. Terima kasih!`;

        // 3. Buka WhatsApp
        openWhatsApp(r.nomorHp, msg);
    }

    // --- GENERIC WHATSAPP HELPER ---
    function openWhatsApp(phone, message) {
        if (!phone) { showToast('Nomor HP tidak tersedia', 'error'); return; }
        const p = cleanPhoneNumber(phone);
        window.open(`https://wa.me/${p}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    // Fungsi untuk tombol "Chat" biasa di list reservasi
    function contactViaWhatsApp(id) {
        // Cari di reservation data
        let res = null;
        // Kita cari manual di object cache
        Object.values(reservationsData).forEach(list => {
            const found = list.find(r => r.id === id);
            if (found) res = found;
        });

        if (!res) return;

        const msg = `Halo Kak *${res.nama}*, kami dari Dolan Sawah ingin mengkonfirmasi reservasi Kakak pada tanggal ${res.date} jam ${res.jam}. Apakah ada perubahan rencana? Terima kasih.`;
        openWhatsApp(res.nomorHp, msg);
    }

    // --- APPROVE & REJECT LOGIC ---
    async function approveRequest(id) {
        const req = requestsCache.find(r => r.id === id);
        if (!req) return;

        // Tanya Detail DP via SweetAlert
        const { value: formValues } = await Swal.fire({
            title: `Terima Reservasi: ${req.nama}`,
            html: `
                <p style="font-size:0.9rem; color:#666;">Masukkan nominal DP yang diterima (jika ada).</p>
                <input id="swal-input-dp" type="number" class="swal2-input" placeholder="Nominal DP (Rp)">
                <select id="swal-input-type" class="swal2-select" style="display:block; width:80%; margin:10px auto;">
                    <option value="">- Metode Pembayaran -</option>
                    <option value="Transfer BCA">Transfer BCA</option>
                    <option value="Transfer Mandiri">Transfer Mandiri</option>
                    <option value="Transfer BRI">Transfer BRI</option>
                    <option value="QRIS">QRIS</option>
                    <option value="Cash">Cash</option>
                </select>`,
            showCancelButton: true,
            confirmButtonColor: 'var(--success)',
            confirmButtonText: '<i class="fas fa-check"></i> Simpan & Terima',
            preConfirm: () => {
                return {
                    dp: document.getElementById('swal-input-dp').value,
                    tipeDp: document.getElementById('swal-input-type').value
                }
            }
        });

        if (formValues) {
            showLoader();
            try {
                // 1. Siapkan Data Reservasi Baru
                const newData = {
                    nama: req.nama,
                    nomorHp: cleanPhoneNumber(req.nomorHp),
                    date: req.date,
                    jam: req.jam,
                    jumlah: parseInt(req.jumlah),
                    tempat: req.tempat,
                    menus: req.menus || [],
                    tambahan: req.tambahan || '',
                    dp: parseInt(formValues.dp) || 0,
                    tipeDp: formValues.tipeDp,
                    via: 'Web Request',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    thankYouSent: false
                };

                // 2. Simpan ke Collection Utama
                await db.collection('reservations').add(newData);
                
                // 3. Hapus dari Inbox Permintaan
                await db.collection('reservation_requests').doc(id).delete();
                
                showToast(`Reservasi ${req.nama} berhasil disetujui!`);
                
                // 4. Arahkan Admin ke Kalender Tanggal Tersebut (UX Bagus)
                // Kita set variable global bulan ke bulan request
                const reqDate = new Date(req.date);
                currentMonth = reqDate.getMonth();
                currentYear = reqDate.getFullYear();
                
                switchTab('calendar');
                selectDate(req.date); // Buka detail harian otomatis

            } catch (e) {
                console.error(e);
                showToast("Gagal memproses: " + e.message, "error");
            } finally {
                hideLoader();
            }
        }
    }

    async function rejectRequest(id) {
        Swal.fire({
            title: 'Tolak Permintaan?',
            text: "Data akan dihapus permanen dari inbox.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Tolak',
            cancelButtonText: 'Batal'
        }).then(async (result) => {
            if (result.isConfirmed) {
                showLoader();
                try {
                    await db.collection('reservation_requests').doc(id).delete();
                    showToast('Permintaan ditolak dan dihapus.', 'success');
                } catch (e) {
                    showToast('Gagal menghapus.', 'error');
                } finally {
                    hideLoader();
                }
            }
        });
    }
    // =========================================
    // 9. HELPER UI (FORMULIR DINAMIS)
    // =========================================

    // --- POPULATE LOCATION DROPDOWN ---
    function populateLocationDropdown(selectElement, selectedValue = '') {
        if (!selectElement) return;
        selectElement.innerHTML = '<option value="">-- Pilih Tempat --</option>';
        
        // Convert object ke array dan sort berdasarkan nama
        Object.values(locationsData)
            .sort((a,b) => a.name.localeCompare(b.name))
            .forEach(loc => {
                const option = new Option(`${loc.name} (Kap: ${loc.capacity})`, loc.name);
                selectElement.add(option);
            });
            
        if (selectedValue) selectElement.value = selectedValue;
    }
    
    // --- INFO KAPASITAS LIVE ---
    function updateCapacityInfo(formId) {
        const form = document.getElementById(formId);
        const selectElement = form.querySelector('#tempat');
        const infoElement = form.querySelector('#capacity-info');
        
        const selectedName = selectElement.value;
        // Cari lokasi berdasarkan nama
        const loc = Object.values(locationsData).find(l => l.name === selectedName);
        
        if (loc) {
            infoElement.textContent = `Max: ${loc.capacity} Orang`;
            infoElement.style.color = 'var(--info)';
        } else {
            infoElement.textContent = '';
        }
    }

    // --- MULTI-ROW MENU SELECTION ---
    function addMenuSelectionRow(formId, menuName = '', quantity = 1) {
      const container = document.querySelector(`#${formId} #selected-menus-container`);
      const rowId = 'menu-row-' + Date.now() + Math.random();
      
      const newRow = document.createElement('div');
      newRow.className = 'menu-selection-row';
      newRow.style.display = 'flex';
      newRow.style.gap = '10px';
      newRow.style.marginBottom = '8px';
      newRow.id = rowId;
      
      // Generate Options Menu
      const menuOptions = Object.keys(detailMenu).sort().map(name => {
          const price = menuPrices[name] ? `(Rp ${formatMoney(menuPrices[name])})` : '';
          const selected = name === menuName ? 'selected' : '';
          return `<option value="${name}" ${selected}>${name} ${price}</option>`;
      }).join('');
      
      newRow.innerHTML = `
        <select class="menu-select" style="flex:3; margin:0;">
            <option value="">-- Pilih Menu --</option>
            ${menuOptions}
        </select>
        <input type="number" class="quantity-input" value="${quantity}" min="1" placeholder="Jml" style="flex:1; margin:0;">
        <button type="button" class="btn btn-danger" onclick="document.getElementById('${rowId}').remove()" style="padding:0 10px;">
            <i class="fas fa-trash-alt"></i>
        </button>`;
      
      container.appendChild(newRow);
    }

    // =========================================
    // 10. LOGIKA EDIT RESERVASI
    // =========================================

    function editReservasi(id) {
        // Cari data reservasi di cache
        let res = null;
        Object.values(reservationsData).forEach(list => {
            const found = list.find(r => r.id === id);
            if (found) res = found;
        });

        if (!res) { showToast("Data tidak ditemukan di cache bulan ini.", "error"); return; }

        // Render Form Edit secara Dinamis ke dalam Popup Kosong
        const popup = document.getElementById('editFormPopup');
        popup.innerHTML = `
            <span class="close-btn" onclick="closePopup('editFormPopup')"><i class="fas fa-times"></i></span>
            <h3><i class="fas fa-edit" style="color:var(--primary);"></i> Edit Reservasi</h3>
            
            <form id="edit-reservation-form">
                <input type="hidden" id="editReservationId" value="${id}" />
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label>Nama</label><input type="text" id="nama" value="${res.nama}" required /><span class="error-message" id="nama-error"></span></div>
                    <div><label>Nomor HP</label><input type="tel" id="nomorHp" value="${res.nomorHp || ''}" /><span class="error-message" id="nomorHp-error"></span></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label>Jam</label><input type="time" id="jam" value="${res.jam}" required /><span class="error-message" id="jam-error"></span></div>
                    <div><label>Jumlah</label><input type="number" id="jumlah" value="${res.jumlah}" min="1" required /><span class="error-message" id="jumlah-error"></span></div>
                </div>

                <div>
                    <label>Tempat</label>
                    <select id="tempat" required onchange="updateCapacityInfo('edit-reservation-form')"></select>
                    <small id="capacity-info" style="color:var(--info); font-weight:600;"></small>
                    <span class="error-message" id="tempat-error"></span>
                </div>

                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin: 15px 0;">
                    <label>Paket Menu <span class="error-message" id="menus-error"></span></label>
                    <div id="selected-menus-container" style="margin-bottom: 10px;"></div>
                    <button type="button" class="btn btn-secondary" onclick="addMenuSelectionRow('edit-reservation-form')" style="width:100%; justify-content:center; font-size:0.85rem;"><i class="fas fa-plus"></i> Tambah Item</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label>DP (Rp)</label><input type="number" id="dp" value="${res.dp || 0}" /></div>
                    <div>
                        <label>Tipe Pembayaran DP</label>
                        <select id="tipeDp">
                          <option value="">- Tanpa DP -</option>
                          <option>Cash</option><option>QRIS</option>
                          <option>Transfer BCA</option><option>Transfer Mandiri</option><option>Transfer BRI</option>
                        </select>
                    </div>
                </div>

                <label>Catatan</label>
                <textarea id="tambahan">${res.tambahan || ''}</textarea>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-primary" onclick="simpanPerubahanReservasi()" style="flex:1;"><i class="fas fa-save"></i> Simpan Perubahan</button>
                </div>
            </form>`;

        // Populate Data Awal
        const formEl = document.getElementById('edit-reservation-form');
        
        // Populate Dropdown Tempat & Set Value
        populateLocationDropdown(formEl.querySelector('#tempat'), res.tempat);
        updateCapacityInfo('edit-reservation-form');
        
        // Set Tipe DP
        formEl.querySelector('#tipeDp').value = res.tipeDp || '';

        // Populate Menu Rows
        // Support Legacy (string) & New (array)
        if (Array.isArray(res.menus) && res.menus.length > 0) {
            res.menus.forEach(m => addMenuSelectionRow('edit-reservation-form', m.name, m.quantity));
        } else if (res.menu) {
            // Legacy data support
            addMenuSelectionRow('edit-reservation-form', res.menu, 1);
        } else {
            addMenuSelectionRow('edit-reservation-form');
        }

        popup.style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    async function simpanPerubahanReservasi() {
        const id = document.getElementById('editReservationId').value;
        const formData = validateReservationForm('edit-reservation-form');
        
        if (!formData) return;

        showLoader();
        try {
            // Kita tidak mengubah field 'createdAt' atau 'thankYouSent' saat edit
            await db.collection('reservations').doc(id).update(formData);
            showToast("Perubahan berhasil disimpan");
            closePopup('editFormPopup');
            
            // Jika tanggal berubah, mungkin perlu refresh kalender manual jika listener belum menangkapnya
            if (formData.date !== selectedDate) {
               // User memindahkan tanggal, jadi kita harus refresh
               // Tapi listener onSnapshot biasanya cukup cepat.
            }
            
        } catch (e) {
            console.error(e);
            showToast("Gagal update: " + e.message, "error");
        } finally {
            hideLoader();
        }
    }


    // =========================================
    // 11. MANAJEMEN DATA MASTER (MENU & LOKASI)
    // =========================================

    // --- A. MANAJEMEN MENU ---
    function showMenuManagement() {
        const popup = document.getElementById('menuManagementPopup');
        
        // Generate List Menu
        const listHtml = Object.keys(detailMenu).sort().map(name => {
            const price = menuPrices[name] || 0;
            const details = detailMenu[name].join(', ');
            return `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                <div>
                    <div style="font-weight:600;">${name}</div>
                    <div style="font-size:0.85rem; color:var(--primary);">Rp ${formatMoney(price)}</div>
                    <div style="font-size:0.8rem; color:#888;">${details}</div>
                </div>
                <div>
                    <button class="btn btn-danger" onclick="deleteMenu('${name}')" style="padding:5px 10px;"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');

        popup.innerHTML = `
            <span class="close-btn" onclick="closePopup('menuManagementPopup')"><i class="fas fa-times"></i></span>
            <h3><i class="fas fa-utensils"></i> Kelola Menu</h3>
            
            <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h4 style="margin-top:0;">Tambah / Update Menu</h4>
                <input type="text" id="newMenuName" placeholder="Nama Menu (Contoh: Nasi Goreng)" />
                <input type="number" id="newMenuPrice" placeholder="Harga Satuan (Rp)" />
                <textarea id="newMenuDetails" placeholder="Detail Menu (pisahkan dengan koma). Contoh: Nasi, Telur, Kerupuk"></textarea>
                <button class="btn btn-primary" onclick="addNewMenu()" style="width:100%; justify-content:center;">Simpan Menu</button>
            </div>

            <div style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">
                ${listHtml}
            </div>
        `;
        popup.style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    async function addNewMenu() {
        const name = document.getElementById('newMenuName').value.trim();
        const price = parseInt(document.getElementById('newMenuPrice').value) || 0;
        const detailsRaw = document.getElementById('newMenuDetails').value;
        
        if(!name) { showToast("Nama menu wajib diisi", "error"); return; }
        
        const details = detailsRaw.split(',').map(s => s.trim()).filter(Boolean);
        
        showLoader();
        try {
            await db.collection('menus').doc(name).set({
                price: price,
                details: details
            });
            showToast("Menu berhasil disimpan");
            
            // Reload Master Data Locally
            await loadMasterMenus();
            showMenuManagement(); // Refresh popup
            
        } catch(e) {
            showToast("Gagal: " + e.message, "error");
        } finally {
            hideLoader();
        }
    }

    async function deleteMenu(name) {
        if(!confirm(`Hapus menu "${name}"?`)) return;
        showLoader();
        try {
            await db.collection('menus').doc(name).delete();
            showToast("Menu dihapus");
            await loadMasterMenus();
            showMenuManagement(); 
        } catch(e) { showToast("Gagal hapus", "error"); } finally { hideLoader(); }
    }


    // --- B. MANAJEMEN LOKASI ---
    function showLocationManagement() {
        const popup = document.getElementById('locationManagementPopup');
        
        const listHtml = Object.values(locationsData)
            .sort((a,b) => a.name.localeCompare(b.name))
            .map(loc => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                <div>
                    <div style="font-weight:600;">${loc.name}</div>
                    <div style="font-size:0.85rem; color:#666;">Kapasitas: ${loc.capacity} Orang</div>
                </div>
                <div>
                    <button class="btn btn-danger" onclick="deleteLocation('${loc.id}')" style="padding:5px 10px;"><i class="fas fa-trash"></i></button>
                </div>
            </div>`).join('');

        popup.innerHTML = `
            <span class="close-btn" onclick="closePopup('locationManagementPopup')"><i class="fas fa-times"></i></span>
            <h3><i class="fas fa-chair"></i> Kelola Tempat</h3>
            
            <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h4 style="margin-top:0;">Tambah Tempat</h4>
                <input type="text" id="newLocName" placeholder="Nama Tempat (Contoh: Gazebo 1)" />
                <input type="number" id="newLocCap" placeholder="Kapasitas (Orang)" />
                <button class="btn btn-primary" onclick="addNewLocation()" style="width:100%; justify-content:center;">Simpan Tempat</button>
            </div>

            <div style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">
                ${listHtml}
            </div>
        `;
        popup.style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    async function addNewLocation() {
        const name = document.getElementById('newLocName').value.trim();
        const cap = parseInt(document.getElementById('newLocCap').value);
        
        if(!name || !cap) { showToast("Data tidak lengkap", "error"); return; }
        
        showLoader();
        try {
            await db.collection('locations').add({
                name: name,
                capacity: cap
            });
            showToast("Tempat berhasil ditambahkan");
            await loadMasterLocations();
            showLocationManagement();
        } catch(e) { showToast("Gagal: "+e.message, "error"); } finally { hideLoader(); }
    }

    async function deleteLocation(id) {
        if(!confirm("Hapus tempat ini?")) return;
        showLoader();
        try {
            await db.collection('locations').doc(id).delete();
            showToast("Tempat dihapus");
            await loadMasterLocations();
            showLocationManagement();
        } catch(e) { showToast("Gagal", "error"); } finally { hideLoader(); }
    }
    // =========================================
    // 12. CUSTOMER DATABASE & BROADCAST
    // =========================================

    // --- CUSTOMER LIST (Database Pelanggan) ---
    async function showCustomerMenu() {
        showLoader();
        try {
            // Ambil data reservasi lama untuk mendapatkan database pelanggan
            // Limit 1000 agar tidak terlalu berat
            const snapshot = await db.collection('reservations')
                .orderBy('createdAt', 'desc')
                .limit(1000)
                .get();

            const customers = new Map();
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.nomorHp && data.nama) {
                    const phone = cleanPhoneNumber(data.nomorHp);
                    // Gunakan HP sebagai key untuk mencegah duplikat
                    if (!customers.has(phone)) {
                        customers.set(phone, { name: data.nama, phone: phone });
                    }
                }
            });

            // Render ke Popup
            const container = document.getElementById('customerListPopup');
            let listHtml = '';
            
            customers.forEach(c => {
                listHtml += `
                <div class="customer-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                    <div>
                        <div style="font-weight:600;">${c.name}</div>
                        <div style="font-size:0.85rem; color:#666;">${c.phone}</div>
                    </div>
                    <button class="btn btn-whatsapp" onclick="openWhatsApp('${c.phone}', 'Halo Kak ${c.name}, kami dari Dolan Sawah...')" style="padding:5px 10px; font-size:0.8rem;">
                        <i class="fab fa-whatsapp"></i> Chat
                    </button>
                </div>`;
            });

            container.innerHTML = `
                <span class="close-btn" onclick="closePopup('customerListPopup')"><i class="fas fa-times"></i></span>
                <h3><i class="fas fa-address-book"></i> Database Pelanggan (${customers.size})</h3>
                <input type="text" placeholder="Cari nama atau nomor HP..." oninput="filterCustomerList(this.value)" style="margin-bottom:15px;">
                <div id="customer-list-scroll" style="height:65vh; overflow-y:auto;">${listHtml}</div>
            `;
            
            // Helper function pencarian lokal (disisipkan ke window)
            window.filterCustomerList = (query) => {
                const q = query.toLowerCase();
                const items = document.querySelectorAll('.customer-item');
                items.forEach(item => {
                    const text = item.innerText.toLowerCase();
                    item.style.display = text.includes(q) ? 'flex' : 'none';
                });
            };

            document.getElementById('customerListPopup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';

        } catch (e) {
            showToast("Gagal memuat pelanggan", "error");
        } finally {
            hideLoader();
        }
    }

    // --- BROADCAST SYSTEM ---
    function showBroadcastMain() {
        document.getElementById('broadcastMainPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function showBroadcastSettings() {
        closePopup('broadcastMainPopup');
        // Load pesan tersimpan
        const savedMsg = localStorage.getItem('broadcast_msg') || '';
        document.getElementById('broadcastMessage').value = savedMsg;
        
        document.getElementById('broadcastSettingsPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function saveBroadcastMessage() {
        const msg = document.getElementById('broadcastMessage').value;
        localStorage.setItem('broadcast_msg', msg);
        showToast("Pesan broadcast tersimpan");
        closePopup('broadcastSettingsPopup');
        showBroadcastMain();
    }

    async function showBroadcastList() {
        const msg = localStorage.getItem('broadcast_msg');
        if (!msg) {
            showToast("Atur pesan dulu!", "warning");
            return;
        }

        closePopup('broadcastMainPopup');
        showLoader();

        // Re-use logic fetch customer (mirip showCustomerMenu tapi UI beda)
        try {
            const snapshot = await db.collection('reservations').orderBy('createdAt', 'desc').limit(500).get();
            const customers = new Map();
            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.nomorHp) customers.set(cleanPhoneNumber(d.nomorHp), d.nama);
            });

            const container = document.getElementById('broadcast-customer-list');
            let html = '';
            customers.forEach((name, phone) => {
                html += `
                <div class="broadcast-item" style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                    <div><b>${name}</b><br><small>${phone}</small></div>
                    <button class="btn btn-success" id="btn-bc-${phone}" onclick="sendBroadcast('${phone}', '${name}', 'btn-bc-${phone}')" style="font-size:0.8rem; padding:4px 10px;">
                        <i class="fab fa-whatsapp"></i> Kirim
                    </button>
                </div>`;
            });
            container.innerHTML = html;

            document.getElementById('broadcastListPopup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        } finally {
            hideLoader();
        }
    }

    window.filterBroadcastCustomers = (query) => {
        const q = query.toLowerCase();
        document.querySelectorAll('.broadcast-item').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    };

    window.sendBroadcast = (phone, name, btnId) => {
        let msg = localStorage.getItem('broadcast_msg') || '';
        // Personalization logic
        const greeting = `Halo Kak *${name}*,\n\n`;
        const fullMsg = greeting + msg;
        
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(fullMsg)}`, '_blank');
        
        // Tandai sudah terkirim di UI
        const btn = document.getElementById(btnId);
        btn.innerHTML = '<i class="fas fa-check"></i> Terkirim';
        btn.className = 'btn btn-secondary';
        btn.disabled = true;
    };

    // =========================================
    // 13. PRINT & EXPORT SYSTEM
    // =========================================

    function printData() {
        if (!selectedDate) return;
        document.getElementById('printOptionsPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function executePrint() {
        const list = reservationsData[selectedDate] || [];
        if (list.length === 0) return;

        // Opsi
        const showMenu = document.getElementById('print-detail-menu').checked;
        const showKontak = document.getElementById('print-kontak').checked;
        const showDp = document.getElementById('print-dp').checked;
        const showNotes = document.getElementById('print-tambahan').checked;

        // Sort by Jam
        list.sort((a,b) => a.jam.localeCompare(b.jam));

        let rows = list.map((r, i) => {
            let menuTxt = '';
            if (showMenu) {
                if (Array.isArray(r.menus)) {
                    menuTxt = r.menus.map(m => `${m.quantity}x ${m.name}`).join('<br>');
                } else {
                    menuTxt = r.menu || '-';
                }
            }
            
            return `
            <tr style="border-bottom:1px solid #ccc;">
                <td style="padding:8px;">${i+1}</td>
                <td style="padding:8px;">${r.jam}</td>
                <td style="padding:8px;">${r.nama} ${showKontak ? `<br><small>${r.nomorHp}</small>` : ''}</td>
                <td style="padding:8px;">${r.jumlah} Org</td>
                <td style="padding:8px;">${r.tempat}</td>
                ${showMenu ? `<td style="padding:8px; font-size:0.9rem;">${menuTxt}</td>` : ''}
                ${showDp ? `<td style="padding:8px;">Rp ${formatMoney(r.dp)}</td>` : ''}
                ${showNotes ? `<td style="padding:8px; font-style:italic;">${r.tambahan || '-'}</td>` : ''}
            </tr>`;
        }).join('');

        // HTML Header Table
        let thead = `
            <tr>
                <th style="text-align:left; padding:8px; background:#eee;">No</th>
                <th style="text-align:left; padding:8px; background:#eee;">Jam</th>
                <th style="text-align:left; padding:8px; background:#eee;">Nama</th>
                <th style="text-align:left; padding:8px; background:#eee;">Pax</th>
                <th style="text-align:left; padding:8px; background:#eee;">Tempat</th>
                ${showMenu ? `<th style="text-align:left; padding:8px; background:#eee;">Menu</th>` : ''}
                ${showDp ? `<th style="text-align:left; padding:8px; background:#eee;">DP</th>` : ''}
                ${showNotes ? `<th style="text-align:left; padding:8px; background:#eee;">Notes</th>` : ''}
            </tr>
        `;

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(`
            <html>
            <head><title>Cetak Reservasi - ${selectedDate}</title>
            <style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd;}</style>
            </head>
            <body>
                <h2 style="text-align:center; margin-bottom:5px;">Laporan Reservasi Dolan Sawah</h2>
                <p style="text-align:center; margin-top:0;">Tanggal: ${selectedDate}</p>
                <table>${thead}<tbody>${rows}</tbody></table>
                <script>window.print();window.close();<\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
        closePopup('printOptionsPopup');
    }

    // --- COPY CODE EXPORT (Untuk Viewer) ---
    function copyExportCode() {
        const output = document.getElementById('export-data-output');
        
        // Buat data simple
        const exportData = {
            date: new Date().toISOString(),
            reservations: reservationsData // Export data bulan ini
        };
        
        output.value = btoa(JSON.stringify(exportData));
        output.select();
        document.execCommand('copy');
        showToast("Kode berhasil disalin!");
    }

    // =========================================
    // 14. ANALISIS GRAFIK (CHART.JS)
    // =========================================
    let myChart = null;

    function renderAnalysisChart() {
        const ctx = document.getElementById('mainChartCanvas').getContext('2d');
        
        // Data Dummy / Kalkulasi Realtime dari Cache Bulan Ini
        // Idealnya fetch aggregate setahun, tapi untuk demo kita pakai data bulan ini per tanggal
        
        const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
        const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
        const dataPax = new Array(daysInMonth).fill(0);
        
        // Isi data
        Object.keys(reservationsData).forEach(date => {
            const d = new Date(date);
            // Pastikan bulan sama (karena cache bisa berisi overlap bulan)
            if (d.getMonth() === currentMonth) {
                const day = d.getDate();
                const list = reservationsData[date];
                const total = list.reduce((sum, r) => sum + (parseInt(r.jumlah)||0), 0);
                dataPax[day-1] = total;
            }
        });

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Jumlah Tamu (${monthNames[currentMonth]})`,
                    data: dataPax,
                    borderColor: '#2a9d8f',
                    backgroundColor: 'rgba(42, 157, 143, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        
        // Generate Insight
        const totalTamu = dataPax.reduce((a,b)=>a+b, 0);
        const busyDay = labels[dataPax.indexOf(Math.max(...dataPax))];
        
        document.getElementById('analysis-insights-container').innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="background:#e0f2fe; padding:15px; border-radius:8px; color:#0284c7;">
                    <strong>Total Tamu Bulan Ini:</strong><br>
                    <span style="font-size:1.5rem; font-weight:bold;">${totalTamu}</span> Orang
                </div>
                <div style="background:#dcfce7; padding:15px; border-radius:8px; color:#166534;">
                    <strong>Tanggal Tersibuk:</strong><br>
                    Tanggal <span style="font-size:1.5rem; font-weight:bold;">${busyDay}</span>
                </div>
            </div>
        `;
    }

    function showAnalysis() {
        // Trigger render jika tab dibuka
        renderAnalysisChart();
    }

    // =========================================
    // 15. NOTIFIKASI BACKGROUND (THANK YOU)
    // =========================================
    function setupNotificationChecker() {
        // Cek setiap 5 menit
        setInterval(() => {
            // Logika: Cek reservasi hari ini yang jamnya sudah lewat 2 jam
            // Jika ada, tampilkan notifikasi browser atau badge
            // (Sederhana untuk demo: hanya console log)
            console.log("Checking for post-dining notifications...");
        }, 300000);
    }
    
    // --- SHARE LOGIC ---
    function shareViaEmail() {
        if(!selectedDate) return;
        const subject = `Laporan Reservasi - ${selectedDate}`;
        const body = `Berikut laporan reservasi untuk tanggal ${selectedDate}. Silakan cek sistem admin.`;
        window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    
    function shareViaWhatsApp(type) {
        if(!selectedDate) return;
        const list = reservationsData[selectedDate] || [];
        let msg = `*LAPORAN RESERVASI (${selectedDate})*\n\n`;
        
        if(list.length === 0) { msg += "Tidak ada reservasi."; }
        else {
            list.sort((a,b) => a.jam.localeCompare(b.jam));
            list.forEach((r, i) => {
                msg += `${i+1}. ${r.jam} - ${r.nama} (${r.jumlah} Org) @ ${r.tempat}\n`;
            });
        }
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

</script>
</body>
</html>
