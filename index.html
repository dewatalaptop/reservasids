<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Reservasi Dolan Sawah</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2a9d8f;
      --primary-dark: #264653;
      --secondary: #e9c46a;
      --accent: #f4a261;
      --danger: #e76f51;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --whatsapp: #25D366;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f5f5f5;
      color: var(--dark);
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.85);
      z-index: -1;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: white;
      padding: 25px 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
    }

    header h2 {
      font-size: 2.2rem;
      margin-bottom: 5px;
      font-weight: 600;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
    }

    header small {
      display: block;
      font-size: 0.8rem;
      margin-top: 5px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 300;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .calendar-header {
      display: flex;
      flex-direction: column; /* Changed to column */
      align-items: center;
      margin-bottom: 20px;
    }

    .month-year {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary-dark);
      text-align: center;
      margin-bottom: 10px; /* Added margin below month/year */
    }

    .calendar-nav {
      display: flex;
      gap: 10px;
    }

    .calendar-nav button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .calendar-nav button:hover {
      background-color: var(--primary-dark);
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary-dark);
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .calendar-day {
      min-height: 80px;
      padding: 8px;
      background-color: white;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      position: relative;
      border: 1px solid #eee;
      transition: all 0.3s;
    }

    .calendar-day:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 5px;
      text-align: right;
      position: relative;
      padding-right: 8px;
    }

    .has-reservation {
      background-color: rgba(42, 157, 143, 0.1);
      border-left: 3px solid var(--primary);
    }

    .selected {
      background-color: var(--primary);
      color: white;
    }

    .selected .day-number {
      color: white;
    }

    .reservation-count {
      position: absolute;
      top: -10px;
      right: -8px;
      background-color: var(--success);
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .selected .reservation-count {
      background-color: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .warning {
      background-color: var(--danger);
      color: white;
      padding: 12px;
      margin-top: 15px;
      border-radius: 6px;
      text-align: center;
      display: none;
      font-weight: 500;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .form-popup, .summary {
      margin-top: 25px;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      border-top: 4px solid var(--primary);
    }

    .form-popup h3, .summary h3 {
      color: var(--primary-dark);
      margin-bottom: 15px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-popup h3 i, .summary h3 i {
      color: var(--accent);
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    button.secondary {
      background-color: var(--secondary);
      color: var(--dark);
    }

    button.danger {
      background-color: var(--danger);
    }

    button.whatsapp {
      background-color: var(--whatsapp);
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: white;
      background-color: var(--primary-dark);
      padding: 15px;
      margin-top: 40px;
      position: relative;
    }

    footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
    }

    .menu-detail {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #555;
      background-color: rgba(233, 196, 106, 0.1);
      padding: 8px;
      border-radius: 5px;
      border-left: 3px solid var(--secondary);
    }

    .menu-detail b {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 5px;
      color: var(--primary-dark);
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--primary-dark);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-top: 5px;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .reservation-item {
      padding: 15px;
      margin-bottom: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-left: 4px solid var(--primary);
      position: relative;
    }

    .reservation-item hr {
      border: none;
      border-top: 1px dashed #eee;
      margin: 10px 0;
    }

    .reservation-item b {
      color: var(--primary-dark);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap; /* Biarkan tombol pindah ke baris baru jika tidak cukup ruang */
      justify-content: center; /* Pusatkan tombol secara horizontal */
    }

    .action-buttons button {
      flex: 1 1 auto; /* Membuat tombol memiliki fleksibilitas ukuran */
      min-width: 0; /* Mencegah overflow */
    }

    .capacity-meter {
      height: 8px;
      background-color: #eee;
      border-radius: 4px;
      margin-top: 15px;
      overflow: hidden;
    }

    .capacity-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      width: 0%;
      transition: width 0.5s ease;
    }

    .capacity-info {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.8rem;
      color: #666;
    }

    .empty-day {
      color: #ccc;
      background-color: #f9f9f9;
    }

    .today {
      background-color: rgba(233, 196, 106, 0.3);
      border: 1px solid var(--secondary);
    }

    .whatsapp-options {
      margin-top: 15px;
      padding: 15px;
      background-color: rgba(37, 211, 102, 0.1);
      border-radius: 8px;
      border-left: 3px solid var(--whatsapp);
      display: none;
    }

    .whatsapp-options p {
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--dark);
    }

    .whatsapp-options button {
      margin-top: 5px;
      width: 100%;
    }

    /* Style for the data action buttons */
    .data-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap; /* Biarkan tombol pindah ke baris baru jika tidak cukup ruang */
      justify-content: center; /* Pusatkan tombol secara horizontal */
    }

    .data-actions button {
      flex: 1 1 auto; /* Membuat tombol memiliki fleksibilitas ukuran */
      min-width: 0; /* Mencegah overflow */
    }

    .data-transfer {
      margin-top: 25px;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      border-top: 4px solid var(--accent);
      display: none;
    }

    .data-transfer h3 {
      color: var(--primary-dark);
      margin-bottom: 15px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .data-transfer h3 i {
      color: var(--accent);
    }

    .data-transfer textarea {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      border-radius: 5px;
      border: 1px
solid #ddd;
      margin-bottom: 10px;
      font-family: 'Poppins', sans-serif;
      resize: vertical;
    }

    .data-transfer button {
      margin-right: 10px;
    }

    @media (max-width: 768px) {
      .calendar-day {
        min-height: 60px;
        padding: 5px;
      }

      .container {
        padding: 15px;
      }

      .month-year {
        font-size: 1.2rem;
      }

      .action-buttons {
        flex-direction: row; /* Tetap horizontal pada layar kecil */
        gap: 8px;
      }

      .action-buttons button {
        width: auto;
        flex-grow: 1;
        font-size: 0.9rem;
        padding: 8px 12px;
      }

      .data-actions {
        flex-direction: row; /* Tetap horizontal pada layar kecil */
        gap: 8px;
      }

      .data-actions button {
        width: auto;
        flex-grow: 1;
        font-size: 0.9rem;
        padding: 8px 12px;
      }
    }

    @media (max-width: 480px) {
      .calendar-header {
        flex-direction: column;
        gap: 10px;
      }

      header h2 {
        font-size: 1.8rem;
      }

      .calendar-day {
        min-height: 50px;
        font-size: 0.8rem;
      }

      .day-number {
        margin-bottom: 2px;
      }

      .reservation-count {
        width: 18px;
        height: 18px;
        font-size: 0.6rem;
        top: -8px;
        right: -6px;
      }

      .action-buttons {
        flex-direction: column; /* Kembali ke vertikal pada layar sangat kecil jika perlu */
      }

      .action-buttons button {
        width: 100%;
      }

      .data-actions {
        flex-direction: column; /* Kembali ke vertikal pada layar sangat kecil jika perlu */
      }

      .data-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <header>
    <h2><i class="fas fa-leaf"></i> Sistem Reservasi Dolan Sawah</h2>
    <small>Version 1.0.14</small>
  </header>

  <div class="container">
    <div class="calendar-header">
      <div class="month-year" id="monthYear">Januari 2023</div>
      <div class="calendar-nav">
        <button onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
        <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>

    <div class="calendar-weekdays">
      <div>Minggu</div>
      <div>Senin</div>
      <div>Selasa</div>
      <div>Rabu</div>
      <div>Kamis</div>
      <div>Jumat</div>
      <div>Sabtu</div>
    </div>

    <div class="calendar-days" id="calendar"></div>

    <div class="warning" id="warningBox">
      <i class="fas fa-exclamation-triangle"></i> Kapasitas hampir penuh!
    </div>

    <div class="summary" id="summary" style="display:none;"></div>

    <div class="form-popup" id="formPopup" style="display:none;">
      <h3><i class="fas fa-calendar-plus"></i> Input Reservasi</h3>
      <label><i class="fas fa-lock"></i> Password: <input type="password" id="adminPass" placeholder="Masukkan password admin"/></label>

      <div id="formFields" style="display:none;">
        <label><i class="fas fa-user"></i> Nama: <input type="text" id="nama" placeholder="Nama pemesan"/></label>
        <label><i class="fas fa-clock"></i> Jam Reservasi: <input type="time" id="jam" /></label>
        <label><i class="fas fa-users"></i> Jumlah Peserta: <input type="number" id="jumlah" placeholder="Jumlah orang"/></label>
        <label><i class="fas fa-utensils"></i> Menu:
          <select id="menu" onchange="tampilkanInputCustom()">
            <option>Paket A</option><option>Paket B</option><option>Paket C</option>
            <option>Paket D</option><option>Paket E</option><option>Paket F</option>
            <option>Paket G</option><option>Paket H</option><option>Paket I</option><option>Paket J</option>
            <option>OTS</option><option>Paket Rantang</option>
            <option value="Custom">Custom</option>
          </select>
        </label>
        <div id="inputCustomMenu" style="display:none;">
          <label><i class="fas fa-list"></i> Detail Menu Custom:
            <textarea id="detailCustom" placeholder="Masukkan detail menu secara manual"></textarea>
          </label>
        </div>
        <label><i class="fas fa-map-marker-alt"></i> Tempat:
          <select id="tempat">
            <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
            <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
          </select>
        </label>
        <label><i class="fas fa-comment-dots"></i> Request Tambahan:
          <textarea id="tambahan" placeholder="Permintaan khusus atau catatan tambahan"></textarea>
        </label>
        <button onclick="simpanReservasi()"><i class="fas fa-save"></i> Simpan Reservasi</button>
      </div>
    </div>

    <div class="action-buttons">
      <button onclick="printData()"><i class="fas fa-print"></i> Print</button>
      <button class="secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Bagikan via Email</button>
      <button class="whatsapp" onclick="toggleWhatsAppOptions()"><i class="fab fa-whatsapp"></i> Bagikan via WhatsApp</button>
      <button onclick="showExportData()"><i class="fas fa-file-export"></i> Export Data</button>
      <button onclick="showImportData()"><i class="fas fa-file-import"></i> Import Data</button>
    </div>

    <div class="data-transfer" id="dataTransfer">
      <h3><i class="fas fa-exchange-alt"></i> <span id="dataTransferTitle">Transfer Data</span></h3>
      <textarea id="dataTransferCode" placeholder="Paste kode data di sini..."></textarea>
      <button onclick="processDataTransfer()" id="dataTransferButton"><i class="fas fa-check-circle"></i> Proses</button>
      <button class="danger" onclick="hideDataTransfer()"><i class="fas fa-times-circle"></i> Batal</button>
    </div>

    <div class="whatsapp-options" id="whatsappOptions">
      <p>Pilih opsi berbagi:</p>
      <button class="whatsapp" onclick="shareViaWhatsApp('day')"><i class="fab fa-whatsapp"></i> Bagikan 1 Hari</button>
      <button class="whatsapp" onclick="shareViaWhatsApp('month')"><i class="fab fa-whatsapp"></i> Bagikan Seluruh Bulan</button>
    </div>
  </div>

  <footer>
    <p><i class="fas fa-code"></i> Dibuat <i class="fas fa-heart" style="color: #e76f51;"></i> oleh Ryan</p>
  </footer>

  <script>
    const kapasitasTempat = {
      "Lantai 1": 240, "Lantai 2": 64, "Lantai 3": 112,
      "Gubug 1": 40, "Gubug 2": 15, "Gubug 3": 110,
    };

    const detailMenu = {
      "Paket A": ["Nasi putih", "Ayam kremes", "Sambel", "Lalapan", "Teh", "Es"],
      "Paket B": ["Nasi putih", "Daging kelem", "Bakmi", "Teh", "Es"],
      "Paket C": ["Nasi putih", "Ayam geprek", "Sop Sosis jamur", "Semangka", "Teh", "Es"],
      "Paket D": ["Nasi putih", "Nila bakar", "Sayur asem", "Sambal", "Pisang goreng", "Teh", "Es"],
      "Paket E": ["Nasi putih", "Ayam lada hitam", "Capcay", "Soun jamur", "Bakso kuah", "Kerupuk", "Bolu gulung", "Teh", "Es"],
      "Paket F": ["Steak Ayam", "Kentang goreng", "Wortel + buncis", "Puding Fla", "Soft drink", "Air mineral cup"],
      "Paket G": ["Nasi putih", "Kakap asam manis", "Ayam goreng mentega", "Tumis buncis daging sapi", "Sambal", "Teh", "Es"],
      "Paket H": ["Nasi putih", "Sup iga sapi", "Kerupuk udang", "Sambel kecap", "Tahu + tempe goreng", "Sosis solo", "Bolu gulung", "Teh", "Es", "Air mineral cup"],
      "Paket I": ["Nasi", "Iga bakar", "Sop", "Sambal", "Kerupuk", "Lalapan", "Sosis solo", "Semangka", "Teh", "Es", "Air mineral"],
      "Paket J": ["Nasi", "Sambel goreng ati", "Bihun goreng", "Daging kelem", "Acar kuning", "Kerupuk udang", "Sop Sosis jamur", "Sosis solo", "Pie buah", "Teh", "Softdrink", "Air mineral cup"],
      "OTS": [],
      "Paket Rantang": [],
      "Paket Custom": ["Menu ada di catatan"] // Placeholder untuk custom, detail akan diambil dari input
    };

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

    let dataReservasi = JSON.parse(localStorage.getItem('reservasiDolan')) || {};
    let tanggalDipilih = '';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let indexEdit = -1; // Menyimpan index reservasi yang sedang diedit

    const calendarEl = document.getElementById('calendar');
    const warningBox = document.getElementById('warningBox');
    const summaryEl = document.getElementById('summary');
    const formPopup = document.getElementById('formPopup');
    const monthYearEl = document.getElementById('monthYear');
    const whatsappOptions = document.getElementById('whatsappOptions');
    const dataTransferDiv = document.getElementById('dataTransfer');
    const dataTransferTitle = document.getElementById('dataTransferTitle');
    const dataTransferCode = document.getElementById('dataTransferCode');
    const dataTransferButton = document.getElementById('dataTransferButton');

    function buatKalender() {
      calendarEl.innerHTML = '';

      // Update month/year display
      monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

      // Get first day of month and total days in month
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      // Get today's date for highlighting
      const today = new Date();
      const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;

      // Add empty cells for days before the first day of the month
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty-day';
        calendarEl.appendChild(emptyDay);
      }

      // Add days of the month
      for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';

        // Highlight today
        if (isCurrentMonth && i === today.getDate()) {
          dayEl.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;

        // Check for reservations
        const monthStr = String(currentMonth + 1).padStart(2, '0');
        const dayStr = String(i).padStart(2, '0');
        const dateKey = `${monthStr}-${dayStr}`;

        if (dataReservasi[dateKey] && dataReservasi[dateKey].length > 0) {
          dayEl.classList.add('has-reservation');

          const reservationCount = document.createElement('div');
          reservationCount.className = 'reservation-count';
          reservationCount.textContent = dataReservasi[dateKey].length;
          dayNumber.appendChild(reservationCount);
        }

        dayEl.appendChild(dayNumber);

        // Highlight selected date
        if (dateKey === tanggalDipilih) {
          dayEl.classList.add('selected');
        }

        dayEl.onclick = () => pilihTanggal(i);
        calendarEl.appendChild(dayEl);
      }
    }

    function pilihTanggal(day) {
      const monthStr = String(currentMonth + 1).padStart(2, '0');
      const dayStr = String(day).padStart(2, '0');
      const key = `${monthStr}-${dayStr}`;
      tanggalDipilih = key;
      const data = dataReservasi[key] || [];

      // Update calendar UI
      document.querySelectorAll('.calendar-day').forEach(dayEl => {
        dayEl.classList.remove('selected');
        if (dayEl.querySelector('.day-number')?.textContent == day) {
          dayEl.classList.add('selected');
        }
      });

      // Calculate capacity
      const totalPeserta = data.reduce((sum, r) => sum + Number(r.jumlah), 0);
      const totalKapasitas = Object.values(kapasitasTempat).reduce((a, b) => a + b, 0);
      const persen = (totalPeserta / totalKapasitas) * 100;

      // Update warning box
      warningBox.style.display = persen > 60 ? 'flex' : 'none';
      if (persen > 60) {
        warningBox.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Kapasitas ${Math.round(persen)}%! Hampir penuh!`;
      }

      // Update capacity meter
      document.querySelector('.capacity-meter')?.remove();
      document.querySelector('.capacity-info')?.remove();

      if (totalPeserta > 0) {
        const capacityMeter = document.createElement('div');
        capacityMeter.className = 'capacity-meter';
        capacityMeter.innerHTML = `<div class="capacity-fill" style="width:${persen}%"></div>`;
        summaryEl.appendChild(capacityMeter);

        const capacityInfo = document.createElement('div');
        capacityInfo.className = 'capacity-info';
        capacityInfo.innerHTML = `<span>${totalPeserta} orang terdaftar</span><span>Kapasitas total: ${totalKapasitas} orang</span>`;
        summaryEl.appendChild(capacityInfo);
      }

      // Format date for display
      const formattedDate = `${day} ${monthNames[currentMonth]} ${currentYear}`;

      // Show reservations
      summaryEl.innerHTML = `<h3><i class="far fa-calendar-alt"></i> Reservasi Tanggal ${formattedDate}</h3>`;

      if (data.length === 0) {
        summaryEl.innerHTML += `<p style="text-align: center; color: #666; padding: 20px 0;">
          <i class="far fa-calendar-times" style="font-size: 2rem; color: #ccc; margin-bottom: 10px; display: block;"></i>
          Belum ada reservasi untuk tanggal ini
        </p>`;
      } else {
        data.forEach((r, idx) => {
          let isiMenu = "-";
          if (r.menu !== 'Custom') {
            isiMenu = detailMenu[r.menu]?.length
              ? detailMenu[r.menu].map(item => `• ${item}`).join('<br/>')
              : "-";
          } else if (r.detailCustom) {
            isiMenu = r.detail
Custom.split('\n').map(item => `• ${item}`).join('<br/>');
          }

          const div = document.createElement('div');
          div.className = 'reservation-item';
          div.innerHTML =
            `<b><i class="fas fa-user"></i> ${r.nama}</b><br/>
            <span><i class="fas fa-map-marker-alt"></i> ${r.tempat} • <i class="far fa-clock"></i> ${r.jam} • <i class="fas fa-users"></i> ${r.jumlah} orang</span>
            <div class="menu-detail"><b><i class="fas fa-utensils"></i> ${r.menu}${r.menu === 'Custom' ? ' (Custom)' : ''}:</b><br />${isiMenu}</div>
            <div><i class="fas fa-comment"></i> <b>Tambahan:</b> ${r.tambahan || '-'}</div>
            <hr/>
            <div class="data-actions">
              <button onclick="editReservasi('${key}', ${idx})"><i class="fas fa-edit"></i> Edit</button>
              <button class="danger" onclick="hapusReservasi('${key}', ${idx})"><i class="fas fa-trash-alt"></i> Hapus</button>
            </div>`;
          summaryEl.appendChild(div);
        });
      }

      summaryEl.style.display = 'block';
      formPopup.style.display = 'block';
      document.getElementById('formFields').style.display = 'none';
      document.getElementById('adminPass').value = '';
      formPopup.setAttribute('data-tanggal', key);

      // Hide WhatsApp options when selecting a new date
      whatsappOptions.style.display = 'none';

      // Scroll to form
      formPopup.scrollIntoView({ behavior: 'smooth' });
    }

    function previousMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      buatKalender();
      tanggalDipilih = ''; // Reset selected date when changing months
      summaryEl.style.display = 'none';
      formPopup.style.display = 'none';
      whatsappOptions.style.display = 'none';
      dataTransferDiv.style.display = 'none';
    }

    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      buatKalender();
      tanggalDipilih = ''; // Reset selected date when changing months
      summaryEl.style.display = 'none';
      formPopup.style.display = 'none';
      whatsappOptions.style.display = 'none';
      dataTransferDiv.style.display = 'none';
    }

    function toggleWhatsAppOptions() {
      whatsappOptions.style.display = whatsappOptions.style.display === 'block' ? 'none' : 'block';
      dataTransferDiv.style.display = 'none';
    }

    document.getElementById('adminPass').oninput = function() {
      document.getElementById('formFields').style.display = this.value === 'fusion437666' ? 'block' : 'none';
    };

    function tampilkanInputCustom() {
      const menuSelect = document.getElementById('menu');
      const inputCustomMenu = document.getElementById('inputCustomMenu');
      if (menuSelect.value === 'Custom') {
        inputCustomMenu.style.display = 'block';
      } else {
        inputCustomMenu.style.display = 'none';
      }
    }

    function simpanReservasi() {
      const key = formPopup.getAttribute('data-tanggal');
      const nama = document.getElementById('nama').value;
      const jam = document.getElementById('jam').value;
      const jumlah = parseInt(document.getElementById('jumlah').value);
      const menuSelect = document.getElementById('menu');
      const menu = menuSelect.value;
      const tempat = document.getElementById('tempat').value;
      const tambahan = document.getElementById('tambahan').value;
      let detailCustom = '';

      if (menu === 'Custom') {
        detailCustom = document.getElementById('detailCustom').value;
        if (!detailCustom) {
          return alert('Harap isi detail menu custom!');
        }
      }

      if (!nama || !jam || isNaN(jumlah) || !menu || !tempat) {
        return alert('Harap isi semua field yang diperlukan!');
      }

      const existing = dataReservasi[key] || [];

      // Check for Gubug 1 time conflict
      if (tempat === "Gubug 1") {
        const conflict = existing.some(r =>
          r.tempat === "Gubug 1" &&
          Math.abs(parseFloat(r.jam.replace(":", ".")) - parseFloat(jam.replace(":", "."))) < 3.5
        );
        if (conflict) return alert("Gubug 1 sudah terisi di jam tersebut!");
      }

      const reservasiBaru = { nama, jam, jumlah, menu, tempat, tambahan };
      if (menu === 'Custom' && detailCustom) {
        reservasiBaru.detailCustom = detailCustom;
      }

      existing.push(reservasiBaru);
      dataReservasi[key] = existing;
      localStorage.setItem('reservasiDolan', JSON.stringify(dataReservasi));

      // Show success message
      const successMsg = document.createElement('div');
      successMsg.innerHTML = `<div style="background-color: var(--success); color: white; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center;">
        <i class="fas fa-check-circle"></i> Reservasi berhasil disimpan!
      </div>`;
      formPopup.appendChild(successMsg);

      // Clear form
      document.getElementById('nama').value = '';
      document.getElementById('jam').value = '';
      document.getElementById('jumlah').value = '';
      document.getElementById('tambahan').value = '';
      document.getElementById('detailCustom').value = '';
      document.getElementById('menu').value = 'Paket A'; // Reset menu ke default
      document.getElementById('inputCustomMenu').style.display = 'none'; // Sembunyikan input custom

      // Remove message after 3 seconds and refresh view
      setTimeout(() => {
        successMsg.remove();
        const day = parseInt(key.split("-")[1]);
        pilihTanggal(day);
        buatKalender(); // Refresh calendar to update reservation counts
      }, 3000);
    }

    function editReservasi(tgl, index) {
      const pass = prompt("Masukkan password admin:");
      if (pass !== 'fusion437666') return alert("Password salah!");

      const reservasi = dataReservasi[tgl][index];
      tanggalDipilih = tgl;
      indexEdit = index;

      // Update calendar UI to reflect the selected date
      document.querySelectorAll('.calendar-day').forEach(dayEl => {
        dayEl.classList.remove('selected');
        if (dayEl.querySelector('.day-number')?.textContent == parseInt(tgl.split('-')[1])) {
          dayEl.classList.add('selected');
        }
      });

      // Populate the form with the reservation data
      document.getElementById('formFields').style.display = 'block';
      document.getElementById('nama').value = reservasi.nama;
      document.getElementById('jam').value = reservasi.jam;
      document.getElementById('jumlah').value = reservasi.jumlah;
      document.getElementById('menu').value = reservasi.menu;
      document.getElementById('tempat').value = reservasi.tempat;
      document.getElementById('tambahan').value = reservasi.tambahan || '';

      // Show custom menu input if the selected menu is 'Custom'
      const inputCustomMenu = document.getElementById('inputCustomMenu');
      if (reservasi.menu === 'Custom' && reservasi.detailCustom) {
        inputCustomMenu.style.display = 'block';
        document.getElementById('detailCustom').value = reservasi.detailCustom;
      } else {
        inputCustomMenu.style.display = 'none';
        document.getElementById('detailCustom').value = '';
      }

      // Change the button text to "Update Reservasi" and update its onclick function
      const simpanButton = document.querySelector('#formPopup button');
      simpanButton.textContent = 'Update Reservasi';
      simpanButton.onclick = function() {
        updateReservasi(tgl);
      };

      formPopup.style.display = 'block';
      formPopup.scrollIntoView({ behavior: 'smooth' });
    }

    function updateReservasi(tgl) {
      const nama = document.getElementById('nama').value;
      const jam = document.getElementById('jam').value;
      const jumlah = parseInt(document.getElementById('jumlah').value);
      const menuSelect = document.getElementById('menu');
      const menu = menuSelect.value;
      const tempat = document.getElementById('tempat').value;
      const tambahan = document.getElementById('tambahan').value;
      let detailCustom = '';

      if (menu === 'Custom') {
        detailCustom = document.getElementById('detailCustom').value;
        if (!detailCustom) {
          return alert('Harap isi detail menu custom!');
        }
      }

      if (!nama || !jam || isNaN(jumlah) || !menu || !tempat) {
        return alert('Harap isi semua field yang diperlukan!');
      }

      // Check for Gubug 1 time conflict (excluding the reservation being edited)
      if (tempat === "Gubug 1") {
        const conflict = dataReservasi[tgl].some((r, i) =>
          i !== indexEdit &&
          r.tempat === "Gubug 1" &&
          Math.abs(parseFloat(r.jam.replace(":", ".")) - parseFloat(jam.replace(":", "."))) < 3.5
        );
        if (conflict) return alert("Gubug 1 sudah terisi di jam tersebut!");
      }

      const updatedReservasi = { nama, jam, jumlah, menu, tempat, tambahan };
      if (menu === 'Custom' && detailCustom) {
        updatedReservasi.detailCustom = detailCustom;
      }

      dataReservasi[tgl][indexEdit] = updatedReservasi;
      localStorage.setItem('reservasiDolan', JSON.stringify(dataReservasi));
      indexEdit = -1; // Reset index edit

      // Change the button text back to "Simpan Reservasi" and update its onclick function
      const simpanButton = document.querySelector('#formPopup button');
      simpanButton.textContent = 'Simpan Reservasi';
      simpanButton.onclick = simpanReservasi;

      // Hide the form and refresh the reservation list
      formPopup.style.display = 'none';
      const day = parseInt(tgl.split("-")[1]);
      pilihTanggal(day);
      buatKalender();
    }

    function hapusReservasi(tgl, idx) {
      const pass = prompt("Masukkan password admin:");
      if (pass !== 'fusion437666') return alert("Password salah!");

      if (confirm("Apakah Anda yakin ingin menghapus reservasi ini?")) {
        dataReservasi[tgl].splice(idx, 1);
        localStorage.setItem('reservasiDolan', JSON.stringify(dataReservasi));
        const day = parseInt(tgl.split("-")[1]);
        pilihTanggal(day);
        buatKalender(); // Refresh calendar to update reservation counts
      }
    }

    function printData() {
      if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) {
        alert("Silakan pilih tanggal terlebih dahulu.");
        return;
      }
      window.print();
    }

    function shareViaEmail() {
      if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) {
        return alert("Silakan pilih tanggal terlebih dahulu.");
      }

      const [month, day] = tanggalDipilih.split('-');
      const formattedDate = `${parseInt(day)} ${monthNames[parseInt(month)-1]} ${currentYear}`;

      const list = dataReservasi[tanggalDipilih];
      const summary = `Detail Reservasi Dolan Sawah - ${formattedDate}:\n\n` +
        list.map((r, i) => {
          let isi = "-";
          if (r.menu !== 'Custom') {
            isi = detailMenu[r.menu]?.length
              ? detailMenu[r.menu].map(x => `    - ${x}`).join('\n')
              : "    - (tanpa detail menu)";
          } else if (r.detailCustom) {
            isi = r.detailCustom.split('\n').map(x => `    - ${x}`).join('\n');
          }
          return (
              `${i + 1}. ${r.nama}\n` +
                 `    Tempat: ${r.tempat}\n` +
                 `    Jam: ${r.jam}\n` +
                 `    Jumlah: ${r.jumlah} orang\n` +
                 `    Menu: ${r.menu}${r.menu === 'Custom' ? ' (Custom)' : ''}\n` +
            `${isi}\n` +
                 `    Catatan: ${r.tambahan || '-'}\n` +
                 `    -----------------------------\n`
          );
        }).join('\n');

      const emailLink = `mailto:?subject=Reservasi ${formattedDate} Dolan Sawah&body=${encodeURIComponent(summary)}`;
      window.location.href = emailLink;
    }

    function shareViaWhatsApp(scope) {
      let message = `*Reservasi Dolan Sawah - ${monthNames[currentMonth]} ${currentYear}*\n\n`;

      if (scope === 'day') {
        if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) {
          return alert("Silakan pilih tanggal terlebih dahulu.");
        }

        const [month, day] = tanggalDipilih.split('-');
        const formattedDate = `${parseInt(day)} ${monthNames[parseInt(month)-1]} ${currentYear}`;
        const list = dataReservasi[tanggalDipilih];

        message += `*Tanggal: ${formattedDate}*\n\n`;

        if (list.length === 0) {
          message += "Belum ada reservasi untuk tanggal ini\n";
        } else {
          list.forEach((r, i) => {
            let isi = "-";
            if (r.menu !== 'Custom') {
              isi = detailMenu[r.menu]?.length
                ? detailMenu[r.menu].map(x => `    - ${x}`).join('\n')
                : "    - (tanpa detail menu)";
            } else if (r.detailCustom) {
              isi = r.detailCustom.split('\n').map(x => `    - ${x}`).join('\n');
            }
            message += (
              `*${i + 1}. ${r.nama}*\n` +
                 `    Tempat: ${r.tempat}\n` +
                 `    Jam: ${r.jam}\n` +
                 `    Jumlah: ${r.jumlah} orang\n` +
                 `    Menu: ${r.menu}${r.menu === 'Custom' ? ' (Custom)' : ''}\n` +
              `${isi}\n` +
                 `    Catatan: ${r.tambahan || '-'}\n\n`
            );
          });
        }
      } else {
        // Share entire month
        let hasReservations = false;
        const monthStr = String(currentMonth + 1).padStart(2, '0');

        for (let i = 1; i <= new Date(currentYear, currentMonth + 1, 0).getDate(); i++) {
          const dayStr = String(i).padStart(2, '0');
          const dateKey = `${monthStr}-${dayStr}`;

          if (dataReservasi[dateKey] && dataReservasi[dateKey].length > 0) {
            hasReservations = true;
            const formattedDate = `${i} ${monthNames[currentMonth]} ${currentYear}`;
            message += `*${formattedDate}*\n`;

            dataReservasi[dateKey].forEach((r, idx) => {
              message += (
                  `- ${r.nama} (${r.tempat}, ${r.jam}, ${r.jumlah} orang)\n` +
                    `  Menu: ${r.menu}${r.menu === 'Custom' ? ' (Custom)' : ''}\n`
              );
              if (r.detailCustom) {
                message += `    Detail: ${r.detailCustom.split('\n').join(', ')}\n`;
              }
              if (r.tambahan) {
                message += `  Catatan: ${r.tambahan}\n`;
              }
              message += '\n';
            });
          }
        }

        if (!hasReservations) {
          message += "Belum ada reservasi untuk bulan ini\n";
        }
      }

      const whatsappLink = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappLink, '_blank');
    }

    function showExportData() {
      dataTransferDiv.style.display = 'block';
      dataTransferTitle.textContent = 'Export Data';
      dataTransferButton.innerHTML = '<i class="fas fa-download"></i> Generate Kode';
      dataTransferCode.placeholder = 'Kode data akan muncul di sini...';

      //
      const exportData = {
        version: '1.0',
        data: dataReservasi,
        timestamp: new Date().toISOString()
      };

      const jsonString = JSON.stringify(exportData);
      const compressedData = btoa(unescape(encodeURIComponent(jsonString)));

      dataTransferCode.value = compressedData;
      dataTransferDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function showImportData() {
      dataTransferDiv.style.display = 'block';
      dataTransferTitle.textContent = 'Import Data';
      dataTransferButton.innerHTML = '<i class="fas fa-check-circle"></i> Import Data';
      dataTransferCode.placeholder = 'Paste kode data di sini...';
      dataTransferCode.value = '';
      dataTransferDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function hideDataTransfer() {
      dataTransferDiv.style.display = 'none';
    }

    function processDataTransfer() {
      const code = dataTransferCode.value.trim();

      if (!code) {
        alert('Silakan masukkan kode data terlebih dahulu!');
        return;
      }

      try {
        // Check if we're exporting or importing
        if (dataTransferButton.innerHTML.includes('Generate')) {
          // Copy to clipboard
          navigator.clipboard.writeText(code).then(() => {
            alert('Kode berhasil disalin ke clipboard!');
          }).catch(err => {
            alert('Gagal menyalin ke clipboard: ' + err);
          });
        } else {
          // Importing data
          if (!confirm('Import data akan menimpa semua data yang ada. Lanjutkan?')) {
            return;
          }

          // Decode the data
          const jsonString = decodeURIComponent(escape(atob(code)));
          const importData = JSON.parse(jsonString);

          if (!importData.data || !importData.version) {
            throw new Error('Format data tidak valid');
          }

          // Save the imported data
          dataReservasi = importData.data;
          localStorage.setItem('reservasiDolan', JSON.stringify(dataReservasi));

          // Refresh the view
          buatKalender();
          if (tanggalDipilih) {
            const day = parseInt(tanggalDipilih.split("-")[1]);
            pilihTanggal(day);
          }

          alert('Data berhasil diimport!');
          hideDataTransfer();
        }
      } catch (error) {
        alert('Error memproses data: ' + error.message);
        console.error(error);
      }
    }

    // Initialize calendar
    buatKalender();
  </script>
</body>
</html>