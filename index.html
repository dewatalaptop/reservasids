<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Reservasi Dolan Sawah (Firebase)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; --primary-dark: #264653; --secondary: #e9c46a; --accent: #f4a261; --danger: #e76f51; --light: #f8f9fa; --dark: #343a40; --success: #28a745; --whatsapp: #25D366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f5f5f5; color: var(--dark);
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover; background-attachment: fixed; background-position: center; min-height: 100vh;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.85); z-index: -1;
    }
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 25px 20px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
    }
    header::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
    }
    header h2 { font-size: 2.2rem; margin-bottom: 5px; font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); }
    header small { display: block; font-size: 0.8rem; margin-top: 5px; color: rgba(255, 255, 255, 0.8); font-weight: 300; }
    .container {
      max-width: 1200px; margin: 30px auto; padding: 20px; background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: none; /* Hidden by default */
    }
    #login-container {
      max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; border-top: 5px solid var(--primary);
    }
    #login-container h3 { color: var(--primary-dark); margin-bottom: 20px; font-size: 1.5rem; }
    #login-error { color: var(--danger); margin-top: 15px; font-weight: 500; display: none; }
    #logout-button {
        position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--danger);
        color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none; /* Hidden by default */
    }
    .calendar-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .month-year { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); text-align: center; margin-bottom: 10px; }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-nav button { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
    .calendar-nav button:hover { background-color: var(--primary-dark); }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; margin-bottom: 10px; color: var(--primary-dark); }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { min-height: 80px; padding: 8px; background-color: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); position: relative; border: 1px solid #eee; transition: all 0.3s; }
    .calendar-day:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
    .day-number { font-weight: 600; margin-bottom: 5px; text-align: right; position: relative; padding-right: 8px; }
    .has-reservation { background-color: rgba(42, 157, 143, 0.1); border-left: 3px solid var(--primary); }
    .selected { background-color: var(--primary); color: white; }
    .selected .day-number { color: white; }
    .reservation-count { position: absolute; top: -10px; right: -8px; background-color: var(--success); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .selected .reservation-count { background-color: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .warning { background-color: var(--danger); color: white; padding: 12px; margin-top: 15px; border-radius: 6px; text-align: center; display: none; font-weight: 500; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    .form-popup, .summary, .edit-form-popup, .menu-management-popup { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--primary); }
    .form-popup h3, .summary h3, .edit-form-popup h3, .menu-management-popup h3 { color: var(--primary-dark); margin-bottom: 15px; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    .form-popup h3 i, .summary h3 i, .edit-form-popup h3 i, .menu-management-popup h3 i { color: var(--accent); }
    button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-family: 'Poppins', sans-serif; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    button:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    button.secondary { background-color: var(--secondary); color: var(--dark); }
    button.danger { background-color: var(--danger); }
    button.whatsapp { background-color: var(--whatsapp); }
    button.accent { background-color: var(--accent); color: white; }
    footer { text-align: center; font-size: 0.8rem; color: white; background-color: var(--primary-dark); padding: 15px; margin-top: 40px; position: relative; }
    footer::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--secondary), var(--accent)); }
    .menu-detail { margin-top: 8px; font-size: 0.85rem; color: #555; background-color: rgba(233, 196, 106, 0.1); padding: 8px; border-radius: 5px; border-left: 3px solid var(--secondary); }
    .menu-detail b { font-size: 0.9rem; display: block; margin-bottom: 5px; color: var(--primary-dark); }
    label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary-dark); }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2); }
    textarea { min-height: 80px; resize: vertical; }
    .reservation-item { padding: 15px; margin-bottom: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border-left: 4px solid var(--primary); position: relative; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .reservation-details { flex-grow: 1; width: 100%; }
    .reservation-item hr { border: none; border-top: 1px dashed #eee; margin: 10px 0; }
    .reservation-item b { color: var(--primary-dark); }
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .action-buttons button { flex: 1 1 auto; min-width: 0; }
    .data-transfer { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--accent); display: none; }
    .data-transfer h3 { color: var(--primary-dark); margin-bottom: 15px; font-size: 1.4rem; }
    .data-transfer textarea { width: 100%; min-height: 150px; }
    .whatsapp-options-container, .sort-options-container { position: relative; display: inline-block; width: 100%; }
    .whatsapp-options, .sort-options { position: absolute; bottom: 100%; left: 0; width: 100%; margin-bottom: 5px; padding: 15px; border-radius: 8px; z-index: 10; display: none; }
    .whatsapp-options { background-color: rgba(37, 211, 102, 0.1); border-left: 3px solid var(--whatsapp); }
    .sort-options { background-color: rgba(42, 157, 143, 0.1); border-left: 3px solid var(--primary); }
    .whatsapp-options p, .sort-options p { margin-bottom: 10px; font-weight: 500; color: var(--dark); }
    .whatsapp-options button, .sort-options button { margin-top: 5px; width: 100%; }
    .data-actions { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; width: 100%; }
    .data-actions button { flex-grow: 1; padding: 8px 10px; font-size: 0.85rem; margin-top: 0; }
    .edit-form-popup, .menu-management-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; display: none; }
    .search-container { position: relative; margin: 0 auto 20px; max-width: 600px; width: 100%; }
    .search-container input { padding-left: 35px; border-radius: 30px; border: 2px solid var(--primary); background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); }
    @media (max-width: 768px) {
      .container { padding: 15px; } .month-year { font-size: 1.2rem; }
      .action-buttons button { font-size: 0.8rem; padding: 8px 10px; }
      .whatsapp-options, .sort-options { position: relative; bottom: auto; margin-top: 10px; margin-bottom: 0; }
    }
    @media (max-width: 480px) {
      header h2 { font-size: 1.8rem; }
      .action-buttons { flex-direction: column; } .action-buttons button { width: 100%; }
      .data-actions { justify-content: center; }
    }
  </style>
</head>
<body>

  <header>
    <h2><i class="fas fa-leaf"></i> Sistem Reservasi Dolan Sawah</h2>
    <small>Version 2.4 (All Functions Restored)</small>
  </header>

  <div id="login-container">
    <h3><i class="fas fa-lock"></i> Login Admin</h3>
    <label>Email: <input type="email" id="loginEmail" placeholder="Masukkan email admin"/></label>
    <label>Password: <input type="password" id="loginPassword" placeholder="Masukkan password"/></label>
    <button onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
    <p id="login-error">Email atau password salah.</p>
  </div>
  
  <button id="logout-button" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>

  <div class="container" id="main-container">
    <div class="global-search-container">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="globalSearchInput" oninput="performGlobalSearch(this.value)" placeholder="Cari di seluruh database (nama)...">
      </div>
    </div>

    <div id="searchResults" class="summary" style="display:none;">
      <h3><i class="fas fa-search"></i> Hasil Pencarian</h3>
      <div id="searchResultsContent"></div>
    </div>

    <div class="calendar-header">
      <div class="month-year" id="monthYear"></div>
      <div class="calendar-nav">
        <button onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
        <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>

    <div class="calendar-weekdays">
      <div>Minggu</div> <div>Senin</div> <div>Selasa</div> <div>Rabu</div> <div>Kamis</div> <div>Jumat</div> <div>Sabtu</div>
    </div>

    <div class="calendar-days" id="calendar"></div>

    <div id="summary" class="summary" style="display:none;">
      <h3><i class="far fa-calendar-alt"></i> Reservasi</h3>
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" oninput="filterReservations(this.value)" placeholder="Cari di tanggal yang dipilih...">
      </div>
      <div id="reservation-list-container"></div>
    </div>

    <div id="formPopup" class="form-popup" style="display:none;">
      <h3><i class="fas fa-calendar-plus"></i> Input Reservasi</h3>
      <form id="reservation-form">
        <label>Nama: <input type="text" id="nama" /></label>
        <label>Nomor HP: <input type="tel" id="nomorHp" /></label>
        <label>Jam Reservasi: <input type="time" id="jam" /></label>
        <label>Jumlah Peserta: <input type="number" id="jumlah" /></label>
        <label>DP (Rupiah): <input type="number" id="dp" value="0" /></label>
        <label>Menu: <select id="menu"></select></label>
        <label>Tempat:
          <select id="tempat">
            <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
            <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
          </select>
        </label>
        <label>Request Tambahan: <textarea id="tambahan"></textarea></label>
        <button type="button" onclick="simpanReservasi()"><i class="fas fa-save"></i> Simpan Reservasi</button>
      </form>
    </div>

    <div class="action-buttons">
      <button onclick="showCustomerMenu()"><i class="fas fa-address-book"></i> Data Customer</button>
      <button onclick="showMenuManagement()"><i class="fas fa-book-open"></i> Kelola Menu</button>
      <button onclick="printData()"><i class="fas fa-print"></i> Print</button>
      <div class="sort-options-container">
        <button class="secondary" onclick="toggleSortOptions(event)"><i class="fas fa-sort"></i> Urutkan Data</button>
        <div class="sort-options" id="sortOptions">
          <p>Urutkan berdasarkan:</p>
          <button onclick="sortReservations('jam')"><i class="fas fa-clock"></i> Jam</button>
          <button onclick="sortReservations('tempat')"><i class="fas fa-map-marker-alt"></i> Tempat</button>
        </div>
      </div>
      <button class="secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Email</button>
      <div class="whatsapp-options-container">
        <button class="whatsapp" onclick="toggleWhatsAppOptions(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>
        <div class="whatsapp-options" id="whatsappOptions">
          <p>Pilih opsi:</p>
          <button class="whatsapp" onclick="shareViaWhatsApp('day')"><i class="fab fa-whatsapp"></i> Bagikan 1 Hari</button>
          <button class="whatsapp" onclick="shareViaWhatsApp('month')"><i class="fab fa-whatsapp"></i> Bagikan 1 Bulan</button>
        </div>
      </div>
      <button class="accent" onclick="forceSync()"><i class="fas fa-sync-alt"></i> Paksa Sinkronisasi</button>
      <button onclick="showExportData()"><i class="fas fa-file-export"></i> Export Bulan Ini</button>
    </div>

    <div class="data-transfer" id="dataTransfer">
      <h3><i class="fas fa-file-code"></i> Kode Ekspor untuk Bulan <span id="exportMonthName"></span></h3>
      <p>Salin kode di bawah ini untuk ditempel di website lain.</p>
      <textarea id="dataTransferCode" readonly></textarea>
      <button onclick="copyExportCode()"><i class="fas fa-copy"></i> Salin Kode</button>
      <button class="danger" onclick="hideDataTransfer()"><i class="fas fa-times-circle"></i> Tutup</button>
    </div>
  </div>

  <div id="editFormPopup" class="edit-form-popup">
     </div>
  
  <div id="menuManagementPopup" class="menu-management-popup">
      </div>
  
  <div class="overlay" id="overlay"></div>

  <footer>
    <p><i class="fas fa-code"></i> Dibuat <i class="fas fa-heart" style="color: #e76f51;"></i> oleh Ryan</p>
  </footer>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.firebasestorage.app",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    db.enablePersistence().catch(err => console.warn("Firebase persistence error: ", err.code));

    // --- VARIABEL GLOBAL ---
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let dataReservasi = {};
    let detailMenu = {};
    let tanggalDipilih = '';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let unsubscribeReservations = null;

    // --- SELEKTOR ELEMEN ---
    const mainContainer = document.getElementById('main-container');
    const loginContainer = document.getElementById('login-container');
    const logoutButton = document.getElementById('logout-button');
    const monthYearEl = document.getElementById('monthYear');
    const calendarEl = document.getElementById('calendar');
    const summaryEl = document.getElementById('summary');
    const dataTransferDiv = document.getElementById('dataTransfer');
    const overlay = document.getElementById('overlay');

    // --- FUNGSI AUTENTIKASI & INISIALISASI ---
    auth.onAuthStateChanged(user => {
        if (user) {
            loginContainer.style.display = 'none'; mainContainer.style.display = 'block';
            logoutButton.style.display = 'inline-flex'; initializeApp();
        } else {
            loginContainer.style.display = 'block'; mainContainer.style.display = 'none';
            logoutButton.style.display = 'none';
        }
    });
    function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password).catch(err => alert('Login Gagal: ' + err.message));
    }
    function handleLogout() { if (confirm("Yakin ingin logout?")) auth.signOut(); }
    function initializeApp() { loadMenus(); loadReservationsForCurrentMonth(); }
    
    // --- PEMUATAN DATA ---
    async function loadMenus() {
        const snapshot = await db.collection('menus').get();
        detailMenu = {};
        snapshot.forEach(doc => detailMenu[doc.id] = doc.data().details);
        populateMenuDropdowns();
    }

    function loadReservationsForCurrentMonth() {
        if (unsubscribeReservations) unsubscribeReservations();
        const monthStr = String(currentMonth + 1).padStart(2, '0');
        const startDate = `${currentYear}-${monthStr}-01`;
        const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
        const endDate = `${currentYear}-${monthStr}-${String(lastDay).padStart(2, '0')}`;
        unsubscribeReservations = db.collection('reservations').where('date', '>=', startDate).where('date', '<=', endDate)
            .onSnapshot(snapshot => {
                dataReservasi = {};
                snapshot.forEach(doc => {
                    const reservation = { id: doc.id, ...doc.data() };
                    const dateKey = reservation.date.substring(5);
                    if (!dataReservasi[dateKey]) dataReservasi[dateKey] = [];
                    dataReservasi[dateKey].push(reservation);
                });
                buatKalender();
                if (tanggalDipilih) {
                    const day = parseInt(tanggalDipilih.split('-')[1]);
                    pilihTanggal(day, false);
                }
            }, err => console.error("Error listener: ", err));
    }

    // --- FUNGSI INTI KALENDER & TAMPILAN (YANG HILANG SEBELUMNYA) ---
    function buatKalender() {
        calendarEl.innerHTML = '';
        monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();
        const isCurrentMonthView = today.getMonth() === currentMonth && today.getFullYear() === currentYear;

        for (let i = 0; i < firstDay; i++) {
            calendarEl.insertAdjacentHTML('beforeend', `<div class="calendar-day empty-day"></div>`);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dateKey = `${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const isToday = isCurrentMonthView && i === today.getDate() ? 'today' : '';
            const isSelected = dateKey === tanggalDipilih ? 'selected' : '';
            const hasRes = dataReservasi[dateKey] && dataReservasi[dateKey].length > 0;
            const hasResClass = hasRes ? 'has-reservation' : '';
            
            const countHTML = hasRes ? `<div class="reservation-count">${dataReservasi[dateKey].length}</div>` : '';

            const dayHTML = `
                <div class="calendar-day ${isToday} ${isSelected} ${hasResClass}" onclick="pilihTanggal(${i})">
                    <div class="day-number">${i}${countHTML}</div>
                </div>`;
            calendarEl.insertAdjacentHTML('beforeend', dayHTML);
        }
    }

    function pilihTanggal(day, shouldScroll = true) {
        tanggalDipilih = `${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        buatKalender(); // Cukup panggil buatKalender lagi untuk update selection class
        const reservationsForDay = dataReservasi[tanggalDipilih] || [];
        updateReservationList(reservationsForDay);
        summaryEl.querySelector('h3').innerHTML = `<i class="far fa-calendar-alt"></i> Reservasi ${day} ${monthNames[currentMonth]}`;
        summaryEl.style.display = 'block';
        document.getElementById('formPopup').style.display = 'block';
        if (shouldScroll) summaryEl.scrollIntoView({ behavior: 'smooth' });
    }

    function updateReservationList(reservations) {
        const container = document.getElementById('reservation-list-container');
        container.innerHTML = ''; // Clear previous list
        if (reservations.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: #666; padding: 20px 0;">Belum ada reservasi.</p>`;
        } else {
            reservations.forEach(r => {
                const menuItems = detailMenu[r.menu] || r.menuDetails || [];
                const isiMenu = menuItems.length ? menuItems.map(item => `‚Ä¢ ${item}`).join('<br/>') : "-";
                const dpInfo = r.dp ? `<div class="dp-info"><i class="fas fa-money-bill-wave"></i> DP: Rp${formatRupiah(r.dp)}</div>` : '';
                const phoneInfo = r.nomorHp ? `<div><i class="fas fa-phone"></i> ${r.nomorHp}</div>` : '';
                
                const itemHTML = `
                <div class="reservation-item">
                    <div class="reservation-details">
                        <b><i class="fas fa-user"></i> ${r.nama}</b><br/>
                        <span><i class="fas fa-map-marker-alt"></i> ${r.tempat} ‚Ä¢ <i class="far fa-clock"></i> ${r.jam} ‚Ä¢ <i class="fas fa-users"></i> ${r.jumlah} org</span>
                        ${dpInfo}${phoneInfo}
                        <div class="menu-detail"><b><i class="fas fa-utensils"></i> ${r.menu}:</b><br />${isiMenu}</div>
                        <div><i class="fas fa-comment"></i> <b>Tambahan:</b> ${r.tambahan || '-'}</div>
                    </div>
                    <div class="data-actions">
                        ${r.nomorHp ? `<button class="whatsapp" onclick="contactViaWhatsApp('${r.id}')"><i class="fab fa-whatsapp"></i> Hubungi</button>` : ''}
                        <button onclick="editReservasi('${r.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="danger" onclick="hapusReservasi('${r.id}')"><i class="fas fa-trash-alt"></i> Hapus</button>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', itemHTML);
            });
        }
    }
    
    function filterReservations(query) {
        const reservations = dataReservasi[tanggalDipilih] || [];
        const filtered = reservations.filter(r => 
            r.nama.toLowerCase().includes(query.toLowerCase()) ||
            r.tempat.toLowerCase().includes(query.toLowerCase()) ||
            r.menu.toLowerCase().includes(query.toLowerCase())
        );
        updateReservationList(filtered);
    }
    
    // --- FUNGSI CRUD (Create, Read, Update, Delete) ---
    async function simpanReservasi() {
        const form = document.getElementById('reservation-form');
        const reservationData = {
            nama: form.nama.value, nomorHp: form.nomorHp.value, jam: form.jam.value,
            jumlah: parseInt(form.jumlah.value), dp: parseInt(form.dp.value) || 0,
            menu: form.menu.value, tempat: form.tempat.value, tambahan: form.tambahan.value,
            date: `${currentYear}-${tanggalDipilih}`, menuDetails: detailMenu[form.menu.value] || [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!reservationData.nama || !reservationData.jam || !reservationData.jumlah) return alert('Nama, Jam, dan Jumlah Peserta wajib diisi!');
        try {
            await db.collection('reservations').add(reservationData);
            alert("Reservasi berhasil disimpan!"); form.reset();
        } catch (e) { alert("Gagal menyimpan: " + e.message); }
    }

    async function hapusReservasi(id) {
        if (confirm("Yakin ingin menghapus reservasi ini?")) {
            try { await db.collection('reservations').doc(id).delete(); } catch (e) { alert("Gagal menghapus: " + e.message); }
        }
    }

    function editReservasi(id) {
        const res = findReservationById(id); if (!res) return;
        const formPopup = document.getElementById('editFormPopup');
        formPopup.innerHTML = `
            <h3><i class="fas fa-edit"></i> Edit Reservasi</h3>
            <input type="hidden" id="editReservationId" value="${id}" />
            <label>Nama: <input type="text" id="editNama" value="${res.nama}" /></label>
            <label>Nomor HP: <input type="tel" id="editNomorHp" value="${res.nomorHp || ''}" /></label>
            <label>Jam: <input type="time" id="editJam" value="${res.jam}" /></label>
            <label>Jumlah Peserta: <input type="number" id="editJumlah" value="${res.jumlah}" /></label>
            <label>DP: <input type="number" id="editDp" value="${res.dp || 0}" /></label>
            <label>Menu: <select id="editMenu"></select></label>
            <label>Tempat: <select id="editTempat" value="${res.tempat}">
                <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
                <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
            </select></label>
            <label>Tambahan: <textarea id="editTambahan">${res.tambahan || ''}</textarea></label>
            <div class="data-actions">
                <button onclick="simpanPerubahanReservasi()"><i class="fas fa-save"></i> Simpan</button>
                <button class="danger" onclick="tutupEditForm()"><i class="fas fa-times-circle"></i> Batal</button>
            </div>`;
        populateMenuDropdowns('editMenu', res.menu); // Repopulate and set value
        document.getElementById('editTempat').value = res.tempat;
        formPopup.style.display = 'block'; overlay.style.display = 'block';
    }

    async function simpanPerubahanReservasi() {
        const form = document.getElementById('editFormPopup');
        const id = form.querySelector('#editReservationId').value;
        const updatedData = {
            nama: form.querySelector('#editNama').value, nomorHp: form.querySelector('#editNomorHp').value, 
            jam: form.querySelector('#editJam').value, jumlah: parseInt(form.querySelector('#editJumlah').value), 
            dp: parseInt(form.querySelector('#editDp').value) || 0, menu: form.querySelector('#editMenu').value, 
            tempat: form.querySelector('#editTempat').value, tambahan: form.querySelector('#editTambahan').value,
            menuDetails: detailMenu[form.querySelector('#editMenu').value] || []
        };
        try {
            await db.collection('reservations').doc(id).update(updatedData);
            tutupEditForm();
        } catch (e) { alert("Gagal menyimpan perubahan: " + e.message); }
    }
    function tutupEditForm() { document.getElementById('editFormPopup').style.display = 'none'; overlay.style.display = 'none'; }
    
    // --- FUNGSI UTILITAS & FITUR TAMBAHAN (YANG DIPERBAIKI) ---

    function formatRupiah(amount) { return (amount || 0).toLocaleString('id-ID'); }
    function findReservationById(id) {
        for (const key in dataReservasi) {
            const found = dataReservasi[key].find(r => r.id === id); if (found) return found;
        } return null;
    }
    function contactViaWhatsApp(id) {
        const r = findReservationById(id); if (!r || !r.nomorHp) return alert("Nomor HP tidak ditemukan.");
        let phone = r.nomorHp.replace(/\D/g, '');
        if (phone.startsWith('0')) phone = '62' + phone.substring(1);
        const [y, m, d] = r.date.split('-');
        const date = `${parseInt(d)} ${monthNames[parseInt(m)-1]} ${y}`;
        const dp = r.dp ? `üí∞ *DP:* Rp${formatRupiah(r.dp)}\n` : '';
        const msg = `Salam Bpk/Ibu *${r.nama}*,\nKonfirmasi reservasi Anda di Dolan Sawah:\n\nüóìÔ∏è *Tanggal:* ${date}\nüìç *Tempat:* ${r.tempat}\n‚è∞ *Jam:* ${r.jam}\nüë• *Jumlah:* ${r.jumlah} orang\n${dp}üçΩÔ∏è *Menu:* ${r.menu}\nüìù *Catatan:* ${r.tambahan||'-'}\n\nTerima kasih! üôè`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }
    function shareViaWhatsApp(scope) {
        let msg = `*‚ú® Reservasi Dolan Sawah ‚ú®*\n`;
        if (scope === 'day') {
            if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) return alert("Pilih tanggal dulu.");
            const list = [...dataReservasi[tanggalDipilih]].sort((a,b) => a.jam.localeCompare(b.jam));
            msg += `*üóìÔ∏è Tanggal: ${parseInt(tanggalDipilih.split('-')[1])} ${monthNames[currentMonth]} ${currentYear}*\n\n`;
            if (list.length < 1) msg += "Belum ada reservasi.\n";
            list.forEach((r,i) => msg += `*${i+1}. ${r.nama}* (${r.jumlah} org)\n   üìç ${r.tempat} | ‚è∞ ${r.jam}\n   üçΩÔ∏è ${r.menu}\n\n`);
        } else {
            msg += `* Laporan Bulan: ${monthNames[currentMonth]} ${currentYear}*\n\n`;
            Object.keys(dataReservasi).sort().forEach(dateKey => {
                msg += `*üóìÔ∏è ${parseInt(dateKey.split('-')[1])} ${monthNames[currentMonth]}*:\n`;
                dataReservasi[dateKey].sort((a,b)=>a.jam.localeCompare(b.jam)).forEach(r => msg += ` - ${r.jam}, ${r.nama} (${r.jumlah} org), ${r.tempat}\n`);
                msg += '\n';
            });
        }
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }
    function shareViaEmail() {
        if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) return alert("Pilih tanggal dulu.");
        const date = `${parseInt(tanggalDipilih.split('-')[1])} ${monthNames[currentMonth]} ${currentYear}`;
        let body = `Detail Reservasi Dolan Sawah - ${date}:\n\n`;
        const list = [...dataReservasi[tanggalDipilih]].sort((a,b) => a.jam.localeCompare(b.jam));
        list.forEach((r,i) => body += `${i+1}. ${r.nama}\n   Tempat: ${r.tempat}\n   Jam: ${r.jam}\n   Jumlah: ${r.jumlah} org\n\n`);
        window.location.href = `mailto:?subject=Reservasi ${date}&body=${encodeURIComponent(body)}`;
    }
    function sortReservations(sortBy) {
        if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) return;
        const list = dataReservasi[tanggalDipilih];
        list.sort((a, b) => (a[sortBy] || '').localeCompare(b[sortBy] || ''));
        updateReservationList(list);
        document.getElementById('sortOptions').style.display = 'none';
    }
    async function showCustomerMenu() {
        alert("Mengambil data semua customer...");
        try {
            const snapshot = await db.collection('reservations').orderBy('nama').get();
            const customers = new Map();
            snapshot.forEach(doc => { const d=doc.data(); if (d.nama && d.nomorHp) customers.set(d.nomorHp, {name:d.nama, phone:d.nomorHp}); });
            const list = Array.from(customers.values());
            const content = `<html><head><title>Daftar Customer</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd}</style></head><body><h1>Daftar Customer (${list.length})</h1><table><tr><th>Nama</th><th>Nomor HP</th></tr>${list.map(c => `<tr><td>${c.name}</td><td>${c.phone}</td></tr>`).join('')}</table></body></html>`;
            const win = window.open(""); win.document.write(content); win.document.close();
        } catch (e) { alert("Gagal: " + e.message); }
    }
    function forceSync() { db.enableNetwork().then(() => alert('Sinkronisasi paksa berhasil.')).catch(() => alert('Gagal, cek koneksi internet.')); }
    function showExportData() {
        const exportObject = {};
        for (const dateKey in dataReservasi) {
            exportObject[dateKey] = dataReservasi[dateKey].map(res => ({ nama: res.nama, nomorHp: res.nomorHp, jam: res.jam, jumlah: res.jumlah, dp: res.dp, menu: res.menu, tempat: res.tempat, tambahan: res.tambahan, menuDetails: res.menuDetails }));
        }
        if (Object.keys(exportObject).length === 0) return alert(`Tidak ada data di bulan ${monthNames[currentMonth]} untuk diekspor.`);
        try {
            const jsonString = JSON.stringify(exportObject);
            document.getElementById('dataTransferCode').value = btoa(unescape(encodeURIComponent(jsonString)));
            document.getElementById('exportMonthName').textContent = monthNames[currentMonth];
            dataTransferDiv.style.display = 'block'; dataTransferDiv.scrollIntoView({ behavior: 'smooth' });
        } catch (e) { alert("Gagal membuat kode ekspor."); }
    }
    function copyExportCode() { const codeArea = document.getElementById('dataTransferCode'); codeArea.select(); document.execCommand('copy'); alert('Kode berhasil disalin!'); }
    function hideDataTransfer() { dataTransferDiv.style.display = 'none'; }
    function previousMonth() { currentMonth--; if(currentMonth < 0){currentMonth=11; currentYear--;} tanggalDipilih=''; summaryEl.style.display='none'; loadReservationsForCurrentMonth(); }
    function nextMonth() { currentMonth++; if(currentMonth > 11){currentMonth=0; currentYear++;} tanggalDipilih=''; summaryEl.style.display='none'; loadReservationsForCurrentMonth(); }
    function printData() { window.print(); }
    function toggleSortOptions(e){ e.stopPropagation(); document.getElementById('sortOptions').style.display = 'block'; }
    function toggleWhatsAppOptions(e){ e.stopPropagation(); document.getElementById('whatsappOptions').style.display = 'block'; }
    document.addEventListener('click', () => { 
        const sortOptions = document.getElementById('sortOptions');
        const whatsappOptions = document.getElementById('whatsappOptions');
        if (sortOptions) sortOptions.style.display = 'none'; 
        if (whatsappOptions) whatsappOptions.style.display = 'none'; 
    });
    function populateMenuDropdowns(selectId, selectedValue) {
        const select = document.getElementById(selectId);
        if (!select) return;
        const sortedMenuNames = Object.keys(detailMenu).sort((a, b) => a.localeCompare(b));
        select.innerHTML = '';
        sortedMenuNames.forEach(name => select.add(new Option(name, name)));
        if (selectedValue) select.value = selectedValue;
    }
    function showMenuManagement() {
        // Implementasi sederhana untuk kelengkapan
        const menuPopup = document.getElementById('menuManagementPopup');
        menuPopup.innerHTML = `<h3>Kelola Menu (Contoh)</h3><p>Fungsionalitas penuh akan ditambahkan di sini.</p><button class="danger" onclick="closeMenuManagement()">Tutup</button>`;
        menuPopup.style.display = 'block';
        overlay.style.display = 'block';
    }
    function closeMenuManagement() {
        document.getElementById('menuManagementPopup').style.display = 'none';
        overlay.style.display = 'none';
    }
    //... tambahkan fungsi lainnya jika diperlukan
</script>
</body>
</html>
