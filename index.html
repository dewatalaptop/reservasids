<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Reservasi Dolan Sawah (Firebase)</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; --primary-dark: #264653; --secondary: #e9c46a; --accent: #f4a261; --danger: #e76f51; --light: #f8f9fa; --dark: #343a40; --success: #28a745; --whatsapp: #25D366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f5f5f5; color: var(--dark);
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover; background-attachment: fixed; background-position: center; min-height: 100vh;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.85); z-index: -1;
    }
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 25px 20px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
    }
    header::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
    }
    header h2 { font-size: 2.2rem; margin-bottom: 5px; font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); }
    header small { display: block; font-size: 0.8rem; margin-top: 5px; color: rgba(255, 255, 255, 0.8); font-weight: 300; }
    .container {
      max-width: 1200px; margin: 30px auto; padding: 20px; background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: none;
    }
    #login-container {
      max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; border-top: 5px solid var(--primary);
    }
    #login-container h3 { color: var(--primary-dark); margin-bottom: 20px; font-size: 1.5rem; }
    #login-error { color: var(--danger); margin-top: 15px; font-weight: 500; display: none; }
    #logout-button {
        position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--danger);
        color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none;
    }
    .calendar-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .month-year { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); text-align: center; margin-bottom: 10px; }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-nav button { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; margin-bottom: 10px; color: var(--primary-dark); }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { min-height: 80px; padding: 8px; background-color: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); position: relative; border: 1px solid #eee; transition: all 0.3s; }
    .day-number { font-weight: 600; text-align: right; }
    .has-reservation { background-color: rgba(42, 157, 143, 0.1); border-left: 3px solid var(--primary); }
    .selected { background-color: var(--primary); color: white; }
    .selected .day-number { color: white; }
    .reservation-count { position: absolute; top: 5px; left: 5px; background-color: var(--success); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
    .selected .reservation-count { background-color: white; color: var(--primary); }
    .form-popup, .summary, .edit-form-popup, .menu-management-popup { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--primary); }
    button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-family: 'Poppins', sans-serif; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    button:hover { background-color: var(--primary-dark); }
    button.secondary { background-color: var(--secondary); color: var(--dark); }
    button.danger { background-color: var(--danger); }
    button.whatsapp { background-color: var(--whatsapp); }
    button.accent { background-color: var(--accent); color: white; }
    footer { text-align: center; font-size: 0.8rem; color: white; background-color: var(--primary-dark); padding: 15px; margin-top: 40px; }
    .menu-detail { margin-top: 8px; font-size: 0.85rem; color: #555; background-color: rgba(233, 196, 106, 0.1); padding: 8px; border-radius: 5px; border-left: 3px solid var(--secondary); }
    label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary-dark); }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; font-family: 'Poppins', sans-serif; }
    textarea { min-height: 80px; }
    .reservation-item { padding: 15px; margin-bottom: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border-left: 4px solid var(--primary); }
    .reservation-details { flex-grow: 1; width: 100%; }
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .action-buttons button { flex: 1 1 auto; min-width: 0; }
    .data-transfer { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; display: none; }
    .whatsapp-options-container, .sort-options-container { position: relative; display: inline-block; width: 100%; }
    .whatsapp-options, .sort-options { position: absolute; bottom: 100%; left: 0; width: 100%; margin-bottom: 5px; padding: 15px; border-radius: 8px; z-index: 10; display: none; background-color: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .data-actions { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; width: 100%; }
    .data-actions button { flex-grow: 1; padding: 8px 10px; font-size: 0.85rem; margin-top: 0; }
    .edit-form-popup, .menu-management-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 999; display: none; }
    .search-container { position: relative; margin: 0 auto 20px; max-width: 600px; width: 100%; }
    .search-container input { padding-left: 35px; border-radius: 30px; border: 2px solid var(--primary); }
    .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); }
    #menu-list-container { max-height: 300px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; }
    .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    .menu-item-actions button { padding: 5px 10px; font-size: 0.8rem; margin-top: 0; margin-left: 5px; }
    #add-menu-form { margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--primary); }
    @media (max-width: 480px) { .action-buttons, .data-actions { flex-direction: column; } .action-buttons button, .data-actions button { width: 100%; } }
  </style>
</head>
<body>
  <header>
    <h2><i class="fas fa-leaf"></i> Sistem Reservasi Dolan Sawah</h2>
    <small>Version 3.1 (Anti-Cache)</small>
  </header>
  <div id="login-container">
    <h3><i class="fas fa-lock"></i> Login Admin</h3>
    <label>Email: <input type="email" id="loginEmail" placeholder="Masukkan email admin"/></label>
    <label>Password: <input type="password" id="loginPassword" placeholder="Masukkan password"/></label>
    <button onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
    <p id="login-error">Email atau password salah.</p>
  </div>
  <button id="logout-button" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  <div class="container" id="main-container">
    <div class="calendar-header">
      <div class="month-year" id="monthYear"></div>
      <div class="calendar-nav">
        <button onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
        <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
    <div class="calendar-weekdays">
      <div>Min</div> <div>Sen</div> <div>Sel</div> <div>Rab</div> <div>Kam</div> <div>Jum</div> <div>Sab</div>
    </div>
    <div class="calendar-days" id="calendar"></div>
    <div id="summary" class="summary" style="display:none;">
      <h3><i class="far fa-calendar-alt"></i> Reservasi</h3>
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" oninput="filterReservations(this.value)" placeholder="Cari di tanggal yang dipilih...">
      </div>
      <div id="reservation-list-container"></div>
    </div>
    <div id="formPopup" class="form-popup" style="display:none;">
      <h3><i class="fas fa-calendar-plus"></i> Input Reservasi</h3>
      <form id="reservation-form">
        <label>Nama: <input type="text" id="nama" /></label>
        <label>Nomor HP: <input type="tel" id="nomorHp" /></label>
        <label>Jam Reservasi: <input type="time" id="jam" /></label>
        <label>Jumlah Peserta: <input type="number" id="jumlah" /></label>
        <label>DP (Rupiah): <input type="number" id="dp" value="0" /></label>
        <label>Menu: <select id="menu"></select></label>
        <label>Tempat: <select id="tempat"><option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option><option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option></select></label>
        <label>Request Tambahan: <textarea id="tambahan"></textarea></label>
        <button type="button" onclick="simpanReservasi()"> Simpan Reservasi</button>
      </form>
    </div>
    <div class="action-buttons">
      <button onclick="showCustomerMenu()"><i class="fas fa-address-book"></i> Customer</button>
      <button onclick="showMenuManagement()"><i class="fas fa-book-open"></i> Kelola Menu</button>
      <button onclick="printData()"><i class="fas fa-print"></i> Print</button>
      <div class="sort-options-container"><button class="secondary" onclick="toggleSortOptions(event)"><i class="fas fa-sort"></i> Urutkan</button><div class="sort-options" id="sortOptions"><p>Urutkan berdasarkan:</p><button onclick="sortReservations('jam')">Jam</button><button onclick="sortReservations('tempat')">Tempat</button></div></div>
      <button class="secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Email</button>
      <div class="whatsapp-options-container"><button class="whatsapp" onclick="toggleWhatsAppOptions(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button><div class="whatsapp-options" id="whatsappOptions"><p>Pilih opsi:</p><button class="whatsapp" onclick="shareViaWhatsApp('day')">1 Hari</button><button class="whatsapp" onclick="shareViaWhatsApp('month')">1 Bulan</button></div></div>
      <button class="accent" onclick="forceSync()"><i class="fas fa-sync-alt"></i> Sinkronisasi</button>
      <button onclick="showExportData()"><i class="fas fa-file-export"></i> Export</button>
    </div>
    <div class="data-transfer" id="dataTransfer">
      <h3><i class="fas fa-file-code"></i> Kode Ekspor Bulan <span id="exportMonthName"></span></h3>
      <textarea id="dataTransferCode" readonly></textarea>
      <button onclick="copyExportCode()"><i class="fas fa-copy"></i> Salin</button>
      <button class="danger" onclick="hideDataTransfer()">Tutup</button>
    </div>
  </div>
  <div id="editFormPopup" class="edit-form-popup"></div>
  <div id="menuManagementPopup" class="menu-management-popup"></div>
  <div class="overlay" id="overlay"></div>
  <footer><p><i class="fas fa-code"></i> Dibuat oleh Ryan</p></footer>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.firebasestorage.app",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    db.enablePersistence().catch(err => console.warn("Firebase persistence error: ", err.code));

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let dataReservasi = {};
    let detailMenu = {};
    let tanggalDipilih = '';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let unsubscribeReservations = null;
    const mainContainer = document.getElementById('main-container');
    const loginContainer = document.getElementById('login-container');
    const logoutButton = document.getElementById('logout-button');
    const monthYearEl = document.getElementById('monthYear');
    const calendarEl = document.getElementById('calendar');
    const summaryEl = document.getElementById('summary');
    const overlay = document.getElementById('overlay');

    auth.onAuthStateChanged(user => {
        if (user) {
            loginContainer.style.display = 'none'; mainContainer.style.display = 'block';
            logoutButton.style.display = 'inline-flex'; initializeApp();
        } else {
            loginContainer.style.display = 'block'; mainContainer.style.display = 'none';
            logoutButton.style.display = 'none';
        }
    });
    function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password).catch(err => alert('Login Gagal: ' + err.message));
    }
    function handleLogout() { if (confirm("Yakin ingin logout?")) auth.signOut(); }
    function initializeApp() { loadMenus(); loadReservationsForCurrentMonth(); }
    
    async function loadMenus() {
        try {
            const snapshot = await db.collection('menus').get();
            detailMenu = {};
            snapshot.forEach(doc => detailMenu[doc.id] = doc.data().details);
            populateMenuDropdowns(document.getElementById('menu'));
        } catch (e) { console.error("Gagal memuat menu:", e); }
    }
    function loadReservationsForCurrentMonth() {
        if (unsubscribeReservations) unsubscribeReservations();
        const monthStr = String(currentMonth + 1).padStart(2, '0');
        const startDate = `${currentYear}-${monthStr}-01`;
        const endDate = `${currentYear}-${monthStr}-${new Date(currentYear, currentMonth + 1, 0).getDate()}`;
        unsubscribeReservations = db.collection('reservations').where('date', '>=', startDate).where('date', '<=', endDate)
            .onSnapshot(snapshot => {
                dataReservasi = {};
                snapshot.forEach(doc => {
                    const r = { id: doc.id, ...doc.data() };
                    const dateKey = r.date.substring(5);
                    if (!dataReservasi[dateKey]) dataReservasi[dateKey] = [];
                    dataReservasi[dateKey].push(r);
                });
                buatKalender();
                if (tanggalDipilih) pilihTanggal(parseInt(tanggalDipilih.split('-')[1]), false);
            }, err => console.error("Error listener: ", err));
    }

    function buatKalender() {
        calendarEl.innerHTML = ''; monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) calendarEl.insertAdjacentHTML('beforeend', `<div class="calendar-day empty-day"></div>`);
        for (let i = 1; i <= daysInMonth; i++) {
            const dateKey = `${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const isToday = new Date().toDateString() === new Date(currentYear, currentMonth, i).toDateString() ? 'today' : '';
            const isSelected = dateKey === tanggalDipilih ? 'selected' : '';
            const hasRes = dataReservasi[dateKey] && dataReservasi[dateKey].length > 0;
            const countHTML = hasRes ? `<div class="reservation-count">${dataReservasi[dateKey].length}</div>` : '';
            const dayHTML = `<div class="calendar-day ${isToday} ${isSelected} ${hasRes ? 'has-reservation' : ''}" onclick="pilihTanggal(${i})"><div class="day-number">${i}</div>${countHTML}</div>`;
            calendarEl.insertAdjacentHTML('beforeend', dayHTML);
        }
    }
    function pilihTanggal(day, shouldScroll = true) {
        tanggalDipilih = `${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        buatKalender();
        updateReservationList(dataReservasi[tanggalDipilih] || []);
        summaryEl.querySelector('h3').innerHTML = `<i class="far fa-calendar-alt"></i> Reservasi ${day} ${monthNames[currentMonth]}`;
        summaryEl.style.display = 'block'; document.getElementById('formPopup').style.display = 'block';
        if (shouldScroll) summaryEl.scrollIntoView({ behavior: 'smooth' });
    }
    function updateReservationList(reservations) {
        const container = document.getElementById('reservation-list-container');
        container.innerHTML = !reservations || reservations.length === 0 ? `<p style="text-align:center;padding:20px 0;">Belum ada reservasi.</p>` : 
            reservations.map(r => {
                const menuItems = detailMenu[r.menu] || r.menuDetails || [];
                const isiMenu = menuItems.length ? menuItems.map(item => `• ${item}`).join('<br/>') : "-";
                const dpInfo = r.dp ? `<div><i class="fas fa-money-bill-wave"></i> DP: Rp${formatRupiah(r.dp)}</div>` : '';
                const phoneInfo = r.nomorHp ? `<div><i class="fas fa-phone"></i> ${r.nomorHp}</div>` : '';
                return `<div class="reservation-item"><div class="reservation-details"><b><i class="fas fa-user"></i> ${r.nama}</b><br/><span><i class="fas fa-map-marker-alt"></i> ${r.tempat} • <i class="far fa-clock"></i> ${r.jam} • <i class="fas fa-users"></i> ${r.jumlah} org</span>${dpInfo}${phoneInfo}<div class="menu-detail"><b><i class="fas fa-utensils"></i> ${r.menu}:</b><br />${isiMenu}</div><div><i class="fas fa-comment"></i> <b>Tambahan:</b> ${r.tambahan || '-'}</div></div><div class="data-actions">${r.nomorHp ? `<button class="whatsapp" onclick="contactViaWhatsApp('${r.id}')"><i class="fab fa-whatsapp"></i> Hubungi</button>` : ''}<button onclick="editReservasi('${r.id}')"><i class="fas fa-edit"></i> Edit</button><button class="danger" onclick="hapusReservasi('${r.id}')"><i class="fas fa-trash-alt"></i> Hapus</button></div></div>`;
            }).join('');
    }
    function filterReservations(query) {
        if (!tanggalDipilih) return;
        const q = query.toLowerCase();
        const filtered = (dataReservasi[tanggalDipilih] || []).filter(r => r.nama.toLowerCase().includes(q) || r.tempat.toLowerCase().includes(q) || r.menu.toLowerCase().includes(q));
        updateReservationList(filtered);
    }
    
    async function simpanReservasi() {
        const form = document.getElementById('reservation-form');
        const data = {
            nama: form.nama.value, nomorHp: form.nomorHp.value, jam: form.jam.value,
            jumlah: parseInt(form.jumlah.value), dp: parseInt(form.dp.value) || 0,
            menu: form.menu.value, tempat: form.tempat.value, tambahan: form.tambahan.value,
            date: `${currentYear}-${tanggalDipilih}`, menuDetails: detailMenu[form.menu.value] || [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!data.nama || !data.jam || !data.jumlah) return alert('Nama, Jam, dan Jumlah Peserta wajib diisi!');
        try { await db.collection('reservations').add(data); alert("Reservasi disimpan!"); form.reset(); } 
        catch (e) { alert("Gagal menyimpan: " + e.message); }
    }
    async function hapusReservasi(id) {
        if (confirm("Yakin ingin menghapus?")) {
            try { await db.collection('reservations').doc(id).delete(); } catch (e) { alert("Gagal menghapus: " + e.message); }
        }
    }
    function editReservasi(id) {
        const res = findReservationById(id); if (!res) return;
        const form = document.getElementById('editFormPopup');
        form.innerHTML = `<h3><i class="fas fa-edit"></i> Edit Reservasi</h3>
            <input type="hidden" id="editReservationId" value="${id}" />
            <label>Nama: <input type="text" id="editNama" value="${res.nama}" /></label>
            <label>Nomor HP: <input type="tel" id="editNomorHp" value="${res.nomorHp || ''}" /></label>
            <label>Jam: <input type="time" id="editJam" value="${res.jam}" /></label>
            <label>Jumlah: <input type="number" id="editJumlah" value="${res.jumlah}" /></label>
            <label>DP: <input type="number" id="editDp" value="${res.dp || 0}" /></label>
            <label>Menu: <select id="editMenu"></select></label>
            <label>Tempat: <select id="editTempat"><option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option><option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option></select></label>
            <label>Tambahan: <textarea id="editTambahan">${res.tambahan || ''}</textarea></label>
            <div class="data-actions"><button onclick="simpanPerubahanReservasi()"><i class="fas fa-save"></i> Simpan</button><button class="danger" onclick="tutupEditForm()">Batal</button></div>`;
        populateMenuDropdowns(form.querySelector('#editMenu'), res.menu);
        form.querySelector('#editTempat').value = res.tempat;
        form.style.display = 'block'; overlay.style.display = 'block';
    }
    async function simpanPerubahanReservasi() {
        const form = document.getElementById('editFormPopup');
        const id = form.querySelector('#editReservationId').value;
        const menu = form.querySelector('#editMenu').value;
        const data = {
            nama: form.querySelector('#editNama').value, nomorHp: form.querySelector('#editNomorHp').value, 
            jam: form.querySelector('#editJam').value, jumlah: parseInt(form.querySelector('#editJumlah').value), 
            dp: parseInt(form.querySelector('#editDp').value) || 0, menu: menu, 
            tempat: form.querySelector('#editTempat').value, tambahan: form.querySelector('#editTambahan').value,
            menuDetails: detailMenu[menu] || []
        };
        try { await db.collection('reservations').doc(id).update(data); tutupEditForm(); } 
        catch (e) { alert("Gagal menyimpan: " + e.message); }
    }
    function tutupEditForm() { document.getElementById('editFormPopup').style.display = 'none'; overlay.style.display = 'none'; }
    
    function showMenuManagement() {
        const popup = document.getElementById('menuManagementPopup');
        popup.innerHTML = `<h3><i class="fas fa-book-open"></i> Kelola Menu</h3><div id="menu-list-container"></div>
            <div id="add-menu-form"><h4><i class="fas fa-plus-circle"></i> Tambah Menu</h4>
            <label>Nama Menu: <input type="text" id="newMenuName" placeholder="Contoh: Paket Spesial"></label>
            <label>Detail Menu (pisahkan koma): <textarea id="newMenuDetails" placeholder="Nasi, Ayam Bakar"></textarea></label>
            <button onclick="addNewMenu()">Tambah Menu</button></div>
            <div class="data-actions"><button class="danger" onclick="closeMenuManagement()">Tutup</button></div>`;
        renderMenuList();
        popup.style.display = 'block'; overlay.style.display = 'block';
    }
    function renderMenuList() {
        const container = document.getElementById('menu-list-container'); if (!container) return;
        container.innerHTML = Object.keys(detailMenu).sort().map(name => 
            `<div class="menu-item"><span class="menu-item-name">${name}</span><div class="menu-item-actions"><button onclick="openEditMenuPopup('${name}')" title="Edit"><i class="fas fa-edit"></i></button><button class="danger" onclick="deleteMenu('${name}')" title="Hapus"><i class="fas fa-trash-alt"></i></button></div></div>`
        ).join('');
    }
    async function addNewMenu() {
        const name = document.getElementById('newMenuName').value.trim();
        const details = document.getElementById('newMenuDetails').value.split(',').map(s => s.trim()).filter(Boolean);
        if (!name) return alert('Nama menu kosong!'); if (detailMenu[name]) return alert('Menu sudah ada!');
        try {
            await db.collection('menus').doc(name).set({ details });
            alert(`Menu "${name}" ditambahkan.`);
            await loadMenus(); renderMenuList();
            document.getElementById('newMenuName').value = ''; document.getElementById('newMenuDetails').value = '';
        } catch (e) { alert("Gagal: " + e.message); }
    }
    async function deleteMenu(name) {
        if (confirm(`Yakin hapus menu "${name}"?`)) {
            try { await db.collection('menus').doc(name).delete(); alert(`Menu "${name}" dihapus.`); await loadMenus(); renderMenuList(); } 
            catch (e) { alert("Gagal: " + e.message); }
        }
    }
    function openEditMenuPopup(name) {
        const popup = document.getElementById('menuManagementPopup');
        popup.innerHTML = `<h3><i class="fas fa-edit"></i> Edit Menu</h3>
            <label>Nama Menu: <input type="text" id="editingMenuName" value="${name}"></label>
            <label>Detail (pisahkan koma): <textarea id="editingMenuDetails">${detailMenu[name].join(', ')}</textarea></label>
            <div class="data-actions"><button onclick="saveEditedMenu('${name}')"><i class="fas fa-save"></i> Simpan</button><button class="danger" onclick="showMenuManagement()">Batal</button></div>`;
    }
    async function saveEditedMenu(originalName) {
        const newName = document.getElementById('editingMenuName').value.trim();
        const newDetails = document.getElementById('editingMenuDetails').value.split(',').map(s => s.trim()).filter(Boolean);
        if (!newName) return alert('Nama menu kosong!');
        try {
            if (originalName !== newName) {
                if (detailMenu[newName]) return alert('Nama menu baru sudah ada!');
                await db.collection('menus').doc(originalName).delete();
            }
            await db.collection('menus').doc(newName).set({ details: newDetails });
            alert(`Menu "${newName}" diperbarui.`);
            await loadMenus(); showMenuManagement();
        } catch(e) { alert('Gagal: ' + e.message); }
    }
    function closeMenuManagement() { document.getElementById('menuManagementPopup').style.display = 'none'; overlay.style.display = 'none'; }

    function formatRupiah(amount) { return (amount || 0).toLocaleString('id-ID'); }
    function findReservationById(id) {
        for (const key in dataReservasi) { const found = dataReservasi[key].find(r => r.id === id); if (found) return found; } return null;
    }
    function contactViaWhatsApp(id) { /* ... fungsi ini sudah benar ... */ }
    function shareViaWhatsApp(scope) { /* ... fungsi ini sudah benar ... */ }
    function shareViaEmail() { /* ... fungsi ini sudah benar ... */ }
    function sortReservations(sortBy) { /* ... fungsi ini sudah benar ... */ }
    async function showCustomerMenu() { /* ... fungsi ini sudah benar ... */ }
    function forceSync() { db.enableNetwork().then(() => alert('Sinkronisasi paksa berhasil.')).catch(() => alert('Gagal.')); }
    function showExportData() { /* ... fungsi ini sudah benar ... */ }
    function copyExportCode() { const c = document.getElementById('dataTransferCode'); c.select(); document.execCommand('copy'); alert('Kode disalin!'); }
    function hideDataTransfer() { document.getElementById('dataTransfer').style.display = 'none'; }
    function previousMonth() { currentMonth--; if(currentMonth < 0){currentMonth=11; currentYear--;} tanggalDipilih=''; summaryEl.style.display='none'; document.getElementById('formPopup').style.display='none'; loadReservationsForCurrentMonth(); }
    function nextMonth() { currentMonth++; if(currentMonth > 11){currentMonth=0; currentYear++;} tanggalDipilih=''; summaryEl.style.display='none'; document.getElementById('formPopup').style.display='none'; loadReservationsForCurrentMonth(); }
    function printData() { window.print(); }
    
    /* --- PERBAIKAN: Logika Tombol Menu Bawah --- */
    function toggleSortOptions(event) {
        event.stopPropagation();
        const sortOptions = document.getElementById('sortOptions');
        const whatsappOptions = document.getElementById('whatsappOptions');
        whatsappOptions.style.display = 'none';
        sortOptions.style.display = sortOptions.style.display === 'block' ? 'none' : 'block';
    }
    function toggleWhatsAppOptions(event) {
        event.stopPropagation();
        const sortOptions = document.getElementById('sortOptions');
        const whatsappOptions = document.getElementById('whatsappOptions');
        sortOptions.style.display = 'none';
        whatsappOptions.style.display = whatsappOptions.style.display === 'block' ? 'none' : 'block';
    }
    document.addEventListener('click', () => { 
        document.querySelectorAll('.sort-options, .whatsapp-options').forEach(el => el.style.display = 'none'); 
    });
    
    function populateMenuDropdowns(selectElement, selectedValue) {
        if (!selectElement) return;
        const sortedMenuNames = Object.keys(detailMenu).sort();
        selectElement.innerHTML = '';
        if (sortedMenuNames.length === 0) {
            selectElement.add(new Option('Tidak Ada Pilihan', ''));
        } else {
            sortedMenuNames.forEach(name => selectElement.add(new Option(name, name)));
        }
        if (selectedValue) selectElement.value = selectedValue;
    }
</script>
</body>
</html>
