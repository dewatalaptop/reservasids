<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alat Migrasi Data ke Firebase</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { max-width: 500px; width: 90%; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        h1 { color: #264653; }
        p { color: #555; }
        button { background-color: #2a9d8f; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-top: 15px; transition: background-color 0.3s; }
        button:hover { background-color: #264653; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #login-form, #migration-tool { display: none; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        #log { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #eee; border-radius: 5px; text-align: left; max-height: 200px; overflow-y: auto; font-size: 0.9rem; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Alat Migrasi Data</h1>
        
        <div id="login-form">
            <p>Silakan login dengan akun admin Firebase Anda untuk memulai.</p>
            <input type="email" id="loginEmail" placeholder="Email Admin">
            <input type="password" id="loginPassword" placeholder="Password">
            <button onclick="handleLogin()">Login</button>
        </div>

        <div id="migration-tool">
            <p>Alat ini akan membaca semua data reservasi dari penyimpanan lokal (localStorage) di perangkat ini dan mengunggahnya ke server Firebase. Proses ini hanya perlu dilakukan **satu kali**.</p>
            <button id="migrate-button" onclick="startMigration()">Mulai Migrasi Data</button>
            <div id="log">Status Log akan muncul di sini...</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
            authDomain: "reservasi-dolan-sawah.firebaseapp.com",
            projectId: "reservasi-dolan-sawah",
            storageBucket: "reservasi-dolan-sawah.firebasestorage.app",
            messagingSenderId: "213151400721",
            appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const loginForm = document.getElementById('login-form');
        const migrationTool = document.getElementById('migration-tool');
        const migrateButton = document.getElementById('migrate-button');
        const log = document.getElementById('log');

        auth.onAuthStateChanged(user => {
            if (user) {
                loginForm.style.display = 'none';
                migrationTool.style.display = 'block';
                log.innerHTML = `Login berhasil sebagai: <strong>${user.email}</strong>.<br>Siap untuk migrasi.`;
            } else {
                loginForm.style.display = 'block';
                migrationTool.style.display = 'none';
            }
        });

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password).catch(err => alert('Login gagal: ' + err.message));
        }

        function addToLog(message) {
            log.innerHTML += message + '<br>';
            log.scrollTop = log.scrollHeight;
        }

        async function startMigration() {
            if (!confirm("Apakah Anda yakin ingin memulai migrasi? Proses ini akan mengunggah semua data dari HP ini ke server.")) {
                return;
            }

            migrateButton.disabled = true;
            migrateButton.textContent = "Sedang Memproses...";
            addToLog("Memulai migrasi...");

            const localData = JSON.parse(localStorage.getItem('reservasiDolan'));

            if (!localData || Object.keys(localData).length === 0) {
                addToLog("<strong>Kesalahan:</strong> Tidak ada data reservasi yang ditemukan di localStorage perangkat ini.");
                migrateButton.disabled = false;
                migrateButton.textContent = "Mulai Migrasi Data";
                return;
            }

            addToLog(`Ditemukan data untuk ${Object.keys(localData).length} tanggal.`);
            
            const currentYear = new Date().getFullYear();
            const today = new Date();
            today.setHours(0,0,0,0);

            let totalReservations = 0;
            const uploadPromises = [];

            for (const dateKey in localData) { // dateKey is "MM-DD"
                const reservationsOnDate = localData[dateKey];
                
                const [month, day] = dateKey.split('-');
                let year = currentYear;
                
                // Logic to handle dates from the past vs future
                const dateForYearCheck = new Date(currentYear, parseInt(month) - 1, parseInt(day));
                if (dateForYearCheck < today) {
                    // If the date has already passed this year, assume it's for next year.
                    // This logic might need adjustment based on your booking patterns.
                    // For simplicity now, we assume most bookings are for the current or next year.
                    // A safe bet is to use the current year for everything for now.
                    // If you book far in advance, this might need adjustment.
                }

                const fullDate = `${year}-${month}-${day}`;
                
                addToLog(`- Memproses tanggal ${fullDate}...`);

                for (const reservation of reservationsOnDate) {
                    totalReservations++;
                    const reservationData = {
                        nama: reservation.nama || 'Tanpa Nama',
                        nomorHp: reservation.nomorHp || '',
                        jam: reservation.jam || '00:00',
                        jumlah: parseInt(reservation.jumlah) || 0,
                        dp: parseInt(reservation.dp) || 0,
                        menu: reservation.menu || 'Tidak ada',
                        tempat: reservation.tempat || 'Tidak ada',
                        tambahan: reservation.tambahan || '',
                        menuDetails: reservation.menuDetails || [],
                        date: fullDate, // Important: Full date format YYYY-MM-DD
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Add a new document to Firestore
                    uploadPromises.push(db.collection('reservations').add(reservationData));
                }
            }

            try {
                await Promise.all(uploadPromises);
                addToLog(`------------------------------------`);
                addToLog(`<strong>SUKSES!</strong> Sebanyak <strong>${totalReservations}</strong> data reservasi berhasil diunggah ke Firebase.`);
                addToLog(`Anda sekarang aman untuk menggunakan versi website yang baru.`);
                migrateButton.textContent = "Migrasi Selesai";
            } catch (error) {
                console.error("Migration error:", error);
                addToLog(`<strong>GAGAL:</strong> Terjadi kesalahan saat mengunggah data. Cek console log.`);
                migrateButton.disabled = false;
                migrateButton.textContent = "Coba Migrasi Lagi";
            }
        }
    </script>
</body>
</html>
