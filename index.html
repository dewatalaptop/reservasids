<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Reservasi Dolan Sawah (Firebase)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; --primary-dark: #264653; --secondary: #e9c46a; --accent: #f4a261; --danger: #e76f51; --light: #f8f9fa; --dark: #343a40; --success: #28a745; --whatsapp: #25D366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f5f5f5; color: var(--dark);
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover; background-attachment: fixed; background-position: center; min-height: 100vh;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.85); z-index: -1;
    }
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 25px 20px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
    }
    header::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
    }
    header h2 { font-size: 2.2rem; margin-bottom: 5px; font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); }
    header small { display: block; font-size: 0.8rem; margin-top: 5px; color: rgba(255, 255, 255, 0.8); font-weight: 300; }
    .container {
      max-width: 1200px; margin: 30px auto; padding: 20px; background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: none; /* Hidden by default */
    }
    #login-container {
      max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; border-top: 5px solid var(--primary);
    }
    #login-container h3 { color: var(--primary-dark); margin-bottom: 20px; font-size: 1.5rem; }
    #login-error { color: var(--danger); margin-top: 15px; font-weight: 500; display: none; }
    #logout-button {
        position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--danger);
        color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none; /* Hidden by default */
    }
    .calendar-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .month-year { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); text-align: center; margin-bottom: 10px; }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-nav button { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
    .calendar-nav button:hover { background-color: var(--primary-dark); }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; margin-bottom: 10px; color: var(--primary-dark); }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { min-height: 80px; padding: 8px; background-color: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); position: relative; border: 1px solid #eee; transition: all 0.3s; }
    .calendar-day:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
    .day-number { font-weight: 600; margin-bottom: 5px; text-align: right; position: relative; padding-right: 8px; }
    .has-reservation { background-color: rgba(42, 157, 143, 0.1); border-left: 3px solid var(--primary); }
    .selected { background-color: var(--primary); color: white; }
    .selected .day-number { color: white; }
    .reservation-count { position: absolute; top: -10px; right: -8px; background-color: var(--success); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .selected .reservation-count { background-color: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .warning { background-color: var(--danger); color: white; padding: 12px; margin-top: 15px; border-radius: 6px; text-align: center; display: none; font-weight: 500; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    .form-popup, .summary, .edit-form-popup, .menu-management-popup { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--primary); }
    .form-popup h3, .summary h3, .edit-form-popup h3, .menu-management-popup h3 { color: var(--primary-dark); margin-bottom: 15px; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    .form-popup h3 i, .summary h3 i, .edit-form-popup h3 i, .menu-management-popup h3 i { color: var(--accent); }
    button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-family: 'Poppins', sans-serif; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    button:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    button.secondary { background-color: var(--secondary); color: var(--dark); }
    button.danger { background-color: var(--danger); }
    button.whatsapp { background-color: var(--whatsapp); }
    footer { text-align: center; font-size: 0.8rem; color: white; background-color: var(--primary-dark); padding: 15px; margin-top: 40px; position: relative; }
    footer::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--secondary), var(--accent)); }
    .menu-detail { margin-top: 8px; font-size: 0.85rem; color: #555; background-color: rgba(233, 196, 106, 0.1); padding: 8px; border-radius: 5px; border-left: 3px solid var(--secondary); }
    .menu-detail b { font-size: 0.9rem; display: block; margin-bottom: 5px; color: var(--primary-dark); }
    label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary-dark); }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2); }
    textarea { min-height: 80px; resize: vertical; }
    .reservation-item { padding: 15px; margin-bottom: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border-left: 4px solid var(--primary); position: relative; display: flex; justify-content: space-between; align-items: center; }
    .reservation-details { flex-grow: 1; }
    .reservation-item hr { border: none; border-top: 1px dashed #eee; margin: 10px 0; }
    .reservation-item b { color: var(--primary-dark); }
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .action-buttons button { flex: 1 1 auto; min-width: 0; }
    .capacity-meter { height: 8px; background-color: #eee; border-radius: 4px; margin-top: 15px; overflow: hidden; }
    .capacity-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--accent)); width: 0%; transition: width 0.5s ease; }
    .capacity-info { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; color: #666; }
    .empty-day { color: #ccc; background-color: #f9f9f9; }
    .today { background-color: rgba(233, 196, 106, 0.3); border: 1px solid var(--secondary); }
    .whatsapp-options-container, .sort-options-container { position: relative; display: inline-block; width: 100%; }
    .whatsapp-options, .sort-options { position: absolute; top: 100%; left: 0; width: 100%; margin-top: 5px; padding: 15px; border-radius: 8px; z-index: 10; display: none; }
    .whatsapp-options { background-color: rgba(37, 211, 102, 0.1); border-left: 3px solid var(--whatsapp); }
    .sort-options { background-color: rgba(42, 157, 143, 0.1); border-left: 3px solid var(--primary); }
    .whatsapp-options p, .sort-options p { margin-bottom: 10px; font-weight: 500; color: var(--dark); }
    .whatsapp-options button, .sort-options button { margin-top: 5px; width: 100%; }
    .data-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .data-actions button { flex: 1 1 auto; min-width: 0; }
    .data-transfer { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--accent); display: none; }
    .data-transfer h3 { color: var(--primary-dark); margin-bottom: 15px; font-size: 1.4rem; }
    .data-transfer textarea { width: 100%; min-height: 150px; }
    .edit-form-popup, .menu-management-popup, #editMenuPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px; }
    .edit-form-popup label, .menu-management-popup label, #editMenuPopup label { margin-bottom: 8px; }
    .edit-form-popup button, .menu-management-popup button, #editMenuPopup button { margin-right: 10px; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; display: none; }
    .dp-info { margin-top: 5px; font-size: 0.85rem; color: #2a9d8f; font-weight: 500; }
    .search-container { position: relative; margin: 0 auto 20px; max-width: 600px; width: 100%; }
    .search-container input { padding-left: 35px; border-radius: 30px; border: 2px solid var(--primary); background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); }
    .global-search-container { position: sticky; top: 10px; z-index: 100; padding: 0 20px; margin-bottom: 20px; }
    .search-results-container { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--primary); display: none; }
    .search-results-container h3 { color: var(--primary-dark); margin-bottom: 15px; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    .search-results-container h3 i { color: var(--accent); }
    .location-warning { background-color: rgba(231, 111, 81, 0.1); border-left: 3px solid var(--danger); padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.85rem; color: var(--danger); font-weight: 500; }
    #menu-list-container { max-height: 300px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; }
    .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; background-color: var(--light); }
    .menu-item-name { font-weight: 500; }
    .menu-item-actions button { padding: 5px 10px; font-size: 0.8rem; margin-top: 0; margin-left: 5px; }
    #add-menu-form { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    @media (max-width: 768px) {
      .calendar-day { min-height: 60px; padding: 5px; } .container { padding: 15px; } .month-year { font-size: 1.2rem; } .action-buttons, .data-actions { flex-direction: row; gap: 8px; } button { width: auto; flex-grow: 1; font-size: 0.9rem; padding: 8px 12px; } .reservation-item { flex-direction: column; align-items: flex-start; } .data-actions { margin-top: 10px; } .whatsapp-options, .sort-options { position: relative; width: 100%; margin-top: 10px; }
    }
    @media (max-width: 480px) {
      .calendar-header { flex-direction: column; gap: 10px; } header h2 { font-size: 1.8rem; } .calendar-day { min-height: 50px; font-size: 0.8rem; } .day-number { margin-bottom: 2px; } .reservation-count { width: 18px; height: 18px; font-size: 0.6rem; top: -8px; right: -6px; } .action-buttons, .data-actions { flex-direction: column; } button { width: 100%; }
    }
  </style>
</head>
<body>

  <header>
    <h2><i class="fas fa-leaf"></i> Sistem Reservasi Dolan Sawah</h2>
    <small>Version 2.2 (Export Re-enabled)</small>
  </header>

  <div id="login-container">
    <h3><i class="fas fa-lock"></i> Login Admin</h3>
    <label>Email: <input type="email" id="loginEmail" placeholder="Masukkan email admin"/></label>
    <label>Password: <input type="password" id="loginPassword" placeholder="Masukkan password"/></label>
    <button onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
    <p id="login-error">Email atau password salah.</p>
  </div>
  
  <button id="logout-button" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>

  <div class="container" id="main-container">
    <div class="global-search-container">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="globalSearchInput" placeholder="Cari reservasi berdasarkan nama...">
      </div>
    </div>

    <div class="search-results-container" id="searchResults">
      <h3><i class="fas fa-search"></i> Hasil Pencarian</h3>
      <div id="searchResultsContent"></div>
    </div>

    <div class="calendar-header">
      <div class="month-year" id="monthYear"></div>
      <div class="calendar-nav">
        <button onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
        <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>

    <div class="calendar-weekdays">
      <div>Minggu</div> <div>Senin</div> <div>Selasa</div> <div>Rabu</div> <div>Kamis</div> <div>Jumat</div> <div>Sabtu</div>
    </div>

    <div class="calendar-days" id="calendar"></div>

    <div class="warning" id="warningBox">
      <i class="fas fa-exclamation-triangle"></i> Kapasitas hampir penuh!
    </div>

    <div class="summary" id="summary" style="display:none;">
      <h3><i class="far fa-calendar-alt"></i> Reservasi</h3>
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Cari berdasarkan nama, tempat, atau menu...">
      </div>
    </div>

    <div class="form-popup" id="formPopup" style="display:none;">
      <h3><i class="fas fa-calendar-plus"></i> Input Reservasi</h3>
      <form id="reservation-form">
        <label><i class="fas fa-user"></i> Nama: <input type="text" id="nama" placeholder="Nama pemesan"/></label>
        <label><i class="fas fa-phone"></i> Nomor HP: <input type="tel" id="nomorHp" placeholder="Contoh: 081234567890"/></label>
        <label><i class="fas fa-clock"></i> Jam Reservasi: <input type="time" id="jam" /></label>
        <label><i class="fas fa-users"></i> Jumlah Peserta: <input type="number" id="jumlah" placeholder="Jumlah orang"/></label>
        <label><i class="fas fa-money-bill-wave"></i> DP (Rupiah): <input type="number" id="dp" value="0"/></label>
        <label><i class="fas fa-utensils"></i> Menu: <select id="menu"></select></label>
        <label><i class="fas fa-map-marker-alt"></i> Tempat:
          <select id="tempat">
            <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
            <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
          </select>
        </label>
        <label><i class="fas fa-comment-dots"></i> Request Tambahan: <textarea id="tambahan"></textarea></label>
        <button type="button" onclick="simpanReservasi()"><i class="fas fa-save"></i> Simpan Reservasi</button>
      </form>
    </div>

    <div class="action-buttons">
      <button onclick="showCustomerMenu()"><i class="fas fa-address-book"></i> Data Customer</button>
      <button onclick="showMenuManagement()"><i class="fas fa-book-open"></i> Kelola Menu</button>
      <button onclick="printData()"><i class="fas fa-print"></i> Print</button>
      <div class="sort-options-container">
        <button class="secondary" onclick="toggleSortOptions(event)"><i class="fas fa-sort"></i> Urutkan Data</button>
        <div class="sort-options" id="sortOptions">
          <p>Urutkan berdasarkan:</p>
          <button onclick="sortReservations('jam')"><i class="fas fa-clock"></i> Jam</button>
          <button onclick="sortReservations('tempat')"><i class="fas fa-map-marker-alt"></i> Tempat</button>
        </div>
      </div>
      <button class="secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Email</button>
      <div class="whatsapp-options-container">
        <button class="whatsapp" onclick="toggleWhatsAppOptions(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>
        <div class="whatsapp-options" id="whatsappOptions">
          <p>Pilih opsi:</p>
          <button class="whatsapp" onclick="shareViaWhatsApp('day')"><i class="fab fa-whatsapp"></i> Bagikan 1 Hari</button>
          <button class="whatsapp" onclick="shareViaWhatsApp('month')"><i class="fab fa-whatsapp"></i> Bagikan 1 Bulan</button>
        </div>
      </div>
      <button class="accent" onclick="forceSync()"><i class="fas fa-sync-alt"></i> Paksa Sinkronisasi</button>
      <button onclick="showExportData()"><i class="fas fa-file-export"></i> Export Data Bulan Ini</button>
    </div>

    <div class="data-transfer" id="dataTransfer">
      <h3><i class="fas fa-file-code"></i> Kode Ekspor untuk Bulan <span id="exportMonthName"></span></h3>
      <p>Salin kode di bawah ini untuk ditempel di website lain.</p>
      <textarea id="dataTransferCode" readonly></textarea>
      <button onclick="copyExportCode()"><i class="fas fa-copy"></i> Salin Kode</button>
      <button class="danger" onclick="hideDataTransfer()"><i class="fas fa-times-circle"></i> Tutup</button>
    </div>
  </div>

  <div class="edit-form-popup" id="editFormPopup">
    <h3><i class="fas fa-edit"></i> Edit Reservasi</h3>
    <input type="hidden" id="editReservationId" />
    <label><i class="fas fa-user"></i> Nama: <input type="text" id="editNama" /></label>
    <label><i class="fas fa-phone"></i> Nomor HP: <input type="tel" id="editNomorHp" /></label>
    <label><i class="fas fa-clock"></i> Jam Reservasi: <input type="time" id="editJam" /></label>
    <label><i class="fas fa-users"></i> Jumlah Peserta: <input type="number" id="editJumlah" /></label>
    <label><i class="fas fa-money-bill-wave"></i> DP (Rupiah): <input type="number" id="editDp" /></label>
    <label><i class="fas fa-utensils"></i> Menu: <select id="editMenu"></select></label>
    <label><i class="fas fa-map-marker-alt"></i> Tempat:
      <select id="editTempat">
        <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
        <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
      </select>
    </label>
    <label><i class="fas fa-comment-dots"></i> Request Tambahan: <textarea id="editTambahan"></textarea></label>
    <div class="data-actions">
      <button onclick="simpanPerubahanReservasi()"><i class="fas fa-save"></i> Simpan</button>
      <button class="danger" onclick="tutupEditForm()"><i class="fas fa-times-circle"></i> Batal</button>
    </div>
  </div>
  
  <div class="menu-management-popup" id="menuManagementPopup">
      <h3><i class="fas fa-book-open"></i> Kelola Menu</h3>
      <div id="menu-list-container"></div>
      <div id="add-menu-form">
          <h4><i class="fas fa-plus-circle"></i> Tambah Menu Baru</h4>
          <label>Nama Menu: <input type="text" id="newMenuName"></label>
          <label>Detail Menu (pisahkan koma): <textarea id="newMenuDetails"></textarea></label>
          <button onclick="addNewMenu()"><i class="fas fa-plus"></i> Tambah</button>
      </div>
      <div class="data-actions" style="margin-top:20px;">
          <button class="danger" onclick="closeMenuManagement()"><i class="fas fa-times-circle"></i> Tutup</button>
      </div>
  </div>
  
  <div class="menu-management-popup" id="editMenuPopup">
      <h3><i class="fas fa-edit"></i> Edit Menu</h3>
      <input type="hidden" id="editMenuId">
      <label>Nama Menu: <input type="text" id="editingMenuName"></label>
      <label>Detail Menu (pisahkan koma): <textarea id="editingMenuDetails"></textarea></label>
      <div class="data-actions">
        <button onclick="saveEditedMenu()"><i class="fas fa-save"></i> Simpan</button>
        <button class="danger" onclick="closeEditMenuPopup()"><i class="fas fa-times-circle"></i> Batal</button>
      </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <footer>
    <p><i class="fas fa-code"></i> Dibuat <i class="fas fa-heart" style="color: #e76f51;"></i> oleh Ryan</p>
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.firebasestorage.app",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0",
      measurementId: "G-NKZCFHKQ7Q"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    db.enablePersistence().catch(err => {
        if (err.code == 'failed-precondition') console.warn('Persistence failed: Multiple tabs open.');
        else if (err.code == 'unimplemented') console.warn('Persistence failed: Browser not supported.');
    });

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let dataReservasi = {};
    let detailMenu = {};
    let tanggalDipilih = '';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let unsubscribeReservations = null;

    // --- ELEMENT SELECTORS ---
    const mainContainer = document.getElementById('main-container');
    const loginContainer = document.getElementById('login-container');
    const logoutButton = document.getElementById('logout-button');
    const monthYearEl = document.getElementById('monthYear');
    const calendarEl = document.getElementById('calendar');
    const summaryEl = document.getElementById('summary');
    const formPopup = document.getElementById('formPopup');
    const dataTransferDiv = document.getElementById('dataTransfer');

    // --- AUTH & INITIALIZATION ---
    auth.onAuthStateChanged(user => {
        if (user) {
            loginContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            logoutButton.style.display = 'inline-flex';
            initializeApp();
        } else {
            loginContainer.style.display = 'block';
            mainContainer.style.display = 'none';
            logoutButton.style.display = 'none';
        }
    });

    function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password).catch(err => alert('Login Gagal: ' + err.message));
    }

    function handleLogout() { if (confirm("Yakin ingin logout?")) auth.signOut(); }
    function initializeApp() { loadMenus(); loadReservationsForCurrentMonth(); }
    
    // --- DATA LOADING ---
    async function loadMenus() {
        const snapshot = await db.collection('menus').get();
        detailMenu = {};
        snapshot.forEach(doc => detailMenu[doc.id] = doc.data().details);
        // Simplified populate dropdowns logic here for brevity
        const menuSelects = [document.getElementById('menu'), document.getElementById('editMenu')];
        const sortedMenuNames = Object.keys(detailMenu).sort((a, b) => a.localeCompare(b));
        menuSelects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            sortedMenuNames.forEach(name => select.add(new Option(name, name)));
        });
    }

    function loadReservationsForCurrentMonth() {
        if (unsubscribeReservations) unsubscribeReservations();
        const monthStr = String(currentMonth + 1).padStart(2, '0');
        const startDate = `${currentYear}-${monthStr}-01`;
        const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
        const endDate = `${currentYear}-${monthStr}-${String(lastDay).padStart(2, '0')}`;
        
        unsubscribeReservations = db.collection('reservations')
            .where('date', '>=', startDate).where('date', '<=', endDate)
            .onSnapshot(snapshot => {
                dataReservasi = {};
                snapshot.forEach(doc => {
                    const reservation = { id: doc.id, ...doc.data() };
                    const dateKey = reservation.date.substring(5);
                    if (!dataReservasi[dateKey]) dataReservasi[dateKey] = [];
                    dataReservasi[dateKey].push(reservation);
                });
                buatKalender();
                if (tanggalDipilih) {
                    const day = parseInt(tanggalDipilih.split('-')[1]);
                    pilihTanggal(day, false);
                }
            });
    }
    
    // --- EXPORT FUNCTIONALITY (RE-IMPLEMENTED) ---
    function showExportData() {
        const exportObject = {};
        // Create a clean object that matches the old localStorage structure
        for (const dateKey in dataReservasi) {
            exportObject[dateKey] = dataReservasi[dateKey].map(res => ({
                nama: res.nama,
                nomorHp: res.nomorHp,
                jam: res.jam,
                jumlah: res.jumlah,
                dp: res.dp,
                menu: res.menu,
                tempat: res.tempat,
                tambahan: res.tambahan,
                menuDetails: res.menuDetails
            }));
        }

        if (Object.keys(exportObject).length === 0) {
            alert(`Tidak ada data reservasi di bulan ${monthNames[currentMonth]} untuk diekspor.`);
            return;
        }

        try {
            const jsonString = JSON.stringify(exportObject);
            const compressedData = btoa(unescape(encodeURIComponent(jsonString)));
            document.getElementById('dataTransferCode').value = compressedData;
            document.getElementById('exportMonthName').textContent = monthNames[currentMonth];
            dataTransferDiv.style.display = 'block';
            dataTransferDiv.scrollIntoView({ behavior: 'smooth' });
        } catch (e) {
            alert("Gagal membuat kode ekspor.");
            console.error("Export error:", e);
        }
    }

    function copyExportCode() {
        const codeArea = document.getElementById('dataTransferCode');
        codeArea.select();
        document.execCommand('copy');
        alert('Kode ekspor berhasil disalin!');
    }

    function hideDataTransfer() {
        dataTransferDiv.style.display = 'none';
    }


    // --- CORE APP & UI FUNCTIONS ---
    function forceSync() {
        db.enableNetwork().then(() => {
            alert('Sinkronisasi paksa berhasil. Koneksi ke server disegarkan.');
        }).catch(() => {
            alert('Gagal menjalankan sinkronisasi. Cek koneksi internet.');
        });
    }

    function buatKalender() {
        calendarEl.innerHTML = ''; monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) calendarEl.appendChild(Object.assign(document.createElement('div'), { className: 'calendar-day empty-day' }));
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div'); dayEl.className = 'calendar-day';
            if (new Date().getFullYear() === currentYear && new Date().getMonth() === currentMonth && new Date().getDate() === i) dayEl.classList.add('today');
            const dayNumber = Object.assign(document.createElement('div'), { className: 'day-number', textContent: i });
            const dateKey = `${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            if (dataReservasi[dateKey] && dataReservasi[dateKey].length > 0) {
                dayEl.classList.add('has-reservation');
                const count = Object.assign(document.createElement('div'), { className: 'reservation-count', textContent: dataReservasi[dateKey].length });
                dayNumber.appendChild(count);
            }
            dayEl.appendChild(dayNumber);
            if (dateKey === tanggalDipilih) dayEl.classList.add('selected');
            dayEl.onclick = () => pilihTanggal(i);
            calendarEl.appendChild(dayEl);
        }
    }

    function pilihTanggal(day, shouldScroll = true) {
        tanggalDipilih = `${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        buatKalender(); // Re-render to show selection
        const reservationsForDay = dataReservasi[tanggalDipilih] || [];
        updateReservationList(reservationsForDay);
        summaryEl.querySelector('h3').innerHTML = `<i class="far fa-calendar-alt"></i> Reservasi ${day} ${monthNames[currentMonth]}`;
        summaryEl.style.display = 'block'; formPopup.style.display = 'block';
        if (shouldScroll) formPopup.scrollIntoView({ behavior: 'smooth' });
    }
    
    function updateReservationList(reservations) {
        const existingContainer = summaryEl.querySelector('#reservation-list-container');
        if (existingContainer) existingContainer.remove();
        const container = Object.assign(document.createElement('div'), { id: 'reservation-list-container' });
        summaryEl.appendChild(container);
        if (reservations.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: #666; padding: 20px 0;">Belum ada reservasi.</p>`;
        } else {
            reservations.forEach(r => {
                const menuItems = detailMenu[r.menu] || r.menuDetails || [];
                const isiMenu = menuItems.length ? menuItems.map(item => `• ${item}`).join('<br/>') : "-";
                const dpInfo = r.dp ? `<div class="dp-info"><i class="fas fa-money-bill-wave"></i> DP: Rp${r.dp.toLocaleString('id-ID')}</div>` : '';
                const phoneInfo = r.nomorHp ? `<div><i class="fas fa-phone"></i> ${r.nomorHp}</div>` : '';
                const div = document.createElement('div'); div.className = 'reservation-item';
                div.innerHTML = `<div class="reservation-details"><b><i class="fas fa-user"></i> ${r.nama}</b><br/><span><i class="fas fa-map-marker-alt"></i> ${r.tempat} • <i class="far fa-clock"></i> ${r.jam} • <i class="fas fa-users"></i> ${r.jumlah} org</span>${dpInfo}${phoneInfo}<div class="menu-detail"><b><i class="fas fa-utensils"></i> ${r.menu}:</b><br />${isiMenu}</div><div><i class="fas fa-comment"></i> <b>Tambahan:</b> ${r.tambahan || '-'}</div></div><div class="data-actions"><button onclick="editReservasi('${r.id}')"><i class="fas fa-edit"></i> Edit</button><button class="danger" onclick="hapusReservasi('${r.id}')"><i class="fas fa-trash-alt"></i> Hapus</button></div>`;
                container.appendChild(div);
            });
        }
    }

    // --- CRUD ---
    async function simpanReservasi() {
        const form = document.getElementById('reservation-form');
        const reservationData = {
            nama: form.nama.value, nomorHp: form.nomorHp.value, jam: form.jam.value,
            jumlah: parseInt(form.jumlah.value), dp: parseInt(form.dp.value) || 0,
            menu: form.menu.value, tempat: form.tempat.value, tambahan: form.tambahan.value,
            date: `${currentYear}-${tanggalDipilih}`, menuDetails: detailMenu[form.menu.value] || [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!reservationData.nama || !reservationData.jam || !reservationData.jumlah) return alert('Harap isi field yang wajib!');
        try {
            await db.collection('reservations').add(reservationData);
            alert("Reservasi berhasil disimpan!"); form.reset();
        } catch (e) { alert("Gagal menyimpan: " + e.message); }
    }

    async function hapusReservasi(id) {
        if (confirm("Yakin ingin menghapus?")) {
            try { await db.collection('reservations').doc(id).delete(); } catch (e) { alert("Gagal menghapus: " + e.message); }
        }
    }
    
    function findReservationById(id) {
      for (const key in dataReservasi) {
          const found = dataReservasi[key].find(r => r.id === id); if (found) return found;
      } return null;
    }

    function editReservasi(id) {
        const res = findReservationById(id); if (!res) return;
        const form = document.getElementById('editFormPopup');
        form.editReservationId.value = id;
        form.editNama.value = res.nama; form.editNomorHp.value = res.nomorHp; form.editJam.value = res.jam;
        form.editJumlah.value = res.jumlah; form.editDp.value = res.dp; form.editMenu.value = res.menu;
        form.editTempat.value = res.tempat; form.editTambahan.value = res.tambahan;
        form.style.display = 'block'; document.getElementById('overlay').style.display = 'block';
    }

    async function simpanPerubahanReservasi() {
        const form = document.getElementById('editFormPopup');
        const id = form.editReservationId.value;
        const updatedData = {
            nama: form.editNama.value, nomorHp: form.editNomorHp.value, jam: form.editJam.value,
            jumlah: parseInt(form.editJumlah.value), dp: parseInt(form.editDp.value) || 0,
            menu: form.editMenu.value, tempat: form.editTempat.value, tambahan: form.editTambahan.value,
            menuDetails: detailMenu[form.editMenu.value] || []
        };
        try {
            await db.collection('reservations').doc(id).update(updatedData);
            tutupEditForm();
        } catch (e) { alert("Gagal menyimpan: " + e.message); }
    }
    
    function tutupEditForm() { document.getElementById('editFormPopup').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    
    // Stubs for other functions for brevity
    function previousMonth() { currentMonth--; if(currentMonth < 0){currentMonth=11; currentYear--;} loadReservationsForCurrentMonth(); }
    function nextMonth() { currentMonth++; if(currentMonth > 11){currentMonth=0; currentYear++;} loadReservationsForCurrentMonth(); }
    function showMenuManagement() { alert('Fungsi Kelola Menu belum diimplementasikan di kode ringkas ini.'); }
    function printData() { window.print(); }
    // Add other function stubs if needed...
    function showCustomerMenu(){} function sortReservations(sortBy){} function shareViaEmail(){} function shareViaWhatsApp(scope){}
    function toggleSortOptions(e){e.stopPropagation();} function toggleWhatsAppOptions(e){e.stopPropagation();}
  </script>
</body>
</html>
