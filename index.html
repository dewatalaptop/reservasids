<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Reservasi Dolan Sawah (Firebase)</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f; --primary-dark: #264653; --secondary: #e9c46a; --accent: #f4a261; --danger: #e76f51; --light: #f8f9fa; --dark: #343a40; --success: #28a745; --whatsapp: #25D366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif; margin: 0; background-color: #f5f5f5; color: var(--dark);
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
      background-size: cover; background-attachment: fixed; background-position: center; min-height: 100vh;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.85); z-index: -1;
    }
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 25px 20px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
    }
    header::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
      background: linear-gradient(90deg, var(--secondary), var(--accent));
    }
    header h2 { font-size: 2.2rem; margin-bottom: 5px; font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); }
    header small { display: block; font-size: 0.8rem; margin-top: 5px; color: rgba(255, 255, 255, 0.8); font-weight: 300; }
    .container {
      max-width: 1200px; margin: 30px auto; padding: 20px; background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: none;
    }
    #login-container {
      max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; border-top: 5px solid var(--primary);
    }
    #login-error { color: var(--danger); margin-top: 15px; font-weight: 500; display: none; }
    #logout-button {
        position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--danger);
        color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none;
    }
    .calendar-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .month-year { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); text-align: center; margin-bottom: 10px; }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-nav button { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; margin-bottom: 10px; color: var(--primary-dark); }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { min-height: 80px; padding: 8px; background-color: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); position: relative; border: 1px solid #eee; transition: all 0.3s; }
    .day-number { font-weight: 600; text-align: right; }
    .has-reservation { background-color: rgba(42, 157, 143, 0.1); border-left: 3px solid var(--primary); }
    .selected { background-color: var(--primary); color: white; }
    .selected .day-number { color: white; }
    .reservation-count { position: absolute; top: 5px; left: 5px; background-color: var(--success); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
    .selected .reservation-count { background-color: white; color: var(--primary); }
    .form-popup, .summary, .edit-form-popup, .menu-management-popup { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-top: 4px solid var(--primary); }
    button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-family: 'Poppins', sans-serif; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    button:hover { background-color: var(--primary-dark); }
    button.secondary { background-color: var(--secondary); color: var(--dark); }
    button.danger { background-color: var(--danger); }
    button.whatsapp { background-color: var(--whatsapp); }
    button.accent { background-color: var(--accent); color: white; }
    footer { text-align: center; font-size: 0.8rem; color: white; background-color: var(--primary-dark); padding: 15px; margin-top: 40px; }
    .menu-detail { margin-top: 8px; font-size: 0.85rem; color: #555; background-color: rgba(233, 196, 106, 0.1); padding: 8px; border-radius: 5px; border-left: 3px solid var(--secondary); }
    label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary-dark); }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; font-family: 'Poppins', sans-serif; }
    textarea { min-height: 80px; }
    .reservation-item { padding: 15px; margin-bottom: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border-left: 4px solid var(--primary); }
    .reservation-details { flex-grow: 1; width: 100%; }
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .action-buttons button { flex: 1 1 auto; min-width: 0; }
    .data-transfer { margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; display: none; }
    .whatsapp-options-container, .sort-options-container { position: relative; display: inline-block; width: 100%; }
    .whatsapp-options, .sort-options { position: absolute; bottom: 100%; left: 0; width: 100%; margin-bottom: 5px; padding: 15px; border-radius: 8px; z-index: 10; display: none; background-color: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .data-actions { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; width: 100%; }
    .data-actions button { flex-grow: 1; padding: 8px 10px; font-size: 0.85rem; margin-top: 0; }
    .edit-form-popup, .menu-management-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 999; display: none; }
    .search-container { position: relative; margin: 0 auto 20px; max-width: 600px; width: 100%; }
    .search-container input { padding-left: 35px; border-radius: 30px; border: 2px solid var(--primary); }
    .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); }
    #menu-list-container { max-height: 300px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; }
    .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    .menu-item-actions button { padding: 5px 10px; font-size: 0.8rem; margin-top: 0; margin-left: 5px; }
    #add-menu-form { margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--primary); }
    
    /* New Styles */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background-color: rgba(0,0,0,0.5); z-index: 2000; 
      display: flex; justify-content: center; align-items: center;
      display: none;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background-color: var(--dark); color: white; padding: 12px 24px;
      border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1001; display: none;
    }
    .toast.error { background-color: var(--danger); }
    .toast.success { background-color: var(--success); }
    .invalid { border-color: var(--danger) !important; }
    .error-message { color: var(--danger); font-size: 0.8rem; margin-top: 3px; }
    
    @media (max-width: 480px) { 
      .action-buttons, .data-actions { flex-direction: column; } 
      .action-buttons button, .data-actions button { width: 100%; } 
    }
  </style>
</head>
<body>
  <header>
    <h2><i class="fas fa-leaf"></i> Sistem Reservasi Dolan Sawah</h2>
    <small>Version 3.1 (Anti-Cache)</small>
  </header>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <div id="login-container">
    <h3><i class="fas fa-lock"></i> Login Admin</h3>
    <label>Email: <input type="email" id="loginEmail" placeholder="Masukkan email admin"/></label>
    <label>Password: <input type="password" id="loginPassword" placeholder="Masukkan password"/></label>
    <button onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
    <p id="login-error">Email atau password salah.</p>
  </div>
  
  <button id="logout-button" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  
  <div class="container" id="main-container">
    <div class="calendar-header">
      <div class="month-year" id="monthYear"></div>
      <div class="calendar-nav">
        <button onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
        <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
    
    <div class="calendar-weekdays">
      <div>Min</div> <div>Sen</div> <div>Sel</div> <div>Rab</div> <div>Kam</div> <div>Jum</div> <div>Sab</div>
    </div>
    
    <div class="calendar-days" id="calendar"></div>
    
    <div id="summary" class="summary" style="display:none;">
      <h3><i class="far fa-calendar-alt"></i> Reservasi</h3>
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" oninput="filterReservations(this.value)" placeholder="Cari di tanggal yang dipilih...">
      </div>
      <div id="reservation-list-container"></div>
    </div>
    
    <div id="formPopup" class="form-popup" style="display:none;">
      <h3><i class="fas fa-calendar-plus"></i> Input Reservasi</h3>
      <form id="reservation-form">
        <label>Nama: <input type="text" id="nama" required />
          <span class="error-message" id="nama-error"></span>
        </label>
        <label>Nomor HP: <input type="tel" id="nomorHp" pattern="[0-9]{10,13}" />
          <span class="error-message" id="nomorHp-error"></span>
        </label>
        <label>Jam Reservasi: <input type="time" id="jam" required />
          <span class="error-message" id="jam-error"></span>
        </label>
        <label>Jumlah Peserta: <input type="number" id="jumlah" min="1" required />
          <span class="error-message" id="jumlah-error"></span>
        </label>
        <label>DP (Rupiah): <input type="number" id="dp" value="0" min="0" /></label>
        <label>Menu: <select id="menu" required>
          <span class="error-message" id="menu-error"></span>
        </select></label>
        <label>Tempat: <select id="tempat" required>
          <option value="">Pilih Tempat</option>
          <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
          <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
        </select></label>
        <label>Request Tambahan: <textarea id="tambahan"></textarea></label>
        <button type="button" onclick="simpanReservasi()"> Simpan Reservasi</button>
      </form>
    </div>
    
    <div class="action-buttons">
      <button onclick="showCustomerMenu()"><i class="fas fa-address-book"></i> Customer</button>
      <button onclick="showMenuManagement()"><i class="fas fa-book-open"></i> Kelola Menu</button>
      <button onclick="printData()"><i class="fas fa-print"></i> Print</button>
      <div class="sort-options-container">
        <button class="secondary" onclick="toggleSortOptions(event)"><i class="fas fa-sort"></i> Urutkan</button>
        <div class="sort-options" id="sortOptions">
          <p>Urutkan berdasarkan:</p>
          <button onclick="sortReservations('jam')">Jam</button>
          <button onclick="sortReservations('tempat')">Tempat</button>
        </div>
      </div>
      <button class="secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Email</button>
      <div class="whatsapp-options-container">
        <button class="whatsapp" onclick="toggleWhatsAppOptions(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>
        <div class="whatsapp-options" id="whatsappOptions">
          <p>Pilih opsi:</p>
          <button class="whatsapp" onclick="shareViaWhatsApp('day')">1 Hari</button>
          <button class="whatsapp" onclick="shareViaWhatsApp('month')">1 Bulan</button>
        </div>
      </div>
      <button class="accent" onclick="forceSync()"><i class="fas fa-sync-alt"></i> Sinkronisasi</button>
      <button onclick="showExportData()"><i class="fas fa-file-export"></i> Export</button>
    </div>
    
    <div class="data-transfer" id="dataTransfer">
      <h3><i class="fas fa-file-code"></i> Kode Ekspor Bulan <span id="exportMonthName"></span></h3>
      <textarea id="dataTransferCode" readonly></textarea>
      <button onclick="copyExportCode()"><i class="fas fa-copy"></i> Salin</button>
      <button class="danger" onclick="hideDataTransfer()">Tutup</button>
    </div>
  </div>
  
  <div id="editFormPopup" class="edit-form-popup"></div>
  <div id="menuManagementPopup" class="menu-management-popup"></div>
  <div id="customerListPopup" class="edit-form-popup"></div>
  <div class="overlay" id="overlay"></div>
  
  <footer><p><i class="fas fa-code"></i> Dibuat oleh Ryan</p></footer>

<script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // Enable offline persistence
    db.enablePersistence().catch(err => {
      console.warn("Firebase persistence error: ", err.code);
      showToast("Mode offline tidak tersedia", "error");
    });

    // Constants and Variables
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let dataReservasi = {};
    let detailMenu = {};
    let tanggalDipilih = '';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let unsubscribeReservations = null;
    
    // DOM Elements
    const mainContainer = document.getElementById('main-container');
    const loginContainer = document.getElementById('login-container');
    const logoutButton = document.getElementById('logout-button');
    const monthYearEl = document.getElementById('monthYear');
    const calendarEl = document.getElementById('calendar');
    const summaryEl = document.getElementById('summary');
    const overlay = document.getElementById('overlay');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const toast = document.getElementById('toast');

    // Authentication State Listener
    auth.onAuthStateChanged(user => {
        if (user) {
            loginContainer.style.display = 'none'; 
            mainContainer.style.display = 'block';
            logoutButton.style.display = 'inline-flex'; 
            initializeApp();
        } else {
            loginContainer.style.display = 'block'; 
            mainContainer.style.display = 'none';
            logoutButton.style.display = 'none';
        }
    });

    // Utility Functions
    function showLoader() {
      loadingOverlay.style.display = 'flex';
      return {
        hide: () => loadingOverlay.style.display = 'none'
      };
    }
    
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
    
    function formatRupiah(amount) { 
      return (amount || 0).toLocaleString('id-ID'); 
    }
    
    function isValidPhone(phone) {
      return /^[0-9]{10,13}$/.test(phone);
    }
    
    function validateForm() {
      let isValid = true;
      const form = document.getElementById('reservation-form');
      
      // Reset errors
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
      document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
      
      // Validate nama
      if (!form.nama.value.trim()) {
        document.getElementById('nama-error').textContent = 'Nama wajib diisi';
        form.nama.classList.add('invalid');
        isValid = false;
      }
      
      // Validate nomor HP if provided
      if (form.nomorHp.value && !isValidPhone(form.nomorHp.value)) {
        document.getElementById('nomorHp-error').textContent = 'Nomor HP harus 10-13 digit angka';
        form.nomorHp.classList.add('invalid');
        isValid = false;
      }
      
      // Validate jam
      if (!form.jam.value) {
        document.getElementById('jam-error').textContent = 'Jam wajib diisi';
        form.jam.classList.add('invalid');
        isValid = false;
      }
      
      // Validate jumlah
      if (!form.jumlah.value || parseInt(form.jumlah.value) < 1) {
        document.getElementById('jumlah-error').textContent = 'Jumlah minimal 1';
        form.jumlah.classList.add('invalid');
        isValid = false;
      }
      
      // Validate menu
      if (!form.menu.value) {
        document.getElementById('menu-error').textContent = 'Menu wajib dipilih';
        form.menu.classList.add('invalid');
        isValid = false;
      }
      
      // Validate tempat
      if (!form.tempat.value) {
        document.getElementById('tempat-error').textContent = 'Tempat wajib dipilih';
        form.tempat.classList.add('invalid');
        isValid = false;
      }
      
      return isValid;
    }

    // Authentication Functions
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        document.getElementById('login-error').textContent = 'Email dan password wajib diisi';
        document.getElementById('login-error').style.display = 'block';
        return;
      }
      
      const loader = showLoader();
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        document.getElementById('login-error').textContent = 'Email atau password salah';
        document.getElementById('login-error').style.display = 'block';
      } finally {
        loader.hide();
      }
    }
    
    function handleLogout() { 
      if (confirm("Yakin ingin logout?")) auth.signOut(); 
    }

    // Core Application Functions
    function initializeApp() { 
      loadMenus(); 
      loadReservationsForCurrentMonth(); 
    }
    
    async function loadMenus() {
      try {
        const snapshot = await db.collection('menus').get();
        detailMenu = {};
        snapshot.forEach(doc => detailMenu[doc.id] = doc.data().details);
        populateMenuDropdowns(document.getElementById('menu'));
      } catch (e) { 
        console.error("Gagal memuat menu:", e); 
        showToast("Gagal memuat daftar menu", "error");
      }
    }
    
    function loadReservationsForCurrentMonth() {
      if (unsubscribeReservations) unsubscribeReservations();
      
      const monthStr = String(currentMonth + 1).padStart(2, '0');
      const startDate = `${currentYear}-${monthStr}-01`;
      const endDate = `${currentYear}-${monthStr}-${new Date(currentYear, currentMonth + 1, 0).getDate()}`;
      
      const loader = showLoader();
      unsubscribeReservations = db.collection('reservations')
        .where('date', '>=', startDate)
        .where('date', '<=', endDate)
        .onSnapshot(
          snapshot => {
            dataReservasi = {};
            snapshot.forEach(doc => {
              const r = { id: doc.id, ...doc.data() };
              const dateKey = r.date.substring(5);
              if (!dataReservasi[dateKey]) dataReservasi[dateKey] = [];
              dataReservasi[dateKey].push(r);
            });
            buatKalender();
            if (tanggalDipilih) pilihTanggal(parseInt(tanggalDipilih.split('-')[1]), false);
            loader.hide();
          }, 
          err => {
            console.error("Error listener: ", err);
            showToast("Gagal memuat data reservasi", "error");
            loader.hide();
          }
        );
    }
    
    function buatKalender() {
      calendarEl.innerHTML = ''; 
      monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      // Empty days for previous month
      for (let i = 0; i < firstDay; i++) {
        calendarEl.insertAdjacentHTML('beforeend', `<div class="calendar-day empty-day"></div>`);
      }
      
      // Current month days
      for (let i = 1; i <= daysInMonth; i++) {
        const dateKey = `${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const isToday = new Date().toDateString() === new Date(currentYear, currentMonth, i).toDateString() ? 'today' : '';
        const isSelected = dateKey === tanggalDipilih ? 'selected' : '';
        const hasRes = dataReservasi[dateKey] && dataReservasi[dateKey].length > 0;
        const countHTML = hasRes ? `<div class="reservation-count">${dataReservasi[dateKey].length}</div>` : '';
        
        const dayHTML = `
          <div class="calendar-day ${isToday} ${isSelected} ${hasRes ? 'has-reservation' : ''}" 
               onclick="pilihTanggal(${i})">
            <div class="day-number">${i}</div>
            ${countHTML}
          </div>`;
          
        calendarEl.insertAdjacentHTML('beforeend', dayHTML);
      }
    }
    
    function pilihTanggal(day, shouldScroll = true) {
      tanggalDipilih = `${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      buatKalender();
      updateReservationList(dataReservasi[tanggalDipilih] || []);
      
      summaryEl.querySelector('h3').innerHTML = `
        <i class="far fa-calendar-alt"></i> Reservasi ${day} ${monthNames[currentMonth]}
      `;
      
      summaryEl.style.display = 'block'; 
      document.getElementById('formPopup').style.display = 'block';
      
      if (shouldScroll) summaryEl.scrollIntoView({ behavior: 'smooth' });
    }
    
    function updateReservationList(reservations) {
      const container = document.getElementById('reservation-list-container');
      
      if (!reservations || reservations.length === 0) {
        container.innerHTML = `<p style="text-align:center;padding:20px 0;">Belum ada reservasi.</p>`;
        return;
      }
      
      container.innerHTML = reservations.map(r => {
        const menuItems = detailMenu[r.menu] || r.menuDetails || [];
        const isiMenu = menuItems.length ? menuItems.map(item => `â€¢ ${item}`).join('<br/>') : "-";
        const dpInfo = r.dp ? `<div><i class="fas fa-money-bill-wave"></i> DP: Rp${formatRupiah(r.dp)}</div>` : '';
        const phoneInfo = r.nomorHp ? `<div><i class="fas fa-phone"></i> ${r.nomorHp}</div>` : '';
        
        return `
          <div class="reservation-item">
            <div class="reservation-details">
              <b><i class="fas fa-user"></i> ${r.nama}</b><br/>
              <span>
                <i class="fas fa-map-marker-alt"></i> ${r.tempat} â€¢ 
                <i class="far fa-clock"></i> ${r.jam} â€¢ 
                <i class="fas fa-users"></i> ${r.jumlah} org
              </span>
              ${dpInfo}
              ${phoneInfo}
              <div class="menu-detail">
                <b><i class="fas fa-utensils"></i> ${r.menu}:</b><br />${isiMenu}
              </div>
              <div>
                <i class="fas fa-comment"></i> <b>Tambahan:</b> ${r.tambahan || '-'}
              </div>
            </div>
            <div class="data-actions">
              ${r.nomorHp ? `
                <button class="whatsapp" onclick="contactViaWhatsApp('${r.id}')">
                  <i class="fab fa-whatsapp"></i> Hubungi
                </button>` : ''}
              <button onclick="editReservasi('${r.id}')">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="danger" onclick="hapusReservasi('${r.id}')">
                <i class="fas fa-trash-alt"></i> Hapus
              </button>
            </div>
          </div>`;
      }).join('');
    }
    
    function filterReservations(query) {
      if (!tanggalDipilih) return;
      const q = query.toLowerCase();
      const filtered = (dataReservasi[tanggalDipilih] || []).filter(r => 
        r.nama.toLowerCase().includes(q) || 
        r.tempat.toLowerCase().includes(q) || 
        r.menu.toLowerCase().includes(q)
      );
      updateReservationList(filtered);
    }
    
    // Reservation CRUD Operations
    async function simpanReservasi() {
      if (!validateForm()) return;
      
      const form = document.getElementById('reservation-form');
      const data = {
        nama: form.nama.value,
        nomorHp: form.nomorHp.value,
        jam: form.jam.value,
        jumlah: parseInt(form.jumlah.value),
        dp: parseInt(form.dp.value) || 0,
        menu: form.menu.value,
        tempat: form.tempat.value,
        tambahan: form.tambahan.value,
        date: `${currentYear}-${tanggalDipilih}`,
        menuDetails: detailMenu[form.menu.value] || [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const loader = showLoader();
      try {
        await db.collection('reservations').add(data);
        showToast("Reservasi berhasil disimpan!");
        form.reset();
      } catch (e) {
        console.error("Gagal menyimpan reservasi:", e);
        showToast("Gagal menyimpan reservasi", "error");
      } finally {
        loader.hide();
      }
    }
    
    async function hapusReservasi(id) {
      if (!confirm("Yakin ingin menghapus reservasi ini?")) return;
      
      const loader = showLoader();
      try {
        await db.collection('reservations').doc(id).delete();
        showToast("Reservasi berhasil dihapus");
      } catch (e) {
        console.error("Gagal menghapus reservasi:", e);
        showToast("Gagal menghapus reservasi", "error");
      } finally {
        loader.hide();
      }
    }
    
    function editReservasi(id) {
      const res = findReservationById(id); 
      if (!res) {
        showToast("Reservasi tidak ditemukan", "error");
        return;
      }
      
      const form = document.getElementById('editFormPopup');
      form.innerHTML = `
        <h3><i class="fas fa-edit"></i> Edit Reservasi</h3>
        <input type="hidden" id="editReservationId" value="${id}" />
        
        <label>Nama: <input type="text" id="editNama" value="${res.nama}" required /></label>
        
        <label>Nomor HP: <input type="tel" id="editNomorHp" value="${res.nomorHp || ''}" 
               pattern="[0-9]{10,13}" /></label>
        
        <label>Jam: <input type="time" id="editJam" value="${res.jam}" required /></label>
        
        <label>Jumlah: <input type="number" id="editJumlah" value="${res.jumlah}" 
               min="1" required /></label>
        
        <label>DP: <input type="number" id="editDp" value="${res.dp || 0}" min="0" /></label>
        
        <label>Menu: <select id="editMenu" required></select></label>
        
        <label>Tempat: <select id="editTempat" required>
          <option value="">Pilih Tempat</option>
          <option>Lantai 1</option><option>Lantai 2</option><option>Lantai 3</option>
          <option>Gubug 1</option><option>Gubug 2</option><option>Gubug 3</option>
        </select></label>
        
        <label>Tambahan: <textarea id="editTambahan">${res.tambahan || ''}</textarea></label>
        
        <div class="data-actions">
          <button onclick="simpanPerubahanReservasi()">
            <i class="fas fa-save"></i> Simpan
          </button>
          <button class="danger" onclick="tutupEditForm()">Batal</button>
        </div>`;
      
      populateMenuDropdowns(form.querySelector('#editMenu'), res.menu);
      form.querySelector('#editTempat').value = res.tempat;
      form.style.display = 'block'; 
      overlay.style.display = 'block';
    }
    
    async function simpanPerubahanReservasi() {
      const form = document.getElementById('editFormPopup');
      const id = form.querySelector('#editReservationId').value;
      const menu = form.querySelector('#editMenu').value;
      
      const data = {
        nama: form.querySelector('#editNama').value,
        nomorHp: form.querySelector('#editNomorHp').value,
        jam: form.querySelector('#editJam').value,
        jumlah: parseInt(form.querySelector('#editJumlah').value),
        dp: parseInt(form.querySelector('#editDp').value) || 0,
        menu: menu,
        tempat: form.querySelector('#editTempat').value,
        tambahan: form.querySelector('#editTambahan').value,
        menuDetails: detailMenu[menu] || []
      };
      
      const loader = showLoader();
      try {
        await db.collection('reservations').doc(id).update(data);
        showToast("Perubahan berhasil disimpan");
        tutupEditForm();
      } catch (e) {
        console.error("Gagal menyimpan perubahan:", e);
        showToast("Gagal menyimpan perubahan", "error");
      } finally {
        loader.hide();
      }
    }
    
    function tutupEditForm() { 
      document.getElementById('editFormPopup').style.display = 'none'; 
      overlay.style.display = 'none'; 
    }
    
    // Menu Management
    function showMenuManagement() {
      const popup = document.getElementById('menuManagementPopup');
      popup.innerHTML = `
        <h3><i class="fas fa-book-open"></i> Kelola Menu</h3>
        <div id="menu-list-container"></div>
        
        <div id="add-menu-form">
          <h4><i class="fas fa-plus-circle"></i> Tambah Menu</h4>
          <label>Nama Menu: <input type="text" id="newMenuName" placeholder="Contoh: Paket Spesial"></label>
          <label>Detail Menu (pisahkan koma): 
            <textarea id="newMenuDetails" placeholder="Nasi, Ayam Bakar"></textarea>
          </label>
          <button onclick="addNewMenu()">Tambah Menu</button>
        </div>
        
        <div class="data-actions">
          <button class="danger" onclick="closeMenuManagement()">Tutup</button>
        </div>`;
      
      renderMenuList();
      popup.style.display = 'block'; 
      overlay.style.display = 'block';
    }
    
    function renderMenuList() {
      const container = document.getElementById('menu-list-container'); 
      if (!container) return;
      
      container.innerHTML = Object.keys(detailMenu).sort().map(name => `
        <div class="menu-item">
          <span class="menu-item-name">${name}</span>
          <div class="menu-item-actions">
            <button onclick="openEditMenuPopup('${name}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="danger" onclick="deleteMenu('${name}')" title="Hapus">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </div>`
      ).join('');
    }
    
    async function addNewMenu() {
      const name = document.getElementById('newMenuName').value.trim();
      const details = document.getElementById('newMenuDetails').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
      
      if (!name) {
        showToast("Nama menu tidak boleh kosong", "error");
        return;
      }
      
      if (detailMenu[name]) {
        showToast("Menu sudah ada", "error");
        return;
      }
      
      const loader = showLoader();
      try {
        await db.collection('menus').doc(name).set({ details });
        showToast(`Menu "${name}" berhasil ditambahkan`);
        await loadMenus(); 
        renderMenuList();
        document.getElementById('newMenuName').value = '';
        document.getElementById('newMenuDetails').value = '';
      } catch (e) {
        console.error("Gagal menambah menu:", e);
        showToast("Gagal menambah menu", "error");
      } finally {
        loader.hide();
      }
    }
    
    async function deleteMenu(name) {
      if (!confirm(`Yakin ingin menghapus menu "${name}"?`)) return;
      
      const loader = showLoader();
      try {
        await db.collection('menus').doc(name).delete();
        showToast(`Menu "${name}" berhasil dihapus`);
        await loadMenus(); 
        renderMenuList();
      } catch (e) {
        console.error("Gagal menghapus menu:", e);
        showToast("Gagal menghapus menu", "error");
      } finally {
        loader.hide();
      }
    }
    
    function openEditMenuPopup(name) {
      const popup = document.getElementById('menuManagementPopup');
      popup.innerHTML = `
        <h3><i class="fas fa-edit"></i> Edit Menu</h3>
        <label>Nama Menu: <input type="text" id="editingMenuName" value="${name}"></label>
        <label>Detail (pisahkan koma): 
          <textarea id="editingMenuDetails">${detailMenu[name].join(', ')}</textarea>
        </label>
        <div class="data-actions">
          <button onclick="saveEditedMenu('${name}')">
            <i class="fas fa-save"></i> Simpan
          </button>
          <button class="danger" onclick="showMenuManagement()">Batal</button>
        </div>`;
    }
    
    async function saveEditedMenu(originalName) {
      const newName = document.getElementById('editingMenuName').value.trim();
      const newDetails = document.getElementById('editingMenuDetails').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
      
      if (!newName) {
        showToast("Nama menu tidak boleh kosong", "error");
        return;
      }
      
      const loader = showLoader();
      try {
        if (originalName !== newName) {
          if (detailMenu[newName]) {
            showToast("Nama menu sudah digunakan", "error");
            return;
          }
          await db.collection('menus').doc(originalName).delete();
        }
        
        await db.collection('menus').doc(newName).set({ details: newDetails });
        showToast(`Menu "${newName}" berhasil diperbarui`);
        await loadMenus(); 
        showMenuManagement();
      } catch(e) {
        console.error("Gagal menyimpan menu:", e);
        showToast("Gagal menyimpan perubahan menu", "error");
      } finally {
        loader.hide();
      }
    }
    
    function closeMenuManagement() { 
      document.getElementById('menuManagementPopup').style.display = 'none'; 
      overlay.style.display = 'none'; 
    }
    
    // Utility Functions
    function findReservationById(id) {
      for (const key in dataReservasi) {
        const found = dataReservasi[key].find(r => r.id === id);
        if (found) return found;
      }
      return null;
    }
    
    function populateMenuDropdowns(selectElement, selectedValue = '') {
      if (!selectElement) return;
      
      const sortedMenuNames = Object.keys(detailMenu).sort();
      selectElement.innerHTML = '';
      
      if (sortedMenuNames.length === 0) {
        selectElement.add(new Option('Tidak Ada Pilihan', ''));
      } else {
        sortedMenuNames.forEach(name => 
          selectElement.add(new Option(name, name))
        );
      }
      
      if (selectedValue) selectElement.value = selectedValue;
    }
    
    // Customer List Functions
    async function showCustomerMenu() {
      const loader = showLoader();
      try {
        // Ambil semua reservasi, diurutkan dari yang terbaru
        const snapshot = await db.collection('reservations').orderBy('createdAt', 'desc').get();
        const customers = new Map(); // Gunakan Map agar setiap customer unik berdasarkan nomor HP

        snapshot.forEach(doc => {
          const data = doc.data();
          // Hanya tambahkan customer yang punya nomor HP dan belum ada di daftar
          if (data.nomorHp && !customers.has(data.nomorHp)) {
            customers.set(data.nomorHp, data.nama);
          }
        });

        const popup = document.getElementById('customerListPopup');
        if (customers.size === 0) {
          popup.innerHTML = `
            <h3><i class="fas fa-address-book"></i> Daftar Customer</h3>
            <p style="text-align:center; padding: 20px 0;">Belum ada data customer dengan nomor HP.</p>
            <div class="data-actions">
                <button class="danger" onclick="closeCustomerMenu()">Tutup</button>
            </div>`;
        } else {
          // Urutkan daftar customer berdasarkan nama (abjad)
          const sortedCustomers = [...customers.entries()].sort((a, b) => a[1].localeCompare(b[1]));

          let customerListHTML = sortedCustomers.map(([phone, name]) => `
            <div class="menu-item">
              <span class="menu-item-name"><i class="fas fa-user"></i> ${name} <br/><small style="color:#777;">${phone}</small></span>
              <div class="menu-item-actions">
                <button class="whatsapp" onclick="openWhatsApp('${phone}', '${name}')" title="Hubungi via WhatsApp">
                    <i class="fab fa-whatsapp"></i> Hubungi
                </button>
              </div>
            </div>`
          ).join('');

          popup.innerHTML = `
            <h3><i class="fas fa-address-book"></i> Daftar Customer (${customers.size})</h3>
            <div id="menu-list-container" style="max-height: 50vh;">
                ${customerListHTML}
            </div>
            <div class="data-actions" style="margin-top:20px;">
                <button class="danger" onclick="closeCustomerMenu()">Tutup</button>
            </div>`;
        }

        popup.style.display = 'block';
        overlay.style.display = 'block';

      } catch (e) {
        console.error("Gagal memuat data customer:", e);
        showToast("Gagal memuat data customer", "error");
      } finally {
        loader.hide();
      }
    }

    function closeCustomerMenu() {
      document.getElementById('customerListPopup').style.display = 'none';
      overlay.style.display = 'none';
    }

    function openWhatsApp(phone, name) {
        if (!phone) {
            showToast("Nomor HP tidak tersedia", "error");
            return;
        }
        const formattedPhone = phone.replace(/^0/, '62');
        const message = `Halo Kak *${name}*, kami dari Dolan Sawah ingin menyapa. Terima kasih telah menjadi pelanggan kami! ðŸ˜Š`;
        window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    // WhatsApp Integration
    function contactViaWhatsApp(id) {
      const res = findReservationById(id);
      if (!res || !res.nomorHp) {
        showToast("Nomor HP tidak tersedia", "error");
        return;
      }
      
      const menuItems = res.menuDetails || detailMenu[res.menu] || [];
      const menuList = menuItems.length 
        ? menuItems.map(item => `  â€¢ ${item}`).join('\n') 
        : '  - _Detail tidak tersedia_ -';
        
      const dpInfo = res.dp ? `ðŸ’° *DP:* Rp ${formatRupiah(res.dp)} (Sudah kami terima, terima kasih ðŸ™)\n\n` : '';
    
      const message = `Halo Kak *${res.nama}* ðŸ‘‹,
    
Kami dari *Dolan Sawah* ingin mengkonfirmasi reservasi Anda:
    
ðŸ—“ï¸ *Tanggal:* ${res.date}
â° *Jam:* ${res.jam}
ðŸ“ *Tempat:* ${res.tempat}
ðŸ‘¥ *Jumlah:* ${res.jumlah} orang
    
ðŸ“ *Pesanan Menu: ${res.menu}*
${menuList}
    
${dpInfo}Mohon balas pesan ini untuk konfirmasi. Kami tunggu kedatangannya ya! ðŸ˜Š
    
Terima kasih,
*Tim Dolan Sawah*`;
          
      const phone = res.nomorHp.replace(/^0/, '62');
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    function shareViaWhatsApp(scope) {
      let message = '';
      
      if (scope === 'day' && tanggalDipilih) {
        const day = parseInt(tanggalDipilih.split('-')[1]);
        const reservations = dataReservasi[tanggalDipilih] ? [...dataReservasi[tanggalDipilih]].sort((a,b) => a.jam.localeCompare(b.jam)) : [];
        
        message = `*ðŸ“‹ LAPORAN RESERVASI DOLAN SAWAH ðŸ“‹*\n\n`;
        message += `*Tanggal:* ${day} ${monthNames[currentMonth]} ${currentYear}\n`;
        message += `=========================\n\n`;
        
        if (reservations.length === 0) {
          message += `_Tidak ada reservasi untuk tanggal ini._`;
        } else {
          reservations.forEach((res, index) => {
            message += `*${index + 1}. ${res.nama}*\n`;
            message += `â° Jam: *${res.jam}*\n`;
            message += `ðŸ“ Tempat: *${res.tempat}*\n`;
            message += `ðŸ‘¥ Jumlah: *${res.jumlah} orang*\n`;
            message += `ðŸ½ï¸ Menu: *${res.menu}*\n`;
            if (res.dp) {
              message += `ðŸ’° DP: *Rp ${formatRupiah(res.dp)}*\n`;
            }
            if (res.tambahan) {
              message += `ðŸ“ Tambahan: *${res.tambahan}*\n`;
            }
            message += `-------------------------\n\n`;
          });
        }
      } else if (scope === 'month') {
        message = `*ðŸ—“ï¸ REKAP RESERVASI BULANAN ðŸ—“ï¸*\n`;
        message += `*Dolan Sawah - ${monthNames[currentMonth]} ${currentYear}*\n`;
        message += `=========================\n\n`;
        
        const sortedDates = Object.keys(dataReservasi).sort((a, b) => a.localeCompare(b));
        let totalReservations = 0;
        
        if (sortedDates.length > 0) {
          sortedDates.forEach(dateKey => {
            const day = parseInt(dateKey.split('-')[1]);
            const reservations = dataReservasi[dateKey] ? [...dataReservasi[dateKey]].sort((a,b) => a.jam.localeCompare(b.jam)) : [];
            if (reservations.length > 0) {
              totalReservations += reservations.length;
              message += `*ðŸ“† Tanggal: ${day} ${monthNames[currentMonth]}*\n`;
              reservations.forEach(res => {
                message += `- ${res.jam} | *${res.nama}* | ${res.tempat} | ${res.jumlah} org\n`;
              });
              message += `-------------------------\n`;
            }
          });
        }
        
        if (totalReservations === 0) {
          message += `_Tidak ada reservasi untuk bulan ini._`;
        }
      } else {
        showToast("Pilih tanggal terlebih dahulu untuk laporan harian.", "error");
        return;
      }
      
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    // Email Integration
    function shareViaEmail() {
      if (!tanggalDipilih) {
        showToast("Pilih tanggal terlebih dahulu", "error");
        return;
      }
      
      const reservations = dataReservasi[tanggalDipilih] || [];
      if (reservations.length === 0) {
        showToast("Tidak ada reservasi untuk dikirim", "error");
        return;
      }
      
      const day = tanggalDipilih.split('-')[1];
      const subject = `Laporan Reservasi ${day} ${monthNames[currentMonth]} ${currentYear}`;
      
      let body = `Berikut daftar reservasi untuk tanggal ${day} ${monthNames[currentMonth]} ${currentYear}:\n\n`;
      
      reservations.forEach((res, index) => {
        body += `${index + 1}. ${res.nama}\n`;
        body += `   Jam: ${res.jam}\n`;
        body += `   Tempat: ${res.tempat}\n`;
        body += `   Jumlah: ${res.jumlah} orang\n`;
        body += `   Menu: ${res.menu}\n`;
        if (res.dp) body += `   DP: Rp${formatRupiah(res.dp)}\n`;
        if (res.tambahan) body += `   Catatan: ${res.tambahan}\n`;
        body += `\n`;
      });
      
      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    
    // Sorting Functions
    function sortReservations(sortBy) {
      if (!tanggalDipilih || !dataReservasi[tanggalDipilih]) return;
      
      const reservations = [...dataReservasi[tanggalDipilih]];
      
      switch(sortBy) {
        case 'jam':
          reservations.sort((a, b) => a.jam.localeCompare(b.jam));
          break;
        case 'tempat':
          reservations.sort((a, b) => a.tempat.localeCompare(b.tempat));
          break;
        default:
          break;
      }
      
      updateReservationList(reservations);
      document.getElementById('sortOptions').style.display = 'none';
      showToast(`Reservasi diurutkan berdasarkan ${sortBy}`);
    }
    
    // UI Helper Functions
    function toggleSortOptions(event) {
      event.stopPropagation();
      const sortOptions = document.getElementById('sortOptions');
      const whatsappOptions = document.getElementById('whatsappOptions');
      
      whatsappOptions.style.display = 'none';
      sortOptions.style.display = sortOptions.style.display === 'block' ? 'none' : 'block';
    }
    
    function toggleWhatsAppOptions(event) {
      event.stopPropagation();
      const sortOptions = document.getElementById('sortOptions');
      const whatsappOptions = document.getElementById('whatsappOptions');
      
      sortOptions.style.display = 'none';
      whatsappOptions.style.display = whatsappOptions.style.display === 'block' ? 'none' : 'block';
    }
    
    document.addEventListener('click', () => { 
      document.querySelectorAll('.sort-options, .whatsapp-options').forEach(el => {
        el.style.display = 'none';
      }); 
    });
    
    // Data Export/Import
    function showExportData() {
      const exportData = {
        month: currentMonth,
        year: currentYear,
        reservations: dataReservasi,
        menus: detailMenu
      };
      
      document.getElementById('dataTransferCode').value = JSON.stringify(exportData, null, 2);
      document.getElementById('exportMonthName').textContent = monthNames[currentMonth];
      document.getElementById('dataTransfer').style.display = 'block';
    }
    
    function copyExportCode() {
      const code = document.getElementById('dataTransferCode');
      code.select();
      document.execCommand('copy');
      showToast("Kode berhasil disalin!");
    }
    
    function hideDataTransfer() { 
      document.getElementById('dataTransfer').style.display = 'none'; 
    }
    
    // Navigation Functions
    function previousMonth() { 
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      resetCalendarView();
      loadReservationsForCurrentMonth();
    }
    
    function nextMonth() { 
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      resetCalendarView();
      loadReservationsForCurrentMonth();
    }
    
    function resetCalendarView() {
      tanggalDipilih = '';
      summaryEl.style.display = 'none';
      document.getElementById('formPopup').style.display = 'none';
    }
    
    function forceSync() {
      const loader = showLoader();
      db.enableNetwork()
        .then(() => {
          showToast("Sinkronisasi berhasil");
          loadReservationsForCurrentMonth();
        })
        .catch(() => showToast("Gagal sinkronisasi", "error"))
        .finally(() => loader.hide());
    }
    
    function printData() { 
      window.print(); 
    }
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Close popups when clicking outside
      overlay.addEventListener('click', () => {
        document.getElementById('editFormPopup').style.display = 'none';
        document.getElementById('menuManagementPopup').style.display = 'none';
        document.getElementById('customerListPopup').style.display = 'none';
        overlay.style.display = 'none';
      });
      
      // Form validation on blur
      document.getElementById('nomorHp')?.addEventListener('blur', function() {
        if (this.value && !isValidPhone(this.value)) {
          document.getElementById('nomorHp-error').textContent = 'Nomor HP harus 10-13 digit angka';
          this.classList.add('invalid');
        }
      });
    });
  </script>
</body>
</html>
